<!DOCTYPE html>
<html lang="it">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <!-- Meta tags esistenti -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta
      name="twitter:image:src"
      content="https://r.mobirisesite.com/1342903/assets/images/page8-meta.png"
    />
    <meta
      property="og:image"
      content="https://r.mobirisesite.com/1342903/assets/images/page8-meta.png"
    />
    <meta
      name="twitter:title"
      content="Emissione Polizza Vita caso morte in Svizzera"
    />
    <!-- Titolo più specifico -->
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, minimum-scale=1"
    />
    <link
      rel="shortcut icon"
      href="https://r.mobirisesite.com/1342903/assets/images/lifeinsure-1-172x172.png?v=1TZWWw"
      type="image/x-icon"
    />
    <meta
      name="description"
      content="Completa l'emissione della tua polizza vita caso morte in Svizzera."
    />
    <!-- Descrizione più specifica -->

    <title>Emissione Polizza Vita caso morte in Svizzera</title>
    <!-- Titolo più specifico -->

    <!-- Link CSS esistenti -->
    <link
      rel="stylesheet"
      href="https://r.mobirisesite.com/1342903/assets/Material-Design-Icons/css/material.css"
    />
    <link
      rel="stylesheet"
      href="https://r.mobirisesite.com/1342903/assets/icon54/style.css"
    />
    <link
      rel="stylesheet"
      href="https://r.mobirisesite.com/1342903/assets/bootstrap/css/bootstrap.min.css"
    />
    <link
      rel="stylesheet"
      href="https://r.mobirisesite.com/1342903/assets/bootstrap/css/bootstrap-grid.min.css"
    />
    <link
      rel="stylesheet"
      href="https://r.mobirisesite.com/1342903/assets/bootstrap/css/bootstrap-reboot.min.css"
    />
    <link
      rel="stylesheet"
      href="https://r.mobirisesite.com/1342903/assets/web/assets/gdpr-plugin/gdpr-styles.css"
    />
    <link
      rel="stylesheet"
      href="https://r.mobirisesite.com/1342903/assets/popup-overlay-plugin/style.css"
    />
    <link
      rel="stylesheet"
      href="https://r.mobirisesite.com/1342903/assets/dropdown/css/style.css"
    />
    <link
      rel="stylesheet"
      href="https://r.mobirisesite.com/1342903/assets/socicon/css/styles.css"
    />
    <link
      rel="stylesheet"
      href="https://r.mobirisesite.com/1342903/assets/theme/css/style.css"
    />
    <link
      rel="preload"
      href="https://fonts.googleapis.com/css?family=Space+Grotesk:300,400,500,600,700&display=swap"
      as="style"
      onload="this.onload=null;this.rel='stylesheet'"
    />
    <noscript
      ><link
        rel="stylesheet"
        href="https://fonts.googleapis.com/css?family=Space+Grotesk:300,400,500,600,700&display=swap"
    /></noscript>
    <link
      rel="preload"
      as="style"
      href="https://r.mobirisesite.com/1342903/assets/mobirise/css/mbr-additional.css?v=1TZWWw"
    />
    <link
      rel="stylesheet"
      href="https://r.mobirisesite.com/1342903/assets/mobirise/css/mbr-additional.css?v=1TZWWw"
      type="text/css"
    />

    <!-- Stili specifici per il modulo di emissione -->
    <style>
      /* Stili base per il contenitore e card (simili a Bootstrap ma isolati) */
      .lifensure-container {
        font-family: "Space Grotesk", sans-serif; /* Usa lo stesso font del tema */
        line-height: 1.6;
        color: #333;
      }
      .lifensure-card {
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        padding: 30px;
        margin: 30px auto;
        max-width: 800px;
        border: 1px solid #e9ecef;
      }
      .lifensure-card h2 {
        text-align: center;
        margin-bottom: 30px;
        color: #343a40;
        font-size: 1.8rem; /* Dimensione titolo */
        font-weight: 600;
      }
      .lifensure-step-title {
        border-bottom: 1px solid #dee2e6;
        padding-bottom: 12px;
        margin-bottom: 25px;
        font-weight: 600;
        font-size: 1.2rem;
        color: #495057;
      }
      /* Barra di avanzamento */
      .lifensure-progress-container {
        height: 10px;
        background-color: #e9ecef;
        border-radius: 5px;
        margin-bottom: 35px;
        overflow: hidden;
      }
      #lifensure-progress-bar {
        height: 100%;
        width: 0%;
        background-color: #0d6efd; /* Blu Bootstrap */
        transition: width 0.4s ease-in-out;
        border-radius: 5px;
      }
      /* Stili input e label */
      .lifensure-form-group {
        margin-bottom: 20px;
      }
      .lifensure-form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: #495057;
        font-size: 0.95rem;
      }
      .lifensure-form-group label .lifensure-required {
        color: #dc3545; /* Rosso Bootstrap */
        margin-left: 3px;
      }
      .lifensure-form-group input[type="text"],
      .lifensure-form-group input[type="email"],
      .lifensure-form-group select {
        width: 100%;
        padding: 12px 15px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        font-size: 1rem;
        box-sizing: border-box;
        transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
      }
      .lifensure-form-group input:focus,
      .lifensure-form-group select:focus {
        border-color: #86b7fe;
        outline: 0;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
      }
      .lifensure-form-group .lifensure-input-hint {
        color: #6c757d;
        font-size: 0.85rem;
        margin-top: 5px;
      }
      /* Stili per errori (usando classi Bootstrap-like) */
      .lifensure-form-group input.is-invalid,
      .lifensure-form-group select.is-invalid {
        border-color: #dc3545 !important;
      }
      .lifensure-form-group .invalid-feedback {
        color: #dc3545;
        font-size: 0.875em;
        margin-top: 0.25rem;
        display: none; /* Nascosto di default */
      }
      .was-validated
        .lifensure-checkbox-group
        .lifensure-checkbox-wrapper:has(input:invalid)
        + .invalid-feedback {
        /* <-- Новий рядок */
        display: block;
      }
      /* Stili Checkbox */
      .lifensure-checkbox-group {
        margin-bottom: 15px;
      }
      .lifensure-checkbox-group .lifensure-checkbox-wrapper {
        display: flex;
        align-items: flex-start; /* Allinea in alto per testi lunghi */
        margin-bottom: 5px;
      }
      .lifensure-checkbox-group input[type="checkbox"] {
        margin-right: 10px;
        margin-top: 4px; /* Allinea meglio con il testo */
        flex-shrink: 0; /* Impedisce al checkbox di restringersi */
        width: 1.1em;
        height: 1.1em;
      }
      .lifensure-checkbox-group label {
        font-size: 1rem;
        color: #333;
        line-height: 1.5;
      }
      .lifensure-checkbox-group label a {
        color: #0d6efd;
        text-decoration: underline;
        cursor: pointer;
      }
      .lifensure-checkbox-group .invalid-feedback {
        color: #dc3545;
        font-size: 0.875em;
        margin-left: 25px; /* Allinea con il testo della label */
        display: none;
      }
      .was-validated
        .lifensure-checkbox-group
        input:invalid
        ~ .invalid-feedback {
        display: block;
      }
      /* Bottoni */
      .lifensure-button {
        background-color: #0d6efd;
        color: white;
        border: none;
        padding: 12px 25px;
        border-radius: 4px;
        font-size: 1rem;
        cursor: pointer;
        transition: background-color 0.2s ease;
        display: inline-flex; /* Per allineare spinner e testo */
        align-items: center;
        justify-content: center;
      }
      .lifensure-button:hover {
        background-color: #0b5ed7;
      }
      .lifensure-button.secondary {
        background-color: #6c757d;
      }
      .lifensure-button.secondary:hover {
        background-color: #5c636a;
      }
      .lifensure-button.success {
        background-color: #198754;
      }
      .lifensure-button.success:hover {
        background-color: #157347;
      }
      .lifensure-button.outline {
        background-color: transparent;
        color: #0d6efd;
        border: 1px solid #0d6efd;
      }
      .lifensure-button.outline:hover {
        background-color: #0d6efd;
        color: white;
      }
      .lifensure-button:disabled {
        background-color: #adb5bd;
        cursor: not-allowed;
        opacity: 0.7;
      }
      .lifensure-button-spinner {
        display: inline-block;
        width: 1em; /* Dimensione relativa al font */
        height: 1em;
        border: 2px solid currentColor;
        border-radius: 50%;
        border-top-color: transparent;
        animation: lifensure-spin 0.75s linear infinite;
        margin-right: 8px;
      }
      @keyframes lifensure-spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      /* Riepilogo */
      .lifensure-summary-box {
        margin-bottom: 25px;
        background-color: #f8f9fa;
        padding: 20px;
        border-radius: 5px;
        border: 1px solid #dee2e6;
      }
      .lifensure-summary-box h6 {
        font-weight: 600;
        font-size: 1.1rem;
        margin-bottom: 15px;
        color: #495057;
      }
      .lifensure-summary-box p {
        margin-bottom: 8px;
        color: #343a40;
      }
      .lifensure-summary-box strong {
        color: #212529;
      }
      .lifensure-summary-highlight {
        background-color: #cfe2ff;
        color: #052c65;
        padding: 12px;
        border-radius: 4px;
        margin-top: 15px;
        font-weight: 500;
      }
      /* Pagamento Dettagli - REMOVED IN THIS VERSION */
      /* Step Completamento */
      .lifensure-completion-icon {
        width: 80px;
        height: 80px;
        margin: 0 auto 25px auto;
        border-radius: 50%;
        border: 4px solid #198754; /* Verde successo */
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .lifensure-completion-icon::after {
        content: "";
        display: block;
        width: 40%;
        height: 60%;
        border: solid #198754;
        border-width: 0 5px 5px 0;
        transform: rotate(45deg);
      }
      .lifensure-completion-message h3 {
        color: #198754;
        font-size: 1.6rem;
        margin-bottom: 10px;
        font-weight: 600;
      }
      .lifensure-completion-message p {
        font-size: 1.1rem;
        color: #495057;
      }
      .lifensure-policy-info {
        background-color: #d1e7dd; /* Verde chiaro successo */
        color: #0f5132;
        padding: 15px 20px;
        border-radius: 4px;
        margin-bottom: 25px;
        border: 1px solid #badbcc;
      }
      .lifensure-policy-info h5 {
        margin-bottom: 5px;
        font-weight: 600;
        font-size: 1.1rem;
      }
      .lifensure-documents-list {
        background-color: #f8f9fa;
        padding: 20px;
        border-radius: 4px;
        margin-bottom: 25px;
        border: 1px solid #dee2e6;
      }
      .lifensure-documents-list h6 {
        font-weight: 600;
        margin-bottom: 15px;
        font-size: 1.1rem;
      }
      .lifensure-document-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
        padding-bottom: 12px;
        border-bottom: 1px solid #eee;
      }
      .lifensure-document-item:last-child {
        margin-bottom: 0;
        padding-bottom: 0;
        border-bottom: none;
      }
      .lifensure-document-item span {
        color: #343a40;
      }
      .lifensure-document-item button,
      .lifensure-document-item a {
        /* Stile per bottone o link */
        background-color: #e9ecef;
        color: #0d6efd;
        border: 1px solid #ced4da;
        padding: 6px 12px;
        border-radius: 4px;
        font-size: 0.9rem;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        cursor: pointer;
        transition: background-color 0.2s ease, border-color 0.2s ease;
      }
      .lifensure-document-item button:hover,
      .lifensure-document-item a:hover {
        background-color: #dee2e6;
        border-color: #adb5bd;
      }
      /* Step Errore */
      .lifensure-error-icon {
        width: 80px;
        height: 80px;
        margin: 0 auto 25px auto;
        font-size: 60px;
        color: #dc3545; /* Rosso errore */
        display: flex;
        align-items: center;
        justify-content: center;
        border: 4px solid #dc3545;
        border-radius: 50%;
      }
      .lifensure-error-message h3 {
        color: #dc3545;
        font-size: 1.6rem;
        margin-bottom: 10px;
        font-weight: 600;
      }
      .lifensure-error-message p {
        font-size: 1.1rem;
        color: #495057;
      }
      /* Modal */
      #lifensure-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.6);
        z-index: 1050; /* Sopra la navbar di Mobirise? */
        opacity: 0;
        transition: opacity 0.3s ease;
      }
      #lifensure-overlay.visible {
        display: block;
        opacity: 1;
      }
      #lifensure-modal {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) scale(0.9);
        width: 90%;
        max-width: 650px;
        background-color: white;
        border-radius: 8px;
        padding: 25px 30px;
        max-height: 85vh;
        overflow-y: auto;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
        opacity: 0;
        transition: opacity 0.3s ease, transform 0.3s ease;
        z-index: 1051;
      }
      #lifensure-overlay.visible #lifensure-modal {
        opacity: 1;
        transform: translate(-50%, -50%) scale(1);
      }
      #lifensure-modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid #dee2e6;
      }
      #lifensure-modal-title {
        font-size: 1.3rem;
        margin: 0;
        font-weight: 600;
        color: #343a40;
      }
      #lifensure-modal-close {
        background: none;
        border: none;
        font-size: 2rem;
        cursor: pointer;
        line-height: 1;
        color: #6c757d;
        padding: 0 5px;
      }
      #lifensure-modal-close:hover {
        color: #343a40;
      }
      #lifensure-modal-content {
        margin-bottom: 25px;
        font-size: 1rem;
        line-height: 1.7;
      }
      #lifensure-modal-content h6 {
        font-weight: 600;
        margin-top: 15px;
        margin-bottom: 8px;
        font-size: 1.1rem;
      }
      #lifensure-modal-content ul {
        padding-left: 25px;
        margin-top: 10px;
      }
      #lifensure-modal-footer {
        text-align: right;
        padding-top: 15px;
        border-top: 1px solid #dee2e6;
      }
      /* Debug Area */
      #lifensure-debug {
        display: none; /* Nascosto di default */
        margin-top: 30px;
        padding: 15px;
        background-color: #fff3cd; /* Giallo warning */
        color: #664d03;
        border: 1px solid #ffecb5;
        border-radius: 4px;
        font-size: 0.9rem;
      }
      #lifensure-debug h5 {
        margin-top: 0;
        margin-bottom: 10px;
        font-weight: 600;
      }
      #lifensure-debug p {
        margin: 3px 0;
        word-break: break-all;
      }
    </style>
  </head>
  <body>
    <!-- Navbar esistente -->
    <section
      data-bs-version="5.1"
      class="inspirem5 menu menu1 cid-uHcV8yKzqs"
      once="menu"
      id="menu01-3s"
    >
      <nav class="navbar navbar-dropdown navbar-fixed-top navbar-expand-lg">
        <div class="container-fluid">
          <div class="navbar-brand">
            <span class="navbar-logo">
              <a href="index.html#top">
                <img
                  src="https://r.mobirisesite.com/1342903/assets/images/lifeinsure-1-172x172.png?v=1TZWWw"
                  alt="LifeInsure Logo"
                  style="height: 3.6rem"
                />
              </a>
            </span>
          </div>
          <button
            class="navbar-toggler"
            type="button"
            data-toggle="collapse"
            data-bs-toggle="collapse"
            data-target="#navbarSupportedContent"
            data-bs-target="#navbarSupportedContent"
            aria-controls="navbarNavAltMarkup"
            aria-expanded="false"
            aria-label="Toggle navigation"
          >
            <div class="hamburger">
              <span></span><span></span><span></span><span></span>
            </div>
          </button>
          <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav nav-dropdown" data-app-modern-menu="true">
              <li class="nav-item">
                <a
                  class="nav-link link text-primary display-7"
                  href="index.html#header01-2"
                  >Home</a
                >
              </li>
              <li class="nav-item dropdown">
                <a
                  class="nav-link link text-primary dropdown-toggle display-7"
                  href="#"
                  data-toggle="dropdown-submenu"
                  data-bs-toggle="dropdown"
                  data-bs-auto-close="outside"
                  aria-expanded="false"
                  >Polizza decesso</a
                >
                <div class="dropdown-menu" aria-labelledby="dropdown-707">
                  <a
                    class="text-primary dropdown-item display-7"
                    href="index.html#progress-bars02-0"
                    >Vantaggi</a
                  >
                  <a
                    class="text-primary show dropdown-item display-7"
                    href="index.html#progress-bars01-j"
                    >Valore</a
                  >
                  <a
                    class="text-primary show dropdown-item display-7"
                    href="#"
                    data-toggle="modal"
                    data-bs-toggle="modal"
                    data-target="#mbr-popup-2k"
                    data-bs-target="#mbr-popup-2k"
                    ><span
                      class="mdi-content-markunread mbr-iconfont mbr-iconfont-btn"
                    ></span
                    >Una storia vera (leggi)</a
                  >
                  <a
                    class="text-primary show dropdown-item display-7"
                    href="index.html#testimonials04-g"
                    >Testimonianze</a
                  >
                </div>
              </li>
              <li class="nav-item">
                <a
                  class="nav-link link text-primary display-7"
                  href="index.html#forms03-5"
                  >Chi siamo</a
                >
              </li>
              <li class="nav-item">
                <a
                  class="nav-link link text-primary display-7"
                  href="index.html#forms03-5"
                  >Contatti</a
                >
              </li>
              <li class="nav-item dropdown">
                <a
                  class="nav-link link text-primary dropdown-toggle show display-7"
                  href="#"
                  data-toggle="dropdown-submenu"
                  data-bs-toggle="dropdown"
                  data-bs-auto-close="outside"
                  aria-expanded="false"
                  ><span
                    class="icon54-v1-translate2 mbr-iconfont mbr-iconfont-btn"
                  ></span
                ></a>
                <div
                  class="dropdown-menu show"
                  aria-labelledby="dropdown-852"
                  data-bs-popper="none"
                >
                  <a
                    class="text-primary dropdown-item display-7"
                    href="https://de.lifeinsure.ch"
                    target="_blank"
                    >Deutsch</a
                  >
                  <a
                    class="text-primary dropdown-item display-7"
                    href="https://fr.lifeinsure.ch"
                    target="_blank"
                    >Français</a
                  >
                </div>
              </li>
            </ul>
            <div class="navbar-buttons mbr-section-btn">
              <a
                class="btn btn-lg btn-danger display-4"
                href="index.html#features04-2"
                ><span
                  class="icon54-v1-click-1 mbr-iconfont mbr-iconfont-btn"
                ></span
                >PREVENTIVO
              </a>
            </div>
          </div>
        </div>
      </nav>
    </section>

    <!-- Header esistente -->
    <section
      data-bs-version="5.1"
      class="inspirem5 header3 cid-uHcV8zftrL"
      id="header03-3t"
    >
      <div class="container">
        <div class="row justify-content-center">
          <div class="col-12 col-lg-11">
            <!-- Contenuto header se presente -->
          </div>
        </div>
      </div>
    </section>

    <!-- Modulo Emissione Polizza -->
    <div id="custom-html-3u">
      <div id="lifensure-emission-module" class="lifensure-container">
        <div class="lifensure-card">
          <h2>Emissione Polizza Vita Decesso</h2>

          <!-- Barra di avanzamento -->
          <div class="lifensure-progress-container">
            <div id="lifensure-progress-bar"></div>
          </div>

          <!-- STEP 1: Inserimento Dettagli Offerta -->
          <div id="lifensure-step-1" style="display: block">
            <div class="lifensure-step-title">
              1. Inserisci i dettagli dell'offerta
            </div>

            <div class="lifensure-form-group">
              <label for="lifensure-offerta-id">
                ID Offerta <span class="lifensure-required">*</span>
              </label>
              <input
                type="text"
                id="lifensure-offerta-id"
                placeholder="Inserisci l'ID offerta"
                required
                aria-describedby="lifensure-offerta-id-error"
              />
              <div id="lifensure-offerta-id-error" class="invalid-feedback">
                Inserisci l'ID dell'offerta ricevuto.
              </div>
              <div class="lifensure-input-hint">
                Inserisci l'ID ricevuto al termine della richiesta di
                preventivo.
              </div>
            </div>

            <div class="lifensure-form-group">
              <label for="lifensure-email-conferma">
                Email associata <span class="lifensure-required">*</span>
              </label>
              <input
                type="email"
                id="lifensure-email-conferma"
                placeholder="La tua email associata all'offerta"
                required
                aria-describedby="lifensure-email-error"
              />
              <div id="lifensure-email-error" class="invalid-feedback">
                Inserisci l'indirizzo email valido associato all'offerta.
              </div>
              <div class="lifensure-input-hint">
                Inserisci l'email utilizzata durante la richiesta di preventivo.
              </div>
            </div>

            <!-- Messaggio di errore se i dati dell'offerta non vengono trovati in sessionStorage -->
            <div
              id="lifensure-session-error"
              class="invalid-feedback"
              style="
                display: none;
                color: #dc3545;
                margin-bottom: 20px;
                text-align: center;
              "
            >
              Errore: Dati dell'offerta non trovati in sessione o non
              corrispondono. Assicurati di iniziare il processo dalla pagina di
              preventivo o ricontrolla i dati inseriti.
            </div>

            <div style="text-align: center; margin-top: 30px">
              <!-- Questo pulsante ora passa semplicemente al passo successivo se i campi sono riempiti e i dati in sessionStorage sono presenti -->
              <button id="lifensure-verifica-btn" class="lifensure-button">
                Visualizza Riepilogo e Consensi
              </button>
            </div>
          </div>

          <!-- STEP 2: Riepilogo e Consensi -->
          <div id="lifensure-step-2" style="display: none">
            <div class="lifensure-step-title">2. Riepilogo e Consensi</div>

            <div id="lifensure-riepilogo-content" class="lifensure-summary-box">
              <!-- Contenuto del riepilogo inserito dinamicamente dal sessionStorage -->
              <p>Caricamento riepilogo...</p>
            </div>

            <div class="lifensure-checkbox-group">
              <div class="lifensure-checkbox-wrapper">
                <input
                  type="checkbox"
                  id="lifensure-condizioni-check"
                  required
                  aria-describedby="lifensure-condizioni-error"
                  value="cga_acceptance"
                />
                <label
                  for="lifensure-condizioni-check"
                  id="lifensure-condizioni-label"
                >
                  Ho scaricato, letto ed accetto le condizioni generali di
                  assicurazione.
                </label>
              </div>
              <div id="lifensure-condizioni-error" class="invalid-feedback">
                Devi accettare le condizioni generali per procedere.
              </div>
            </div>

            <div class="lifensure-checkbox-group">
              <div class="lifensure-checkbox-wrapper">
                <input
                  type="checkbox"
                  id="lifensure-privacy-check"
                  required
                  aria-describedby="lifensure-privacy-error"
                  value="privacy_acceptance"
                />
                <label
                  for="lifensure-privacy-check"
                  id="lifensure-privacy-label"
                >
                  Ho letto ed accetto l'informativa sulla privacy acconsentendo
                  al trattamento dei miei dati.
                </label>
              </div>
              <div id="lifensure-privacy-error" class="invalid-feedback">
                Devi accettare l'informativa sulla privacy per procedere.
              </div>
            </div>

            <div class="lifensure-checkbox-group">
              <div class="lifensure-checkbox-wrapper">
                <input
                  type="checkbox"
                  id="lifensure-dichiarazione-check"
                  required
                  aria-describedby="lifensure-dichiarazione-error"
                  value="declaration_truth"
                />
                <label
                  for="lifensure-dichiarazione-check"
                  id="lifensure-dichiarazione-label"
                >
                  Dichiaro che tutte le informazioni fornite durante la
                  richiesta sono veritiere e complete.
                </label>
              </div>
              <div id="lifensure-dichiarazione-error" class="invalid-feedback">
                Devi confermare la veridicità delle informazioni fornite.
              </div>
            </div>

            <!-- Eventuali domande aggiuntive (se l'API indica la loro necessità nella fase PREMIA/OFFER) -->
            <!-- Poiché l'API /application si aspetta un array di questions nel corpo della richiesta,
                 queste domande dovrebbero essere state raccolte in una fase precedente o ottenute
                 insieme ai dettagli dell'offerta da sessionStorage.
                 Qui manteniamo semplicemente un segnaposto. -->
            <div id="lifensure-domande-aggiuntive" style="margin-top: 20px">
              <!-- Esempio di struttura di una domanda dinamica:
                 <div class="lifensure-form-group">
                     <label for="question-XYZ">Testo della domanda <span class="lifensure-required">*</span></label>
                     <input type="text" id="question-XYZ" required data-question-id="XYZ">
                     <div class="invalid-feedback">Risposta richiesta.</div>
                 </div>
                 -->
            </div>

            <div
              style="
                display: flex;
                justify-content: space-between;
                margin-top: 30px;
              "
            >
              <button
                id="lifensure-indietro-riepilogo"
                class="lifensure-button secondary"
              >
                Indietro
              </button>
              <!-- Questo pulsante ora avvia il processo di sottomissione dell'applicazione all'API /application -->
              <button id="lifensure-procedi-btn" class="lifensure-button">
                Procedi con l'emissione
              </button>
            </div>
          </div>

          <!-- STEP 3: Completamento (Ex Step 4) -->
          <div id="lifensure-step-3" style="display: none">
            <div class="lifensure-step-title">3. Emissione Completata</div>
            <div style="text-align: center; margin-bottom: 30px">
              <div class="lifensure-completion-icon"></div>
              <div class="lifensure-completion-message">
                <h3>Emissione completata!</h3>
                <p>La tua polizza vita è attiva.</p>
              </div>
            </div>

            <div class="lifensure-policy-info">
              <h5>
                Numero Polizza: <span id="lifensure-numero-polizza">--</span>
              </h5>
              <p>
                I documenti ufficiali della polizza sono stati inviati
                all'indirizzo email fornito.
              </p>
            </div>

            <div class="lifensure-documents-list">
              <h6>Documenti disponibili per il download:</h6>
              <div id="lifensure-documenti-polizza">
                <p>Caricamento documenti...</p>
                <!-- Testo iniziale -->
              </div>
            </div>

            <div style="text-align: center; margin-top: 30px">
              <a href="index.html" class="lifensure-button">
                Torna alla Home
              </a>
            </div>
          </div>

          <!-- STEP 4: Errore (Ex Step 5) -->
          <div id="lifensure-step-4" style="display: none">
            <div class="lifensure-step-title">4. Si è verificato un errore</div>
            <div style="text-align: center; margin-bottom: 30px">
              <div class="lifensure-error-icon">!</div>
              <!-- Icona semplice -->
              <div class="lifensure-error-message">
                <h3>Si è verificato un errore</h3>
                <p id="lifensure-errore-messaggio">
                  Non è stato possibile completare l'operazione.
                </p>
              </div>
            </div>

            <div style="text-align: center; margin-top: 30px">
              <button
                id="lifensure-riprova"
                class="lifensure-button"
                style="margin-right: 10px"
              >
                Riprova dal primo step
              </button>
              <a href="index.html" class="lifensure-button outline">
                Torna alla Home
              </a>
            </div>
          </div>

          <!-- Area di debug (opzionale, rimuovere in produzione) -->
          <div id="lifensure-debug">
            <h5 style="margin-top: 0">Debug Info:</h5>
            <div id="lifensure-debug-content"></div>
          </div>
        </div>
        <!-- Fine lifensure-card -->

        <!-- Finestra Modale -->
        <div id="lifensure-overlay">
          <div
            id="lifensure-modal"
            role="dialog"
            aria-modal="true"
            aria-labelledby="lifensure-modal-title"
            aria-describedby="lifensure-modal-content"
          >
            <div id="lifensure-modal-header">
              <h5 id="lifensure-modal-title">Titolo Modale</h5>
              <button
                id="lifensure-modal-close"
                aria-label="Chiudi finestra modale"
              >
                ×
              </button>
            </div>
            <div id="lifensure-modal-content">
              <!-- Contenuto modale inserito dinamicamente -->
            </div>
            <div id="lifensure-modal-footer">
              <button id="lifensure-modal-confirm" class="lifensure-button">
                Ho letto
              </button>
            </div>
          </div>
        </div>
      </div>
      <!-- Fine lifensure-emission-module -->
      <script src="assets/api/test-connection.js"></script>
      <script type="module" src="assets/api/text-email.js"></script>
      <script>
        // Scope isolato per evitare conflitti
        (function () {
          "use strict";

          // --- VARIABILI E COSTANTI ---
          let currentStepIndex = 0;
          // Variabile che memorizzerà i dati dell'offerta caricati da sessionStorage
          let offerDetailsFromSession = null;
          // Variabile che memorizzerà la risposta dell'API dopo la chiamata /application riuscita
          let applicationResponseData = null;

          let sessionStorageAvailable = false;
          // DEBUG_MODE impostato a false in produzione per rimuovere debugInfo
          const DEBUG_MODE = true; // Impostare a false in produzione

          // Elementi DOM principali
          const progressBar = document.getElementById("lifensure-progress-bar");
          // Elenco dei passi aggiornato in base alla nuova struttura
          const steps = [
            document.getElementById("lifensure-step-1"), // index 0 (Inserimento ID/Email)
            document.getElementById("lifensure-step-2"), // index 1 (Riepilogo e consensi)
            document.getElementById("lifensure-step-3"), // index 2 (Completamento)
            document.getElementById("lifensure-step-4"), // index 3 (Errore)
          ];

          const emissionModuleContainer = document.getElementById(
            "lifensure-emission-module"
          );

          // Input Step 1
          const offertaIdInput = document.getElementById(
            "lifensure-offerta-id"
          );
          const emailConfermaInput = document.getElementById(
            "lifensure-email-conferma"
          );
          const offertaIdError = document.getElementById(
            "lifensure-offerta-id-error"
          );
          const emailError = document.getElementById("lifensure-email-error");
          const sessionErrorDiv = document.getElementById(
            "lifensure-session-error"
          );

          // Checkbox Step 2
          const condizioniCheck = document.getElementById(
            "lifensure-condizioni-check"
          );
          const privacyCheck = document.getElementById(
            "lifensure-privacy-check"
          );
          const dichiarazioneCheck = document.getElementById(
            "lifensure-dichiarazione-check"
          );
          const condizioniError = document.getElementById(
            "lifensure-condizioni-error"
          );
          const privacyError = document.getElementById(
            "lifensure-privacy-error"
          );
          const dichiarazioneError = document.getElementById(
            "lifensure-dichiarazione-error"
          );
          const riepilogoContent = document.getElementById(
            "lifensure-riepilogo-content"
          );
          const condizioniLink = document.getElementById(
            "lifensure-condizioni-link"
          );
          const privacyLink = document.getElementById("lifensure-privacy-link");
          const domandeAggiuntiveDiv = document.getElementById(
            "lifensure-domande-aggiuntive"
          );

          // Completamento Step 3 (Ex Step 4)
          const numeroPolizzaSpan = document.getElementById(
            "lifensure-numero-polizza"
          );
          const documentiPolizzaDiv = document.getElementById(
            "lifensure-documenti-polizza"
          );

          // Errore Step 4 (Ex Step 5)
          const erroreMessaggioP = document.getElementById(
            "lifensure-errore-messaggio"
          );

          // Pulsanti
          const verificaBtn = document.getElementById("lifensure-verifica-btn"); // Ora "Visualizza Riepilogo"
          const indietroRiepilogoBtn = document.getElementById(
            "lifensure-indietro-riepilogo"
          );
          // Il pulsante "Procedi" ora avvia il processo di sottomissione dell'applicazione (application)
          const procediBtn = document.getElementById("lifensure-procedi-btn");
          const riprovaBtn = document.getElementById("lifensure-riprova");

          // Modale
          const overlay = document.getElementById("lifensure-overlay");
          const modal = document.getElementById("lifensure-modal");
          const modalTitle = document.getElementById("lifensure-modal-title");
          const modalContent = document.getElementById(
            "lifensure-modal-content"
          );
          const modalCloseBtn = document.getElementById(
            "lifensure-modal-close"
          );
          const modalConfirmBtn = document.getElementById(
            "lifensure-modal-confirm"
          );

          // Debug - Mantieni gli elementi DOM ma rimuovi le funzioni debugInfo
          const debugContainer = document.getElementById("lifensure-debug");
          const debugContent = document.getElementById(
            "lifensure-debug-content"
          );

          // --- FUNZIONI DI UTILITÀ ---

          /** @param {string} message Messaggio da loggare */
          function safeLog(message) {
            if (window.console && console.log) {
              console.log("[Lifensure Emission] " + message);
            }
          }

          // debugInfo function is removed as requested
          function debugInfo(data) {
            // Empty implementation for debugInfo in non-debug mode or when removed
            if (DEBUG_MODE && window.console && console.log) {
              // Optional: Log to console if DEBUG_MODE is true, even if debugInfo element is removed
              console.log("[DEBUG INFO]", data);
            }
            if (!DEBUG_MODE && debugContainer) {
              debugContainer.style.display = "none"; // Ensure debug area is hidden
            }
          }

          /** Verifica la disponibilità di sessionStorage */
          function checkSessionStorage() {
            try {
              const testKey = "lifensure_test";
              sessionStorage.setItem(testKey, testKey);
              sessionStorage.removeItem(testKey);
              sessionStorageAvailable = true;
              // debugInfo("SessionStorage è disponibile."); // Removed debug call
            } catch (e) {
              sessionStorageAvailable = false;
              // debugInfo("SessionStorage non disponibile o bloccato."); // Removed debug call
            }
          }

          /**
           * Mostra/Nasconde un elemento HTML.
           * @param {HTMLElement} element L'elemento da mostrare/nascondere.
           * @param {boolean} show True per mostrare, false per nascondere.
           */
          function toggleElement(element, show) {
            if (element) {
              element.style.display = show ? "block" : "none";
            } else {
              // debugInfo("Tentativo di toggle su elemento nullo."); // Removed debug call
            }
          }

          /**
           * Imposta lo stato di caricamento di un pulsante.
           * @param {HTMLButtonElement} button Il pulsante.
           * @param {boolean} isLoading True se sta caricando, false altrimenti.
           * @param {string} [loadingText='Elaborazione...'] Testo da mostrare durante il caricamento.
           */
          function setButtonLoading(
            button,
            isLoading,
            loadingText = "Elaborazione..."
          ) {
            if (!button) return;
            if (isLoading) {
              button.disabled = true;
              // Salva il testo originale se non già salvato
              if (!button.dataset.originalText) {
                button.dataset.originalText = button.innerHTML;
              }
              button.innerHTML = `<span class="lifensure-button-spinner"></span> ${loadingText}`;
            } else {
              button.disabled = false;
              // Ripristina il testo originale
              button.innerHTML =
                button.dataset.originalText || button.innerHTML;
              delete button.dataset.originalText; // Pulisci il testo salvato
            }
          }

          // --- FUNZIONI MODALE ---

          /**
           * Mostra la finestra modale.
           * @param {string} title Titolo del modale.
           * @param {string} content Contenuto HTML del modale.
           */
          function showModal(title, content) {
            if (!overlay || !modal || !modalTitle || !modalContent) {
              // debugInfo("Elementi del modale non trovati."); // Removed debug call
              return;
            }
            try {
              modalTitle.textContent = title;
              modalContent.innerHTML = content;
              overlay.classList.add("visible");
              // Opzionale: Gestione del focus per accessibilità
              // modalConfirmBtn.focus();
            } catch (err) {
              // debugInfo("Errore nell'apertura del modale: " + err.message); // Removed debug call
            }
          }

          /** Chiude la finestra modale. */
          function closeModal() {
            if (!overlay) return;
            overlay.classList.remove("visible");
          }

          // --- FUNZIONI DI NAVIGAZIONE E VALIDAZIONE ---

          /**
           * Naviga a un passo specifico.
           * @param {number} stepIndex Indice del passo (0-based).
           */
          function goToStep(stepIndex) {
            if (
              stepIndex < 0 ||
              stepIndex >= steps.length ||
              !steps[stepIndex]
            ) {
              // debugInfo("Indice passo non valido: " + stepIndex); // Removed debug call
              return;
            }
            safeLog("Navigating to step " + (stepIndex + 1));
            currentStepIndex = stepIndex;

            steps.forEach((step, index) => {
              if (step) {
                step.style.display = index === stepIndex ? "block" : "none";
                // Rimuovi lo stato di validazione quando cambi passo
                step.classList.remove("was-validated");
              }
            });

            // Aggiorna la barra di progresso (ora 3 passi principali: 0, 1, 2)
            const progressPercentage =
              stepIndex < 2 ? (stepIndex / 2) * 100 : 100;
            progressBar.style.width = progressPercentage + "%";

            // Scorri all'inizio del modulo
            if (emissionModuleContainer) {
              emissionModuleContainer.scrollIntoView({
                behavior: "smooth",
                block: "start",
              });
            }
          }

          /**
           * Valida gli input del passo corrente.
           * @returns {boolean} True se valido, false altrimenti.
           */
          function validateCurrentStep() {
            const currentStepElement = steps[currentStepIndex];
            if (!currentStepElement) {
              // debugInfo("currentStepElement non trovato per validazione."); // Removed debug call
              return false;
            }

            let isStepValid = true;
            // Aggiungi classe per attivare la validazione HTML5 e gli stili
            currentStepElement.classList.add("was-validated");

            // Seleziona tutti gli elementi del modulo obbligatori all'interno del passo corrente
            const requiredElements = currentStepElement.querySelectorAll(
              "input[required], select[required], textarea[required]"
            );

            requiredElements.forEach((element) => {
              // Controlla se l'elemento è visibile (non nascosto tramite display: none)
              const style = window.getComputedStyle(element);
              if (style.display === "none" || style.visibility === "hidden") {
                return; // Salta la validazione degli elementi nascosti
              }

              if (element.type === "checkbox") {
                if (!element.checked) {
                  isStepValid = false;
                }
              } else {
                if (!element.checkValidity()) {
                  isStepValid = false;
                }
              }
            });

            if (!isStepValid) {
              // debugInfo(`Validazione step ${currentStepIndex + 1} fallita.`); // Removed debug call
              // Trova il primo elemento invalido visibile su cui mettere il focus
              const firstInvalidVisible = currentStepElement.querySelector(
                ':invalid:not(fieldset):not([type="hidden"]):not([style*="display: none"]):not([style*="visibility: hidden"])'
              );

              if (firstInvalidVisible) {
                safeLog(
                  `Scrolling to first invalid visible element: ${
                    firstInvalidVisible.id ||
                    firstInvalidVisible.name ||
                    firstInvalidVisible.tagName
                  }`
                );
                setTimeout(() => {
                  firstInvalidVisible.focus();
                  firstInvalidVisible.scrollIntoView({
                    behavior: "smooth",
                    block: "center",
                  });
                }, 100); // Piccolo ritardo per uno scorrimento fluido
              } else {
                // debugInfo( "Nessun elemento invalido visibile trovato per lo scroll."); // Removed debug call
              }
            } else {
              // debugInfo(`Validazione step ${currentStepIndex + 1} superata.`); // Removed debug call
            }

            return isStepValid;
          }

          // --- FUNZIONI CHIAMATE API ---

          /**
           * Funzione generica per eseguire richieste Fetch all'API.
           * @param {string} endpoint - Parte dell'URL dopo API_BASE_URL (es. '/offer').
           * @param {object} options - Opzioni della richiesta (method, headers, body).
           * @returns {Promise<object | Response>} - Risposta JSON parsificata o oggetto Response per tipi non JSON (es. Blob).
           * @throws {object} Oggetto errore con dettagli (status, message, body)
           */
          async function callApi(endpoint, options = {}) {
            const url = `${API_BASE_URL}${endpoint}`;
            const defaultOptions = {
              method: "GET",
              headers: {
                "Content-Type": "application/json",
              },
            };

            options.headers = {
              ...defaultOptions.headers,
              ...options.headers,
            };

            if (
              options.body &&
              typeof options.body === "object" &&
              options.headers["Content-Type"] === "application/json"
            ) {
              options.body = JSON.stringify(options.body);
            }

            try {
              const response = await fetch(url, options);

              console.log(
                "Risposta API ricevuta (Status:",
                response.status,
                response.statusText,
                ")"
              );

              if (!response.ok) {
                let errorDetails = {
                  status: response.status,
                  message: `Errore HTTP! Stato: ${response.status} ${response.statusText}`,
                  body: null,
                };
                try {
                  const clonedResponse = response.clone();
                  const errorBody = await clonedResponse.json();
                  errorDetails.body = errorBody;
                  if (
                    Array.isArray(errorBody.error) &&
                    errorBody.error.length > 0
                  ) {
                    errorDetails.message = `Errore API: ${errorBody.error
                      .map((e) => e.error)
                      .join(", ")}`;
                  } else if (typeof errorBody === "object") {
                    errorDetails.message = `Errore API: ${JSON.stringify(
                      errorBody
                    )}`;
                  } else {
                    const textBody = await clonedResponse.text();
                    errorDetails.body = textBody;
                    errorDetails.message = `Errore API (Non-JSON): ${textBody.substring(
                      0,
                      200
                    )}`;
                  }
                } catch (parseError) {
                  console.log(
                    `Impossibile parsificare il corpo della risposta di errore API come JSON/Testo (${response.status}): ${parseError}`
                  );
                }
                throw errorDetails;
              }
              sessionStorage.removeItem("premio");
              sessionStorage.removeItem("referenceNumber");

              const contentType = response.headers.get("content-type");
              if (contentType && contentType.includes("application/json")) {
                const jsonResponse = await response.json();
                console.log(`Risposta Successo API (JSON):`, jsonResponse);

                return jsonResponse;
              } else {
                return response;
              }
            } catch (error) {
              if (!error.status) {
                console.error(`Errore di rete Fetch API: ${error.message}`);
                throw {
                  status: 0,
                  message: `Errore di rete: ${error.message}`,
                };
              }
              console.error(`Errore API:`, error); // Log dell'errore gestito
              throw error;
            }
          }

          /**
           * Chiama l'API per la sottomissione dell'applicazione per l'emissione della polizza (3.3 Application).
           * @param {string} offerId - ID dell'offerta.
           * @param {object} underwritingData - Dati per la sezione underwriting ({ questions: [], checkbox: [] }).
           * @returns {Promise<object>} - Risposta dell'API con numero di polizza e puntatori ai documenti.
           * @throws {object} Oggetto errore con dettagli
           */
          async function callSubmitApplicationAPI(offerId, underwritingData) {
            safeLog(
              `Chiamata API: Sottometti Applicazione per ID Offerta: ${offerId}`
            );
            const endpoint = "/application";

            const requestBody = {
              id: offerId,
              email: emailConfermaInput.value,
              underwriting: underwritingData,
              text: textEmailEmissioneIT(offerId),
            };
            // debugInfo("Corpo della richiesta per la Sottomissione Applicazione:", requestBody); // Removed debug call

            return callApi(endpoint, {
              method: "POST",
              body: requestBody,
            });
          }

          /**
           * Chiama l'API per recuperare il contenuto di un documento tramite il suo puntatore (4.1 Retrieve document).
           * @param {string} pointer - Identificatore del documento (pointer).
           * @returns {Promise<Blob>} - Contenuto del documento come Blob.
           * @throws {object | Error} Oggetto errore da callApi o Error se non è possibile ottenere il Blob.
           */
          async function callRetrieveDocumentAPI(pointer) {
            safeLog(
              `Chiamata API: Recupera Documento per Puntatore: ${pointer}`
            );
            const endpoint = `/document_pointer/${pointer}`;

            try {
              const response = await callApi(endpoint, {
                method: "GET",
                headers: {
                  Accept: "application/pdf, application/octet-stream, */*",
                },
              });

              const fileBlob = await response.blob();
              // debugInfo( `Blob del documento ricevuto (Tipo: ${fileBlob.type}, Dimensione: ${fileBlob.size} byte).`); // Removed debug call
              return fileBlob;
            } catch (error) {
              // debugInfo(`Errore in callRetrieveDocumentAPI:`, error); // Removed debug call
              throw error;
            }
          }

          // --- FUNZIONI LOGICA DEI PASSI ---

          /**
           * Tenta di caricare i dati dell'offerta da sessionStorage.
           * @returns {boolean} True se i dati sono trovati e validi, False altrimenti.
           */
          function loadOfferDetailsFromSession() {
            offerDetailsFromSession = null;
            toggleElement(sessionErrorDiv, false);

            if (!sessionStorageAvailable) {
              toggleElement(sessionErrorDiv, true);
              sessionErrorDiv.textContent =
                "Errore: La memoria locale (sessionStorage) non è disponibile. Il processo di emissione richiede la memoria locale attiva.";
              return false;
            }

            const savedOfferId = sessionStorage.getItem("reference-number");
            const datiUtenteString = sessionStorage.getItem("datiUtente");

            let datiUtente = null;
            if (datiUtenteString) {
              try {
                datiUtente = JSON.parse(datiUtenteString);
              } catch (e) {
                toggleElement(sessionErrorDiv, true);
                sessionErrorDiv.textContent =
                  "Errore: I dati dell'offerta salvati sono corrotti. Riprova a generare il preventivo.";
                return false;
              }
            }

            const enteredEmail = emailConfermaInput.value.trim().toLowerCase();

            if (!savedOfferId || !datiUtente || !datiUtente.email) {
              toggleElement(sessionErrorDiv, true);
              sessionErrorDiv.textContent =
                "Errore: Dati dell'offerta non trovati in sessione. Assicurati di iniziare il processo dalla pagina di preventivo.";
              return false;
            }

            const sessionEmail = datiUtente.email.toLowerCase();
            if (enteredEmail && sessionEmail !== enteredEmail) {
              toggleElement(sessionErrorDiv, true);
              sessionErrorDiv.textContent =
                "Errore: L'email inserita non corrisponde a quella associata all'offerta salvata in sessione.";
              return false;
            }

            offerDetailsFromSession = {
              id: savedOfferId,
              offerDetails: datiUtente,
            };

            return true;
          }

          /** Popola il riepilogo dell'offerta nel Passo 2 dai dati di sessionStorage */
          function populateOfferSummary() {
            if (
              !offerDetailsFromSession ||
              !offerDetailsFromSession.offerDetails
            ) {
              riepilogoContent.innerHTML =
                '<p style="color: red;">Errore interno: Dati riepilogo non disponibili.</p>';
              return;
            }

            try {
              const offerData = offerDetailsFromSession.offerDetails;

              const nomeCompleto = `${offerData.firstname || ""} ${
                offerData.lastname || ""
              }`.trim();
              const durata = offerData.durata;
              const copertura = parseFloat(
                offerData.coverage || 0
              ).toLocaleString("it-CH");
              const premio = sessionStorage.getItem("premio") || 0;
              const modalita =
                offerData.mode === "annual" ? "Annuale" : "Mensile";

              riepilogoContent.innerHTML = `
                      <h6>Riepilogo dei dettagli</h6>
                      <div style="display: flex; flex-wrap: wrap; gap: 15px;">
                          <div style="flex: 1; min-width: 200px;">
                              <p><strong>Assicurato:</strong> ${
                                nomeCompleto || "N/D"
                              }</p>
                              <p><strong>Durata:</strong> ${
                                durata || "N/D"
                              } anni</p>
                          </div>
                          <div style="flex: 1; min-width: 200px;">
                              <p><strong>Copertura:</strong> CHF ${
                                copertura || "N/D"
                              }</p>
                              <p><strong>Modalità Pagamento:</strong> ${
                                modalita || "N/D"
                              }</p>
                          </div>
                      </div>
                      <div class="lifensure-summary-highlight">
                          <strong>Premio ${modalita}:</strong> CHF ${
                premio || "N/D"
              }
                      </div>
                  `;

              if (condizioniLink) {
                condizioniLink.onclick = (e) => {
                  e.preventDefault();
                  showModal(
                    "Condizioni Generali di Assicurazione",
                    `
                         <p>Testo delle condizioni generali di assicurazione. (Contenuto statico a scopo dimostrativo. Fare riferimento ai documenti ufficiali scaricabili dopo l'emissione della polizza.)</p>
                       `
                  );
                };
                condizioniLink.style.cursor = "pointer";
              }

              if (privacyLink) {
                privacyLink.onclick = (e) => {
                  e.preventDefault();
                  showModal(
                    "Informativa sulla Privacy",
                    `
                         <p>Testo dell'informativa sulla privacy. (Contenuto statico a scopo dimostrativo. Fare riferimento ai documenti ufficiali scaricabili dopo l'emissione della polizza.)</p>
                       `
                  );
                };
                privacyLink.style.cursor = "pointer";
              }
            } catch (error) {
              riepilogoContent.innerHTML =
                '<p style="color: red;">Errore nella formattazione del riepilogo.</p>';
            }
          }

          /** Popola l'elenco dei documenti nel Passo 3 (Completamento) */
          function populatePolicyDocuments() {
            if (
              !applicationResponseData ||
              !applicationResponseData.document_pointers ||
              applicationResponseData.document_pointers.length === 0
            ) {
              documentiPolizzaDiv.innerHTML =
                "<p>Nessun documento disponibile al momento.</p>";
              return;
            }

            let documentsHTML = "";
            applicationResponseData.document_pointers.forEach((doc) => {
              if (doc.pointer) {
                documentsHTML += `
                           <div class="lifensure-document-item">
                               <span>${
                                 doc.description || "Documento senza nome"
                               }</span>
                               <button type="button" class="lifensure-document-download-btn lifensure-button outline" data-pointer="${
                                 doc.pointer
                               }" data-description="${
                  doc.description || "Documento"
                }">
                                   ⬇ Scarica <!-- Freccia Giù -->
                               </button>
                           </div>
                       `;
              } else {
                documentsHTML += `
                           <div class="lifensure-document-item">
                               <span>${
                                 doc.description || "Documento senza nome"
                               }</span>
                               <span style="color: #6c757d; font-size: 0.9rem;">Non disponibile per download</span>
                           </div>
                       `;
              }
            });
            documentiPolizzaDiv.innerHTML = documentsHTML;

            document
              .querySelectorAll(".lifensure-document-download-btn")
              .forEach((button) => {
                button.addEventListener("click", function () {
                  const pointer = this.dataset.pointer;
                  const description = this.dataset.description;
                  if (pointer) {
                    handleDocumentDownload(pointer, description);
                  }
                });
              });
          }

          /**
           * Gestisce il pulsante "Visualizza Riepilogo" (Passo 1 -> Passo 2 o 4).
           * @async
           */
          async function handleStep1Proceed() {
            toggleElement(sessionErrorDiv, false);

            if (!validateCurrentStep()) {
              return;
            }

            const isOfferDataLoaded = loadOfferDetailsFromSession();

            if (!isOfferDataLoaded) {
              return;
            }

            populateOfferSummary();
            goToStep(1);
          }

          /**
           * Gestisce la sottomissione dell'applicazione (Passo 2 -> Passo 3 o 4).
           * @async
           */
          async function handleApplicationSubmission() {
            if (!validateCurrentStep()) {
              return;
            }

            const offerId = offerDetailsFromSession?.id;
            if (!offerId) {
              erroreMessaggioP.textContent =
                "Errore interno: ID offerta non disponibile per la sottomissione. Riprova dal primo passo.";
              goToStep(3);
              return;
            }

            const underwritingData = {
              questions: [],
              checkbox: [],
            };

            setButtonLoading(procediBtn, true, "Invio richiesta...");

            try {
              applicationResponseData = await callSubmitApplicationAPI(
                offerId,
                underwritingData
              );

              if (applicationResponseData.policy_number) {
                numeroPolizzaSpan.textContent =
                  applicationResponseData.policy_number;
              } else {
                numeroPolizzaSpan.textContent = "-- N/D --";
              }

              populatePolicyDocuments();
              goToStep(2);

              if (sessionStorageAvailable) {
                sessionStorage.removeItem("reference-number");
                sessionStorage.removeItem("datiUtente");
                sessionStorage.removeItem("datiPreventivo");
              }
              console.log("Emissione riuscita:", applicationResponseData);
            } catch (error) {
              console.log("Emissione fallita:", error);

              const errorMessage =
                error.message ||
                "Errore sconosciuto durante l'invio della richiesta.";
              if (
                error.body &&
                Array.isArray(error.body.error) &&
                error.body.error.length > 0
              ) {
                erroreMessaggioP.textContent = `Errore: ${error.body.error[0].error}`;
              } else {
                erroreMessaggioP.textContent = `Si è verificato un errore durante la finalizzazione della polizza. Dettaglio: ${errorMessage}. Contatta l'assistenza.`;
              }

              goToStep(3);
            } finally {
              setButtonLoading(procediBtn, false);
            }
          }

          /**
           * Gestisce il download di un documento (Passo 3 Completamento).
           * @param {string} pointer Identificatore del documento.
           * @param {string} description Descrizione per il nome file.
           * @async
           */
          async function handleDocumentDownload(pointer, description) {
            const downloadButton = documentiPolizzaDiv.querySelector(
              `button[data-pointer="${pointer}"]`
            );
            if (!downloadButton) {
              return;
            }

            setButtonLoading(downloadButton, true, "...");

            try {
              const fileBlob = await callRetrieveDocumentAPI(pointer);

              if (fileBlob instanceof Blob) {
                const url = window.URL.createObjectURL(fileBlob);
                const a = document.createElement("a");
                a.style.display = "none";
                a.href = url;
                const cleanedDescription = (description || "Documento")
                  .replace(/[^a-z0-9\s_]/gi, "")
                  .trim()
                  .replace(/\s+/g, "_");
                const fileBaseName =
                  cleanedDescription || "documento_scaricato";

                let fileExtension = "";
                const mimeParts = fileBlob.type.split("/");
                if (mimeParts.length > 1) {
                  fileExtension = "." + mimeParts.pop();
                }

                a.download = `${fileBaseName}${fileExtension}`;

                document.body.appendChild(a);
                a.click();

                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
              } else {
                throw new Error(
                  "Received unexpected data format for document."
                );
              }
            } catch (error) {
              const errorMessage = error.message || "Errore sconosciuto.";
              alert(
                `Impossibile scaricare il documento "${description}". Dettaglio: ${errorMessage}. Riprova o contatta l'assistenza.`
              );
            } finally {
              setButtonLoading(downloadButton, false);
              if (downloadButton.dataset.originalText) {
                downloadButton.innerHTML = downloadButton.dataset.originalText;
                delete downloadButton.dataset.originalText;
              } else {
                downloadButton.innerHTML = "⬇ Scarica";
              }
            }
          }

          // --- INIZIALIZZAZIONE DEL MODULO ---

          async function initializeModule() {
            safeLog("Inizializzazione modulo emissione...");
            checkSessionStorage();

            loadOfferDetailsFromSession();

            if (offerDetailsFromSession) {
              offertaIdInput.value = offerDetailsFromSession.id || "";
              emailConfermaInput.value =
                offerDetailsFromSession.offerDetails?.email || "";
              toggleElement(sessionErrorDiv, false);
            }

            addEventListeners();
            goToStep(0);

            safeLog("Modulo emissione inizializzato con successo.");
          }

          // --- AGGIUNTA EVENT LISTENER ---

          function addEventListeners() {
            verificaBtn?.addEventListener("click", handleStep1Proceed);

            indietroRiepilogoBtn?.addEventListener("click", () => goToStep(0));

            procediBtn?.addEventListener("click", handleApplicationSubmission);

            riprovaBtn?.addEventListener("click", () => goToStep(0));

            if (condizioniLink) {
              condizioniLink.addEventListener("click", (e) => {
                e.preventDefault();
                showModal(
                  "Condizioni Generali di Assicurazione",
                  `
                         <p>Testo delle condizioni generali di assicurazione. (Contenuto statico a scopo dimostrativo. Fare riferimento ai documenti ufficiali scaricabili dopo l'emissione della polizza.)</p>
                       `
                );
              });
            }

            if (privacyLink) {
              privacyLink.addEventListener("click", (e) => {
                e.preventDefault();
                showModal(
                  "Informativa sulla Privacy",
                  `
                         <p>Testo dell'informativa sulla privacy. (Contenuto statico a scopo dimostrativo. Fare riferimento ai documenti ufficiali scaricabili dopo l'emissione della polizza.)</p>
                       `
                );
              });
            }

            modalCloseBtn?.addEventListener("click", closeModal);
            modalConfirmBtn?.addEventListener("click", closeModal);
            overlay?.addEventListener("click", (e) => {
              if (e.target === overlay) closeModal();
            });
          }

          if (document.readyState === "loading") {
            document.addEventListener("DOMContentLoaded", initializeModule);
          } else {
            initializeModule();
          }
        })(); // Fine scope isolato
      </script>
    </div>
    <!-- Fine custom-html-3u -->

    <!-- Script JS esistenti del tema -->
    <script src="https://r.mobirisesite.com/1342903/assets/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script src="https://r.mobirisesite.com/1342903/assets/smoothscroll/smooth-scroll.js"></script>
    <script src="https://r.mobirisesite.com/1342903/assets/ytplayer/index.js"></script>
    <script src="https://r.mobirisesite.com/1342903/assets/dropdown/js/navbar-dropdown.js"></script>
    <script src="https://r.mobirisesite.com/1342903/assets/theme/js/script.js"></script>

    <!-- Script per Lazy Loading immagini (esistente) -->
    <script>
      "use strict";
      if ("loading" in HTMLImageElement.prototype) {
        document.querySelectorAll('img[loading="lazy"]').forEach((e) => {
          if (e.dataset.src) e.src = e.dataset.src;
        });
      } else {
        // Fallback lazy loading
      }
    </script>
  </body>
</html>
