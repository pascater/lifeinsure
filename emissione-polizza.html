<!DOCTYPE html>
<html lang="it">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <!-- Meta tags esistenti -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta
      name="twitter:image:src"
      content="https://r.mobirisesite.com/1342903/assets/images/page8-meta.png"
    />
    <meta
      property="og:image"
      content="https://r.mobirisesite.com/1342903/assets/images/page8-meta.png"
    />
    <meta
      name="twitter:title"
      content="Emissione Polizza Vita caso morte in Svizzera"
    />
    <!-- Titolo più specifico -->
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, minimum-scale=1"
    />
    <link
      rel="shortcut icon"
      href="https://r.mobirisesite.com/1342903/assets/images/lifeinsure-1-172x172.png?v=1TZWWw"
      type="image/x-icon"
    />
    <meta
      name="description"
      content="Completa l'emissione della tua polizza vita caso morte in Svizzera."
    />
    <!-- Descrizione più specifica -->

    <title>Emissione Polizza Vita caso morte in Svizzera</title>
    <!-- Titolo più specifico -->

    <!-- Link CSS esistenti -->
    <link
      rel="stylesheet"
      href="https://r.mobirisesite.com/1342903/assets/Material-Design-Icons/css/material.css"
    />
    <link
      rel="stylesheet"
      href="https://r.mobirisesite.com/1342903/assets/icon54/style.css"
    />
    <link
      rel="stylesheet"
      href="https://r.mobirisesite.com/1342903/assets/bootstrap/css/bootstrap.min.css"
    />
    <link
      rel="stylesheet"
      href="https://r.mobirisesite.com/1342903/assets/bootstrap/css/bootstrap-grid.min.css"
    />
    <link
      rel="stylesheet"
      href="https://r.mobirisesite.com/1342903/assets/bootstrap/css/bootstrap-reboot.min.css"
    />
    <link
      rel="stylesheet"
      href="https://r.mobirisesite.com/1342903/assets/web/assets/gdpr-plugin/gdpr-styles.css"
    />
    <link
      rel="stylesheet"
      href="https://r.mobirisesite.com/1342903/assets/popup-overlay-plugin/style.css"
    />
    <link
      rel="stylesheet"
      href="https://r.mobirisesite.com/1342903/assets/dropdown/css/style.css"
    />
    <link
      rel="stylesheet"
      href="https://r.mobirisesite.com/1342903/assets/socicon/css/styles.css"
    />
    <link
      rel="stylesheet"
      href="https://r.mobirisesite.com/1342903/assets/theme/css/style.css"
    />
    <link
      rel="preload"
      href="https://fonts.googleapis.com/css?family=Space+Grotesk:300,400,500,600,700&display=swap"
      as="style"
      onload="this.onload=null;this.rel='stylesheet'"
    />
    <noscript
      ><link
        rel="stylesheet"
        href="https://fonts.googleapis.com/css?family=Space+Grotesk:300,400,500,600,700&display=swap"
    /></noscript>
    <link
      rel="preload"
      as="style"
      href="https://r.mobirisesite.com/1342903/assets/mobirise/css/mbr-additional.css?v=1TZWWw"
    />
    <link
      rel="stylesheet"
      href="https://r.mobirisesite.com/1342903/assets/mobirise/css/mbr-additional.css?v=1TZWWw"
      type="text/css"
    />

    <!-- Stili specifici per il modulo di emissione -->
    <style>
      /* Stili base per il contenitore e card (simili a Bootstrap ma isolati) */
      .lifensure-container {
        font-family: "Space Grotesk", sans-serif; /* Usa lo stesso font del tema */
        line-height: 1.6;
        color: #333;
      }
      .lifensure-card {
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        padding: 30px;
        margin: 30px auto;
        max-width: 800px;
        border: 1px solid #e9ecef;
      }
      .lifensure-card h2 {
        text-align: center;
        margin-bottom: 30px;
        color: #343a40;
        font-size: 1.8rem; /* Dimensione titolo */
        font-weight: 600;
      }
      .lifensure-step-title {
        border-bottom: 1px solid #dee2e6;
        padding-bottom: 12px;
        margin-bottom: 25px;
        font-weight: 600;
        font-size: 1.2rem;
        color: #495057;
      }
      /* Barra di avanzamento */
      .lifensure-progress-container {
        height: 10px;
        background-color: #e9ecef;
        border-radius: 5px;
        margin-bottom: 35px;
        overflow: hidden;
      }
      #lifensure-progress-bar {
        height: 100%;
        width: 0%;
        background-color: #0d6efd; /* Blu Bootstrap */
        transition: width 0.4s ease-in-out;
        border-radius: 5px;
      }
      /* Stili input e label */
      .lifensure-form-group {
        margin-bottom: 20px;
      }
      .lifensure-form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: #495057;
        font-size: 0.95rem;
      }
      .lifensure-form-group label .lifensure-required {
        color: #dc3545; /* Rosso Bootstrap */
        margin-left: 3px;
      }
      .lifensure-form-group input[type="text"],
      .lifensure-form-group input[type="email"],
      .lifensure-form-group select {
        width: 100%;
        padding: 12px 15px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        font-size: 1rem;
        box-sizing: border-box;
        transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
      }
      .lifensure-form-group input:focus,
      .lifensure-form-group select:focus {
        border-color: #86b7fe;
        outline: 0;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
      }
      .lifensure-form-group .lifensure-input-hint {
        color: #6c757d;
        font-size: 0.85rem;
        margin-top: 5px;
      }
      /* Stili per errori (usando classi Bootstrap-like) */
      .lifensure-form-group input.is-invalid,
      .lifensure-form-group select.is-invalid {
        border-color: #dc3545 !important;
      }
      .lifensure-form-group .invalid-feedback {
        color: #dc3545;
        font-size: 0.875em;
        margin-top: 0.25rem;
        display: none; /* Nascosto di default */
      }
      .was-validated .lifensure-form-group input:invalid ~ .invalid-feedback,
      .was-validated .lifensure-form-group select:invalid ~ .invalid-feedback {
        display: block; /* Mostra se invalido e validato */
      }
      /* Stili Checkbox */
      .lifensure-checkbox-group {
        margin-bottom: 15px;
      }
      .lifensure-checkbox-group .lifensure-checkbox-wrapper {
        display: flex;
        align-items: flex-start; /* Allinea in alto per testi lunghi */
        margin-bottom: 5px;
      }
      .lifensure-checkbox-group input[type="checkbox"] {
        margin-right: 10px;
        margin-top: 4px; /* Allinea meglio con il testo */
        flex-shrink: 0; /* Impedisce al checkbox di restringersi */
        width: 1.1em;
        height: 1.1em;
      }
      .lifensure-checkbox-group label {
        font-size: 1rem;
        color: #333;
        line-height: 1.5;
      }
      .lifensure-checkbox-group label a {
        color: #0d6efd;
        text-decoration: underline;
        cursor: pointer;
      }
      .lifensure-checkbox-group .invalid-feedback {
        color: #dc3545;
        font-size: 0.875em;
        margin-left: 25px; /* Allinea con il testo della label */
        display: none;
      }
      .was-validated
        .lifensure-checkbox-group
        input:invalid
        ~ .invalid-feedback {
        display: block;
      }
      /* Bottoni */
      .lifensure-button {
        background-color: #0d6efd;
        color: white;
        border: none;
        padding: 12px 25px;
        border-radius: 4px;
        font-size: 1rem;
        cursor: pointer;
        transition: background-color 0.2s ease;
        display: inline-flex; /* Per allineare spinner e testo */
        align-items: center;
        justify-content: center;
      }
      .lifensure-button:hover {
        background-color: #0b5ed7;
      }
      .lifensure-button.secondary {
        background-color: #6c757d;
      }
      .lifensure-button.secondary:hover {
        background-color: #5c636a;
      }
      .lifensure-button.success {
        background-color: #198754;
      }
      .lifensure-button.success:hover {
        background-color: #157347;
      }
      .lifensure-button.outline {
        background-color: transparent;
        color: #0d6efd;
        border: 1px solid #0d6efd;
      }
      .lifensure-button.outline:hover {
        background-color: #0d6efd;
        color: white;
      }
      .lifensure-button:disabled {
        background-color: #adb5bd;
        cursor: not-allowed;
        opacity: 0.7;
      }
      .lifensure-button-spinner {
        display: inline-block;
        width: 1em; /* Dimensione relativa al font */
        height: 1em;
        border: 2px solid currentColor;
        border-radius: 50%;
        border-top-color: transparent;
        animation: lifensure-spin 0.75s linear infinite;
        margin-right: 8px;
      }
      @keyframes lifensure-spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      /* Riepilogo */
      .lifensure-summary-box {
        margin-bottom: 25px;
        background-color: #f8f9fa;
        padding: 20px;
        border-radius: 5px;
        border: 1px solid #dee2e6;
      }
      .lifensure-summary-box h6 {
        font-weight: 600;
        font-size: 1.1rem;
        margin-bottom: 15px;
        color: #495057;
      }
      .lifensure-summary-box p {
        margin-bottom: 8px;
        color: #343a40;
      }
      .lifensure-summary-box strong {
        color: #212529;
      }
      .lifensure-summary-highlight {
        background-color: #cfe2ff;
        color: #052c65;
        padding: 12px;
        border-radius: 4px;
        margin-top: 15px;
        font-weight: 500;
      }
      /* Pagamento Dettagli */
      .lifensure-payment-details {
        display: none; /* Nascosto di default */
        margin-bottom: 20px;
        background-color: #f8f9fa;
        padding: 15px;
        border-radius: 4px;
        border: 1px solid #dee2e6;
      }
      .lifensure-payment-details h6 {
        font-weight: 600;
        margin-bottom: 10px;
        font-size: 1rem;
      }
      .lifensure-payment-details p {
        margin-bottom: 5px;
        font-size: 0.95rem;
      }
      .lifensure-payment-details small {
        color: #6c757d;
        font-size: 0.85rem;
        display: block;
        margin-top: 10px;
      }
      /* Step Completamento */
      .lifensure-completion-icon {
        width: 80px;
        height: 80px;
        margin: 0 auto 25px auto;
        border-radius: 50%;
        border: 4px solid #198754; /* Verde successo */
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .lifensure-completion-icon::after {
        content: "";
        display: block;
        width: 40%;
        height: 60%;
        border: solid #198754;
        border-width: 0 5px 5px 0;
        transform: rotate(45deg);
      }
      .lifensure-completion-message h3 {
        color: #198754;
        font-size: 1.6rem;
        margin-bottom: 10px;
        font-weight: 600;
      }
      .lifensure-completion-message p {
        font-size: 1.1rem;
        color: #495057;
      }
      .lifensure-policy-info {
        background-color: #d1e7dd; /* Verde chiaro successo */
        color: #0f5132;
        padding: 15px 20px;
        border-radius: 4px;
        margin-bottom: 25px;
        border: 1px solid #badbcc;
      }
      .lifensure-policy-info h5 {
        margin-bottom: 5px;
        font-weight: 600;
        font-size: 1.1rem;
      }
      .lifensure-documents-list {
        background-color: #f8f9fa;
        padding: 20px;
        border-radius: 4px;
        margin-bottom: 25px;
        border: 1px solid #dee2e6;
      }
      .lifensure-documents-list h6 {
        font-weight: 600;
        margin-bottom: 15px;
        font-size: 1.1rem;
      }
      .lifensure-document-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
        padding-bottom: 12px;
        border-bottom: 1px solid #eee;
      }
      .lifensure-document-item:last-child {
        margin-bottom: 0;
        padding-bottom: 0;
        border-bottom: none;
      }
      .lifensure-document-item span {
        color: #343a40;
      }
      .lifensure-document-item button,
      .lifensure-document-item a {
        /* Stile per bottone o link */
        background-color: #e9ecef;
        color: #0d6efd;
        border: 1px solid #ced4da;
        padding: 6px 12px;
        border-radius: 4px;
        font-size: 0.9rem;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        cursor: pointer;
        transition: background-color 0.2s ease, border-color 0.2s ease;
      }
      .lifensure-document-item button:hover,
      .lifensure-document-item a:hover {
        background-color: #dee2e6;
        border-color: #adb5bd;
      }
      /* Step Errore */
      .lifensure-error-icon {
        width: 80px;
        height: 80px;
        margin: 0 auto 25px auto;
        font-size: 60px;
        color: #dc3545; /* Rosso errore */
        display: flex;
        align-items: center;
        justify-content: center;
        border: 4px solid #dc3545;
        border-radius: 50%;
      }
      .lifensure-error-message h3 {
        color: #dc3545;
        font-size: 1.6rem;
        margin-bottom: 10px;
        font-weight: 600;
      }
      .lifensure-error-message p {
        font-size: 1.1rem;
        color: #495057;
      }
      /* Modal */
      #lifensure-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.6);
        z-index: 1050; /* Sopra la navbar di Mobirise? */
        opacity: 0;
        transition: opacity 0.3s ease;
      }
      #lifensure-overlay.visible {
        display: block;
        opacity: 1;
      }
      #lifensure-modal {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) scale(0.9);
        width: 90%;
        max-width: 650px;
        background-color: white;
        border-radius: 8px;
        padding: 25px 30px;
        max-height: 85vh;
        overflow-y: auto;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
        opacity: 0;
        transition: opacity 0.3s ease, transform 0.3s ease;
        z-index: 1051;
      }
      #lifensure-overlay.visible #lifensure-modal {
        opacity: 1;
        transform: translate(-50%, -50%) scale(1);
      }
      #lifensure-modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid #dee2e6;
      }
      #lifensure-modal-title {
        font-size: 1.3rem;
        margin: 0;
        font-weight: 600;
        color: #343a40;
      }
      #lifensure-modal-close {
        background: none;
        border: none;
        font-size: 2rem;
        cursor: pointer;
        line-height: 1;
        color: #6c757d;
        padding: 0 5px;
      }
      #lifensure-modal-close:hover {
        color: #343a40;
      }
      #lifensure-modal-content {
        margin-bottom: 25px;
        font-size: 1rem;
        line-height: 1.7;
      }
      #lifensure-modal-content h6 {
        font-weight: 600;
        margin-top: 15px;
        margin-bottom: 8px;
        font-size: 1.1rem;
      }
      #lifensure-modal-content ul {
        padding-left: 25px;
        margin-top: 10px;
      }
      #lifensure-modal-footer {
        text-align: right;
        padding-top: 15px;
        border-top: 1px solid #dee2e6;
      }
      /* Debug Area */
      #lifensure-debug {
        display: none; /* Nascosto di default */
        margin-top: 30px;
        padding: 15px;
        background-color: #fff3cd; /* Giallo warning */
        color: #664d03;
        border: 1px solid #ffecb5;
        border-radius: 4px;
        font-size: 0.9rem;
      }
      #lifensure-debug h5 {
        margin-top: 0;
        margin-bottom: 10px;
        font-weight: 600;
      }
      #lifensure-debug p {
        margin: 3px 0;
        word-break: break-all;
      }
    </style>
  </head>
  <body>
    <!-- Navbar esistente -->
    <section
      data-bs-version="5.1"
      class="inspirem5 menu menu1 cid-uHcV8yKzqs"
      once="menu"
      id="menu01-3s"
    >
      <nav class="navbar navbar-dropdown navbar-fixed-top navbar-expand-lg">
        <div class="container-fluid">
          <div class="navbar-brand">
            <span class="navbar-logo">
              <a href="index.html#top">
                <img
                  src="https://r.mobirisesite.com/1342903/assets/images/lifeinsure-1-172x172.png?v=1TZWWw"
                  alt="LifeInsure Logo"
                  style="height: 3.6rem"
                />
              </a>
            </span>
          </div>
          <button
            class="navbar-toggler"
            type="button"
            data-toggle="collapse"
            data-bs-toggle="collapse"
            data-target="#navbarSupportedContent"
            data-bs-target="#navbarSupportedContent"
            aria-controls="navbarNavAltMarkup"
            aria-expanded="false"
            aria-label="Toggle navigation"
          >
            <div class="hamburger">
              <span></span><span></span><span></span><span></span>
            </div>
          </button>
          <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav nav-dropdown" data-app-modern-menu="true">
              <li class="nav-item">
                <a
                  class="nav-link link text-primary display-7"
                  href="index.html#header01-2"
                  >Home</a
                >
              </li>
              <li class="nav-item dropdown">
                <a
                  class="nav-link link text-primary dropdown-toggle display-7"
                  href="#"
                  data-toggle="dropdown-submenu"
                  data-bs-toggle="dropdown"
                  data-bs-auto-close="outside"
                  aria-expanded="false"
                  >Polizza decesso</a
                >
                <div class="dropdown-menu" aria-labelledby="dropdown-707">
                  <a
                    class="text-primary dropdown-item display-7"
                    href="index.html#progress-bars02-0"
                    >Vantaggi</a
                  >
                  <a
                    class="text-primary show dropdown-item display-7"
                    href="index.html#progress-bars01-j"
                    >Valore</a
                  >
                  <a
                    class="text-primary show dropdown-item display-7"
                    href="#"
                    data-toggle="modal"
                    data-bs-toggle="modal"
                    data-target="#mbr-popup-2k"
                    data-bs-target="#mbr-popup-2k"
                    ><span
                      class="mdi-content-markunread mbr-iconfont mbr-iconfont-btn"
                    ></span
                    >Una storia vera (leggi)</a
                  >
                  <a
                    class="text-primary show dropdown-item display-7"
                    href="index.html#testimonials04-g"
                    >Testimonianze</a
                  >
                </div>
              </li>
              <li class="nav-item">
                <a
                  class="nav-link link text-primary display-7"
                  href="index.html#forms03-5"
                  >Chi siamo</a
                >
              </li>
              <li class="nav-item">
                <a
                  class="nav-link link text-primary display-7"
                  href="index.html#forms03-5"
                  >Contatti</a
                >
              </li>
              <li class="nav-item dropdown">
                <a
                  class="nav-link link text-primary dropdown-toggle show display-7"
                  href="#"
                  data-toggle="dropdown-submenu"
                  data-bs-toggle="dropdown"
                  data-bs-auto-close="outside"
                  aria-expanded="false"
                  ><span
                    class="icon54-v1-translate2 mbr-iconfont mbr-iconfont-btn"
                  ></span
                ></a>
                <div
                  class="dropdown-menu show"
                  aria-labelledby="dropdown-852"
                  data-bs-popper="none"
                >
                  <a
                    class="text-primary dropdown-item display-7"
                    href="https://de.lifeinsure.ch"
                    target="_blank"
                    >Deutsch</a
                  >
                  <a
                    class="text-primary dropdown-item display-7"
                    href="https://fr.lifeinsure.ch"
                    target="_blank"
                    >Français</a
                  >
                </div>
              </li>
            </ul>
            <div class="navbar-buttons mbr-section-btn">
              <a
                class="btn btn-lg btn-danger display-4"
                href="index.html#features04-2"
                ><span
                  class="icon54-v1-click-1 mbr-iconfont mbr-iconfont-btn"
                ></span
                >PREVENTIVO
              </a>
            </div>
          </div>
        </div>
      </nav>
    </section>

    <!-- Header esistente -->
    <section
      data-bs-version="5.1"
      class="inspirem5 header3 cid-uHcV8zftrL"
      id="header03-3t"
    >
      <div class="container">
        <div class="row justify-content-center">
          <div class="col-12 col-lg-11">
            <!-- Contenuto header se presente -->
          </div>
        </div>
      </div>
    </section>

    <!-- Modulo Emissione Polizza -->
    <div id="custom-html-3u">
      <div id="lifensure-emission-module" class="lifensure-container">
        <div class="lifensure-card">
          <h2>Emissione Polizza Vita Decesso</h2>

          <!-- Barra di avanzamento -->
          <div class="lifensure-progress-container">
            <div id="lifensure-progress-bar"></div>
          </div>

          <!-- STEP 1: Verifica Offerta -->
          <div id="lifensure-step-1" style="display: block">
            <div class="lifensure-step-title">
              1. Verifica e conferma l'offerta
            </div>

            <div class="lifensure-form-group">
              <label for="lifensure-offerta-id">
                ID Offerta <span class="lifensure-required">*</span>
              </label>
              <input
                type="text"
                id="lifensure-offerta-id"
                placeholder="Es. ABCD1234"
                required
                aria-describedby="lifensure-offerta-id-error"
              />
              <div id="lifensure-offerta-id-error" class="invalid-feedback">
                Inserisci l'ID dell'offerta ricevuto via email.
              </div>
              <div class="lifensure-input-hint">
                Inserisci l'ID ricevuto al termine della richiesta. Attenzione:
                può essere usato una sola volta.
              </div>
            </div>

            <div class="lifensure-form-group">
              <label for="lifensure-email-conferma">
                Email di conferma <span class="lifensure-required">*</span>
              </label>
              <input
                type="email"
                id="lifensure-email-conferma"
                placeholder="La tua email"
                required
                aria-describedby="lifensure-email-error"
              />
              <div id="lifensure-email-error" class="invalid-feedback">
                Inserisci l'indirizzo email valido usato per la richiesta.
              </div>
              <div class="lifensure-input-hint">
                Inserisci l'email utilizzata durante la richiesta dell'offerta.
              </div>
            </div>

            <div style="text-align: center; margin-top: 30px">
              <button id="lifensure-verifica-btn" class="lifensure-button">
                Avanti
              </button>
            </div>
          </div>

          <!-- STEP 2: Riepilogo e Consensi -->
          <div id="lifensure-step-2" style="display: none">
            <div class="lifensure-step-title">2. Riepilogo e Consensi</div>

            <div id="lifensure-riepilogo-content" class="lifensure-summary-box">
              <!-- Contenuto del riepilogo inserito dinamicamente -->
              <p>Caricamento riepilogo...</p>
            </div>

            <div class="lifensure-checkbox-group">
              <div class="lifensure-checkbox-wrapper">
                <input
                  type="checkbox"
                  id="lifensure-condizioni-check"
                  required
                  aria-describedby="lifensure-condizioni-error"
                />
                <label for="lifensure-condizioni-check">
                  Ho letto e accetto le
                  <a href="#" id="lifensure-condizioni-link"
                    >condizioni generali di assicurazione</a
                  >.
                </label>
              </div>
              <div id="lifensure-condizioni-error" class="invalid-feedback">
                Devi accettare le condizioni generali per procedere.
              </div>
            </div>

            <div class="lifensure-checkbox-group">
              <div class="lifensure-checkbox-wrapper">
                <input
                  type="checkbox"
                  id="lifensure-privacy-check"
                  required
                  aria-describedby="lifensure-privacy-error"
                />
                <label for="lifensure-privacy-check">
                  Ho letto l'<a href="#" id="lifensure-privacy-link"
                    >informativa sulla privacy</a
                  >
                  e acconsento al trattamento dei miei dati.
                </label>
              </div>
              <div id="lifensure-privacy-error" class="invalid-feedback">
                Devi accettare l'informativa sulla privacy per procedere.
              </div>
            </div>

            <div class="lifensure-checkbox-group">
              <div class="lifensure-checkbox-wrapper">
                <input
                  type="checkbox"
                  id="lifensure-dichiarazione-check"
                  required
                  aria-describedby="lifensure-dichiarazione-error"
                />
                <label for="lifensure-dichiarazione-check">
                  Dichiaro che tutte le informazioni fornite durante la
                  richiesta sono veritiere e complete.
                </label>
              </div>
              <div id="lifensure-dichiarazione-error" class="invalid-feedback">
                Devi confermare la veridicità delle informazioni fornite.
              </div>
            </div>

            <!-- Eventuali domande aggiuntive (se necessarie dall'API) -->
            <div
              id="lifensure-domande-aggiuntive"
              style="margin-top: 20px"
            ></div>

            <div
              style="
                display: flex;
                justify-content: space-between;
                margin-top: 30px;
              "
            >
              <button
                id="lifensure-indietro-riepilogo"
                class="lifensure-button secondary"
              >
                Indietro
              </button>
              <button id="lifensure-procedi-btn" class="lifensure-button">
                Procedi con l'emissione
              </button>
            </div>
          </div>

          <!-- STEP 3: Pagamento -->
          <div id="lifensure-step-3" style="display: none">
            <div class="lifensure-step-title">3. Pagamento Primo Premio</div>

            <div
              style="
                background-color: #cfe2ff;
                color: #052c65;
                padding: 15px;
                border-radius: 4px;
                margin-bottom: 25px;
                display: flex;
                align-items: center;
                border: 1px solid #b6d4fe;
              "
            >
              <span style="margin-right: 10px; font-size: 1.2rem">ⓘ</span>
              <span
                >Il primo premio deve essere pagato per attivare la copertura
                assicurativa.</span
              >
            </div>

            <div
              id="lifensure-riepilogo-pagamento"
              class="lifensure-summary-box"
            >
              <!-- Contenuto del riepilogo pagamento inserito dinamicamente -->
              <p>Caricamento dettagli pagamento...</p>
            </div>

            <div class="lifensure-form-group">
              <label for="lifensure-metodo-pagamento">
                Metodo di pagamento <span class="lifensure-required">*</span>
              </label>
              <select
                id="lifensure-metodo-pagamento"
                required
                aria-describedby="lifensure-pagamento-error"
              >
                <option value="" selected disabled>
                  Seleziona il metodo...
                </option>
                <option value="e-bill">E-Bill</option>
                <option value="bonifico">Fattura con QR code (Bonifico)</option>
                <!-- Aggiungere altri metodi se disponibili -->
              </select>
              <div id="lifensure-pagamento-error" class="invalid-feedback">
                Seleziona un metodo di pagamento.
              </div>
            </div>

            <div id="lifensure-dati-ebill" class="lifensure-payment-details">
              <p>
                Riceverai le istruzioni per configurare il pagamento E-Bill
                all'indirizzo email indicato.
              </p>
              <small
                >Il documento di polizza verrà generato dopo la conferma della
                configurazione e del primo pagamento.</small
              >
            </div>

            <div id="lifensure-dati-bonifico" class="lifensure-payment-details">
              <h6>Dati per il bonifico:</h6>
              <p><strong>Intestatario:</strong> Squarelife LTD</p>
              <!-- Assicurati che sia corretto -->
              <p><strong>IBAN:</strong> CHXX XXXX XXXX XXXX XXXX X</p>
              <!-- Placeholder IBAN -->
              <p>
                <strong>Importo:</strong>
                <span id="lifensure-importo-bonifico">CHF --.--</span>
              </p>
              <p>
                <strong>Causale:</strong>
                <span id="lifensure-causale-bonifico">Polizza [numero]</span>
              </p>
              <small
                >Il documento di polizza verrà generato dopo la ricezione e
                verifica del pagamento.</small
              >
            </div>

            <div
              style="
                display: flex;
                justify-content: space-between;
                margin-top: 30px;
              "
            >
              <button
                id="lifensure-indietro-pagamento"
                class="lifensure-button secondary"
              >
                Indietro
              </button>
              <button
                id="lifensure-conferma-pagamento"
                class="lifensure-button success"
              >
                Conferma e Attiva Polizza
              </button>
            </div>
          </div>

          <!-- STEP 4: Completamento -->
          <div id="lifensure-step-4" style="display: none">
            <div style="text-align: center; margin-bottom: 30px">
              <div class="lifensure-completion-icon"></div>
              <div class="lifensure-completion-message">
                <h3>Emissione completata!</h3>
                <p>La tua polizza vita è attiva.</p>
              </div>
            </div>

            <div class="lifensure-policy-info">
              <h5>
                Numero Polizza: <span id="lifensure-numero-polizza">--</span>
              </h5>
              <p>
                I documenti ufficiali della polizza sono stati inviati
                all'indirizzo email fornito.
              </p>
            </div>

            <div class="lifensure-documents-list">
              <h6>Documenti disponibili per il download:</h6>
              <div id="lifensure-documenti-polizza">
                <p>Nessun documento disponibile al momento.</p>
              </div>
            </div>

            <div style="text-align: center; margin-top: 30px">
              <a href="index.html" class="lifensure-button">
                Torna alla Home
              </a>
            </div>
          </div>

          <!-- STEP 5: Errore -->
          <div id="lifensure-step-5" style="display: none">
            <div style="text-align: center; margin-bottom: 30px">
              <div class="lifensure-error-icon">!</div>
              <!-- Icona semplice -->
              <div class="lifensure-error-message">
                <h3>Si è verificato un errore</h3>
                <p id="lifensure-errore-messaggio">
                  Non è stato possibile completare l'operazione.
                </p>
              </div>
            </div>

            <div style="text-align: center; margin-top: 30px">
              <button
                id="lifensure-riprova"
                class="lifensure-button"
                style="margin-right: 10px"
              >
                Riprova dal primo step
              </button>
              <a href="index.html" class="lifensure-button outline">
                Torna alla Home
              </a>
            </div>
          </div>

          <!-- Area di debug (opzionale, rimuovere in produzione) -->
          <div id="lifensure-debug">
            <h5 style="margin-top: 0">Debug Info:</h5>
            <div id="lifensure-debug-content"></div>
          </div>
        </div>
        <!-- Fine lifensure-card -->

        <!-- Finestra Modale -->
        <div id="lifensure-overlay">
          <div
            id="lifensure-modal"
            role="dialog"
            aria-modal="true"
            aria-labelledby="lifensure-modal-title"
            aria-describedby="lifensure-modal-content"
          >
            <div id="lifensure-modal-header">
              <h5 id="lifensure-modal-title">Titolo Modale</h5>
              <button
                id="lifensure-modal-close"
                aria-label="Chiudi finestra modale"
              >
                ×
              </button>
            </div>
            <div id="lifensure-modal-content">
              <!-- Contenuto modale inserito dinamicamente -->
            </div>
            <div id="lifensure-modal-footer">
              <button id="lifensure-modal-confirm" class="lifensure-button">
                Ho letto
              </button>
            </div>
          </div>
        </div>
      </div>
      <!-- Fine lifensure-emission-module -->
      <script src="assets/api/test-connection.js"></script>
      <script src="assets/api/emetti-polizza.js"></script>
      <script>
        // Scope isolato per evitare conflitti
        (function () {
          "use strict";

          // --- VARIABILI E COSTANTI ---
          let currentStepIndex = 0;
          let datiVerificaOfferta = null; // Conterrà i dati dopo la verifica (inclusi doc pointers, policy number, ecc.)
          let sessionStorageAvailable = false;
          const DEBUG_MODE = true; // Impostare a false in produzione

          // Elementi DOM principali
          const progressBar = document.getElementById("lifensure-progress-bar");
          const steps = [
            document.getElementById("lifensure-step-1"),
            document.getElementById("lifensure-step-2"),
            document.getElementById("lifensure-step-3"),
            document.getElementById("lifensure-step-4"),
            document.getElementById("lifensure-step-5"), // Step di errore
          ];
          const emissionModuleContainer = document.getElementById(
            "lifensure-emission-module"
          );

          // Input Step 1
          const offertaIdInput = document.getElementById(
            "lifensure-offerta-id"
          );
          const emailConfermaInput = document.getElementById(
            "lifensure-email-conferma"
          );
          const offertaIdError = document.getElementById(
            "lifensure-offerta-id-error"
          );
          const emailError = document.getElementById("lifensure-email-error");

          // Checkbox Step 2
          const condizioniCheck = document.getElementById(
            "lifensure-condizioni-check"
          );
          const privacyCheck = document.getElementById(
            "lifensure-privacy-check"
          );
          const dichiarazioneCheck = document.getElementById(
            "lifensure-dichiarazione-check"
          );
          const condizioniError = document.getElementById(
            "lifensure-condizioni-error"
          );
          const privacyError = document.getElementById(
            "lifensure-privacy-error"
          );
          const dichiarazioneError = document.getElementById(
            "lifensure-dichiarazione-error"
          );
          const riepilogoContent = document.getElementById(
            "lifensure-riepilogo-content"
          );
          const condizioniLink = document.getElementById(
            "lifensure-condizioni-link"
          );
          const privacyLink = document.getElementById("lifensure-privacy-link");

          // Pagamento Step 3
          const metodoPagamentoSelect = document.getElementById(
            "lifensure-metodo-pagamento"
          );
          const pagamentoError = document.getElementById(
            "lifensure-pagamento-error"
          );
          const datiEbillDiv = document.getElementById("lifensure-dati-ebill");
          const datiBonificoDiv = document.getElementById(
            "lifensure-dati-bonifico"
          );
          const riepilogoPagamentoDiv = document.getElementById(
            "lifensure-riepilogo-pagamento"
          );
          const importoBonificoSpan = document.getElementById(
            "lifensure-importo-bonifico"
          );
          const causaleBonificoSpan = document.getElementById(
            "lifensure-causale-bonifico"
          );

          // Completamento Step 4
          const numeroPolizzaSpan = document.getElementById(
            "lifensure-numero-polizza"
          );
          const documentiPolizzaDiv = document.getElementById(
            "lifensure-documenti-polizza"
          );

          // Errore Step 5
          const erroreMessaggioP = document.getElementById(
            "lifensure-errore-messaggio"
          );

          // Bottoni
          const verificaBtn = document.getElementById("lifensure-verifica-btn");
          const indietroRiepilogoBtn = document.getElementById(
            "lifensure-indietro-riepilogo"
          );
          const procediBtn = document.getElementById("lifensure-procedi-btn");
          const indietroPagamentoBtn = document.getElementById(
            "lifensure-indietro-pagamento"
          );
          const confermaPagamentoBtn = document.getElementById(
            "lifensure-conferma-pagamento"
          );
          const riprovaBtn = document.getElementById("lifensure-riprova");

          // Modal
          const overlay = document.getElementById("lifensure-overlay");
          const modal = document.getElementById("lifensure-modal");
          const modalTitle = document.getElementById("lifensure-modal-title");
          const modalContent = document.getElementById(
            "lifensure-modal-content"
          );
          const modalCloseBtn = document.getElementById(
            "lifensure-modal-close"
          );
          const modalConfirmBtn = document.getElementById(
            "lifensure-modal-confirm"
          );

          // Debug
          const debugContainer = document.getElementById("lifensure-debug");
          const debugContent = document.getElementById(
            "lifensure-debug-content"
          );

          // --- FUNZIONI DI UTILITÀ ---

          /** @param {string} message Messaggio da loggare */
          function safeLog(message) {
            if (window.console && console.log) {
              console.log("[Lifensure Emission] " + message);
            }
          }

          /** @param {string} message Messaggio da mostrare nell'area debug */
          function debugInfo(message) {
            if (!DEBUG_MODE || !debugContainer || !debugContent) return;
            try {
              debugContainer.style.display = "block";
              const time = new Date().toLocaleTimeString();
              const p = document.createElement("p");
              p.textContent = time + ": " + message;
              debugContent.appendChild(p);
            } catch (err) {
              safeLog("Error in debugInfo: " + err.message);
            }
          }

          /** Verifica la disponibilità di sessionStorage */
          function checkSessionStorage() {
            try {
              sessionStorage.setItem("lifensure_test", "test");
              sessionStorage.removeItem("lifensure_test");
              sessionStorageAvailable = true;
              debugInfo("SessionStorage è disponibile.");
            } catch (e) {
              sessionStorageAvailable = false;
              debugInfo("SessionStorage non disponibile o bloccato.");
              // Considera di mostrare un avviso all'utente se sessionStorage è cruciale
            }
          }

          /**
           * Mostra/Nasconde un elemento aggiungendo/togliendo una classe.
           * @param {HTMLElement} element L'elemento da mostrare/nascondere.
           * @param {boolean} show True per mostrare, false per nascondere.
           * @param {string} [className='d-none'] La classe usata per nascondere.
           */
          function toggleElement(element, show, className = "d-none") {
            if (element) {
              element.classList.toggle(className, !show);
            } else {
              debugInfo("Tentativo di toggle su elemento nullo.");
            }
          }

          /**
           * Imposta lo stato di caricamento di un bottone.
           * @param {HTMLButtonElement} button Il bottone.
           * @param {boolean} isLoading True se sta caricando, false altrimenti.
           * @param {string} [loadingText='Elaborazione...'] Testo da mostrare durante il caricamento.
           */
          function setButtonLoading(
            button,
            isLoading,
            loadingText = "Elaborazione..."
          ) {
            if (!button) return;
            if (isLoading) {
              button.disabled = true;
              // Salva il testo originale se non già salvato
              if (!button.dataset.originalText) {
                button.dataset.originalText = button.innerHTML;
              }
              button.innerHTML = `<span class="lifensure-button-spinner"></span> ${loadingText}`;
            } else {
              button.disabled = false;
              // Ripristina il testo originale
              button.innerHTML =
                button.dataset.originalText || button.innerHTML;
            }
          }

          // --- FUNZIONI MODAL ---

          /**
           * Mostra la finestra modale.
           * @param {string} title Titolo del modal.
           * @param {string} content Contenuto HTML del modal.
           */
          function showModal(title, content) {
            if (!overlay || !modal || !modalTitle || !modalContent) {
              debugInfo("Elementi del modal non trovati.");
              return;
            }
            try {
              modalTitle.textContent = title;
              modalContent.innerHTML = content;
              overlay.classList.add("visible");
              // Focus management (opzionale ma consigliato per accessibilità)
              modalConfirmBtn.focus();
            } catch (err) {
              debugInfo("Errore nell'apertura del modal: " + err.message);
            }
          }

          /** Chiude la finestra modale. */
          function closeModal() {
            if (!overlay) return;
            overlay.classList.remove("visible");
          }

          // --- FUNZIONI DI NAVIGAZIONE E VALIDAZIONE ---

          /**
           * Naviga a uno step specifico.
           * @param {number} stepIndex Indice dello step (0-based).
           */
          function goToStep(stepIndex) {
            if (
              stepIndex < 0 ||
              stepIndex >= steps.length ||
              !steps[stepIndex]
            ) {
              debugInfo("Indice step non valido: " + stepIndex);
              return;
            }
            safeLog("Navigating to step " + (stepIndex + 1));
            currentStepIndex = stepIndex;

            steps.forEach((step, index) => {
              if (step) {
                step.style.display = index === stepIndex ? "block" : "none";
                // Rimuovi stato validazione quando si naviga
                step.classList.remove("was-validated");
              }
            });

            // Aggiorna progress bar (considera 3 step principali prima di completamento/errore)
            const progressMaxSteps = 3;
            const progress =
              stepIndex < progressMaxSteps
                ? (stepIndex / progressMaxSteps) * 100
                : 100;
            progressBar.style.width = progress + "%";

            // Scrolla all'inizio del modulo
            if (emissionModuleContainer) {
              emissionModuleContainer.scrollIntoView({
                behavior: "smooth",
                block: "start",
              });
            }
          }

          /**
           * Valida gli input dello step corrente.
           * @returns {boolean} True se valido, false altrimenti.
           */
          function validateCurrentStep() {
            const currentStepElement = steps[currentStepIndex];
            if (!currentStepElement) return false;

            let isStepValid = true;
            // Aggiungi classe per triggerare feedback validazione HTML5/Bootstrap
            currentStepElement.classList.add("was-validated");

            // Validazione input/select required
            const requiredInputs = currentStepElement.querySelectorAll(
              "input[required], select[required]"
            );
            requiredInputs.forEach((input) => {
              // Salta validazione se l'input o un suo antenato è nascosto
              if (input.offsetParent === null) return;

              if (!input.checkValidity()) {
                isStepValid = false;
                // Il feedback viene mostrato automaticamente da 'was-validated' e CSS
              }
            });

            // Validazione checkbox required
            const requiredCheckboxes = currentStepElement.querySelectorAll(
              'input[type="checkbox"][required]'
            );
            requiredCheckboxes.forEach((checkbox) => {
              if (checkbox.offsetParent === null) return;
              if (!checkbox.checked) {
                isStepValid = false;
              }
            });

            // Validazioni specifiche per step
            if (currentStepIndex === 2) {
              // Step Pagamento
              if (!metodoPagamentoSelect.checkValidity()) {
                isStepValid = false;
              }
            }

            if (!isStepValid) {
              // Scrolla al primo elemento invalido visibile
              const firstInvalid = currentStepElement.querySelector(
                ":invalid:not(fieldset)"
              );
              if (firstInvalid && firstInvalid.offsetParent !== null) {
                firstInvalid.focus();
                firstInvalid.scrollIntoView({
                  behavior: "smooth",
                  block: "center",
                });
              }
            }

            return isStepValid;
          }

          // --- FUNZIONI LOGICA PRINCIPALE (con simulazione API) ---

          /** Recupera dati da sessionStorage */
          function getSessionData(key) {
            if (!sessionStorageAvailable) {
              debugInfo(
                `Tentativo di leggere ${key} ma sessionStorage non è disponibile.`
              );
              return null;
            }
            try {
              const dataString = sessionStorage.getItem(key);
              if (!dataString) {
                debugInfo(
                  `Nessun dato trovato in sessionStorage per la chiave: ${key}`
                );
                return null;
              }
              return JSON.parse(dataString);
            } catch (error) {
              debugInfo(
                `Errore nel parsing dei dati da sessionStorage per ${key}: ${error.message}`
              );
              sessionStorage.removeItem(key); // Rimuovi dati corrotti
              return null;
            }
          }

          /** Popola il riepilogo offerta nello Step 2 */
          function populateOfferSummary() {
            const datiUtente = getSessionData("datiUtente");

            if (!datiUtente || !datiVerificaOfferta) {
              riepilogoContent.innerHTML =
                '<p style="color: red;">Errore: Dati necessari per il riepilogo non trovati.</p>';
              debugInfo("Dati mancanti per populateOfferSummary");
              return;
            }

            try {
              const nomeCompleto = `${datiUtente.firstname || ""} ${
                datiUtente.lastname || ""
              }`.trim();
              const durata = datiUtente.durata;
              const copertura = parseFloat(
                datiUtente.coverage || 0
              ).toLocaleString("it-CH"); // Formatta come valuta CH
              const premio = parseFloat(datiUtente.premio || 0).toFixed(2);
              const modalita =
                datiUtente.mode === "annual" ? "Annuale" : "Mensile";

              riepilogoContent.innerHTML = `
                      <h6>Riepilogo dei dettagli</h6>
                      <div style="display: flex; flex-wrap: wrap; gap: 15px;">
                          <div style="flex: 1; min-width: 200px;">
                              <p><strong>Assicurato:</strong> ${
                                nomeCompleto || "N/D"
                              }</p>
                              <p><strong>Durata:</strong> ${
                                durata || "N/D"
                              } anni</p>
                          </div>
                          <div style="flex: 1; min-width: 200px;">
                              <p><strong>Copertura:</strong> CHF ${
                                copertura || "N/D"
                              }</p>
                              <p><strong>Modalità Pagamento:</strong> ${
                                modalita || "N/D"
                              }</p>
                          </div>
                      </div>
                      <div class="lifensure-summary-highlight">
                          <strong>Premio ${modalita}:</strong> CHF ${
                premio || "N/D"
              }
                      </div>
                  `;
            } catch (error) {
              riepilogoContent.innerHTML =
                '<p style="color: red;">Errore nella formattazione del riepilogo.</p>';
              debugInfo(`Errore in populateOfferSummary: ${error.message}`);
            }
          }

          /** Popola il riepilogo pagamento nello Step 3 */
          function populatePaymentSummary() {
            const datiPreventivo = getSessionData("datiUtente");

            if (!datiPreventivo || !datiVerificaOfferta) {
              riepilogoPagamentoDiv.innerHTML =
                '<p style="color: red;">Errore: Dati necessari per il pagamento non trovati.</p>';
              debugInfo("Dati mancanti per populatePaymentSummary");
              return;
            }

            try {
              const premio = parseFloat(datiPreventivo.premio || 0).toFixed(2);
              const oggi = new Date();
              const scadenza = new Date(
                oggi.setDate(oggi.getDate() + 7)
              ).toLocaleDateString("it-CH"); // Scadenza 7 giorni

              riepilogoPagamentoDiv.innerHTML = `
                      <div style="display: flex; flex-wrap: wrap; gap: 15px;">
                          <div style="flex: 1; min-width: 200px;">
                              <p><strong>Premio da pagare:</strong> CHF ${
                                premio || "N/D"
                              }</p>
                          </div>
                          <div style="flex: 1; min-width: 200px;">
                              <p><strong>Scadenza pagamento:</strong> ${
                                scadenza || "N/D"
                              }</p>
                          </div>
                      </div>
                  `;
              // Popola anche i dati per il bonifico
              importoBonificoSpan.textContent = `CHF ${premio || "--.--"}`;
              causaleBonificoSpan.textContent = `Polizza ${
                datiVerificaOfferta?.policy_number || "[Numero Polizza]"
              }`;
            } catch (error) {
              riepilogoPagamentoDiv.innerHTML =
                '<p style="color: red;">Errore nella formattazione del riepilogo pagamento.</p>';
              debugInfo(`Errore in populatePaymentSummary: ${error.message}`);
            }
          }

          /** Popola la lista documenti nello Step 4 */
          function populatePolicyDocuments() {
            if (
              !datiVerificaOfferta ||
              !datiVerificaOfferta.document_pointers ||
              datiVerificaOfferta.document_pointers.length === 0
            ) {
              documentiPolizzaDiv.innerHTML =
                "<p>Nessun documento disponibile o errore nel recupero.</p>";
              debugInfo(
                "Nessun document_pointers trovato in datiVerificaOfferta."
              );
              return;
            }

            let documentsHTML = "";
            datiVerificaOfferta.document_pointers.forEach((doc) => {
              // Usa un bottone per triggerare la funzione di download
              documentsHTML += `
                      <div class="lifensure-document-item">
                          <span>${
                            doc.description || "Documento senza nome"
                          }</span>
                          <button type="button" class="lifensure-document-download-btn" data-pointer="${
                            doc.pointer
                          }" data-description="${
                doc.description || "Documento"
              }">
                              ⬇ Scarica <!-- Freccia Giù -->
                          </button>
                      </div>
                  `;
            });
            documentiPolizzaDiv.innerHTML = documentsHTML;

            // Aggiungi event listener ai nuovi bottoni
            document
              .querySelectorAll(".lifensure-document-download-btn")
              .forEach((button) => {
                button.addEventListener("click", function () {
                  const pointer = this.dataset.pointer;
                  const description = this.dataset.description;
                  if (pointer) {
                    handleDocumentDownload(pointer, description);
                  } else {
                    debugInfo(
                      "Pointer mancante per il download del documento."
                    );
                  }
                });
              });
          }

          /**
           * Gestisce la verifica dell'offerta (Step 1 -> Step 2 o 5).
           * @async
           */
          async function handleOfferVerification() {
            if (!validateCurrentStep()) return;

            setButtonLoading(verificaBtn, true, "Verifica in corso...");

            try {
              // Dati simulati per test
              const response = await emettiPolizza(
                offertaIdInput.value,
                emailConfermaInput.value
              );
              // !!! FINE CHIAMATA API REALE !!!

              if (
                response.status === "ok" &&
                response.policy_number &&
                response.document_pointers
              ) {
                datiVerificaOfferta = response; // Salva i dati ricevuti
                debugInfo(
                  "Verifica offerta OK. Policy Number: " +
                    response.policy_number
                );
                populateOfferSummary(); // Popola riepilogo Step 2
                goToStep(1); // Vai a Step 2 (Riepilogo)
              } else {
                throw new Error(
                  response.error?.[0]?.error ||
                    "Risposta API non valida o offerta non trovata."
                );
              }
            } catch (error) {
              debugInfo(`Errore API verifica offerta: ${error.message}`);
              erroreMessaggioP.textContent = `Impossibile verificare l'offerta (ID: ${offertaIdInput.value}). Assicurati che l'ID e l'email siano corretti e che l'offerta non sia già stata utilizzata. Dettaglio: ${error.message}`;
              goToStep(4); // Vai a Step 5 (Errore)
            } finally {
              setButtonLoading(verificaBtn, false);
            }
          }

          /**
           * Gestisce il passaggio da Riepilogo a Pagamento (Step 2 -> Step 3 o resta in 2).
           */
          function handleProceedToPayment() {
            if (!validateCurrentStep()) return;
            populatePaymentSummary(); // Popola riepilogo Step 3
            goToStep(2); // Vai a Step 3 (Pagamento)
          }

          /**
           * Gestisce la conferma del pagamento e l'emissione finale (Step 3 -> Step 4 o 5).
           * @async
           */
          async function handlePaymentConfirmation() {
            if (!validateCurrentStep()) return;

            setButtonLoading(
              confermaPagamentoBtn,
              true,
              "Attivazione polizza..."
            );
            const selectedPaymentMethod = metodoPagamentoSelect.value;

            try {
              // !!! CHIAMATA API REALE (sostituire simulazione) !!!
              // Qui potresti dover passare datiVerificaOfferta.policy_number e selectedPaymentMethod al backend
              // const response = await confermaEmissioneAPI(datiVerificaOfferta.policy_number, selectedPaymentMethod);
              const response = await simulateApi_confermaPagamento(
                datiVerificaOfferta.policy_number,
                selectedPaymentMethod
              );
              // !!! FINE CHIAMATA API REALE !!!

              if (response.status === "ok") {
                debugInfo(
                  "Conferma pagamento OK per polizza: " +
                    datiVerificaOfferta.policy_number
                );
                numeroPolizzaSpan.textContent =
                  datiVerificaOfferta.policy_number;
                populatePolicyDocuments(); // Mostra link documenti
                goToStep(3); // Vai a Step 4 (Completamento)
                // Pulisci sessionStorage se l'emissione è andata a buon fine
                if (sessionStorageAvailable) {
                  sessionStorage.removeItem("datiUtente");
                  sessionStorage.removeItem("datiPreventivo");
                  sessionStorage.removeItem("reference-number"); // O l'ID offerta
                  debugInfo("Dati sessionStorage puliti dopo emissione.");
                }
              } else {
                throw new Error(
                  response.error?.[0]?.error ||
                    "Errore durante la conferma del pagamento o emissione."
                );
              }
            } catch (error) {
              debugInfo(`Errore API conferma pagamento: ${error.message}`);
              erroreMessaggioP.textContent = `Si è verificato un errore durante la finalizzazione della polizza ${
                datiVerificaOfferta?.policy_number || ""
              }. Contatta l'assistenza. Dettaglio: ${error.message}`;
              goToStep(4); // Vai a Step 5 (Errore)
            } finally {
              setButtonLoading(confermaPagamentoBtn, false);
            }
          }

          /**
           * Gestisce il download di un documento (Step 4).
           * @param {string} pointer Identificativo del documento.
           * @param {string} description Descrizione per il nome file.
           * @async
           */
          async function handleDocumentDownload(pointer, description) {
            const downloadButton = documentiPolizzaDiv.querySelector(
              `button[data-pointer="${pointer}"]`
            );
            if (!downloadButton) return;

            setButtonLoading(downloadButton, true, "..."); // Spinner piccolo

            try {
              //  const fileData = await loadDocumentFromAPI(pointer); // Dovrebbe restituire Blob o URL
              const response = await fetch(
                `${API_BASE_URL}/document_pointer/${pointer}`
              );
              if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
              }
              const fileData = await response.blob();

              if (fileData instanceof Blob) {
                const url = window.URL.createObjectURL(fileData);
                const a = document.createElement("a");
                a.style.display = "none";
                a.href = url;
                a.download = `${(description || "Documento").replace(
                  /[^a-z0-9]/gi,
                  "_"
                )}.pdf`; // Nome file pulito
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                debugInfo(`Download completato per: ${description}`);
              } else if (
                typeof fileData === "string" &&
                fileData.startsWith("http")
              ) {
                // Se l'API restituisce un URL diretto
                window.open(fileData, "_blank");
                debugInfo(`Apertura URL per: ${description}`);
              } else {
                throw new Error("Formato dati documento non riconosciuto.");
              }
            } catch (error) {
              debugInfo(
                `Errore download documento ${description}: ${error.message}`
              );
              alert(
                `Impossibile scaricare il documento "${description}". Riprova o contatta l'assistenza.`
              );
            } finally {
              setButtonLoading(downloadButton, false); // Ripristina bottone
              // Ripristina testo originale del bottone download
              if (downloadButton.dataset.originalText) {
                downloadButton.innerHTML = downloadButton.dataset.originalText;
              } else {
                downloadButton.innerHTML = "⬇ Scarica"; // Testo di default
              }
            }
          }

          // --- FUNZIONI API SIMULATE (per test senza backend) ---

          /** @param {string} offertaId @param {string} email */
          // async function simulateApi_emettiPolizza(offertaId, email) {
          //   debugInfo(
          //     `SIMULAZIONE: Chiamata emettiPolizza con ID: ${offertaId}, Email: ${email}`
          //   );
          //   await new Promise((resolve) => setTimeout(resolve, 1500)); // Simula attesa

          //   // Simula successo o errore
          //   if (
          //     offertaId &&
          //     email &&
          //     offertaId.startsWith("REQ-") &&
          //     email.includes("@")
          //   ) {
          //     // Simula successo
          //     const policyNum =
          //       "SLP-" + Math.random().toString(10).substring(2, 8);
          //     return {
          //       status: "ok",
          //       policy_number: policyNum,
          //       document_pointers: [
          //         {
          //           description: "Certificato di Polizza",
          //           document_id: "DOC001",
          //           pointer: "PTR_" + policyNum + "_CERT",
          //         },
          //         {
          //           description: "Condizioni Generali",
          //           document_id: "DOC002",
          //           pointer: "PTR_CGA_V1",
          //         },
          //         {
          //           description: "Informativa Privacy",
          //           document_id: "DOC003",
          //           pointer: "PTR_PRIVACY_V2",
          //         },
          //       ],
          //     };
          //   } else {
          //     // Simula errore
          //     return {
          //       status: "error",
          //       error: [
          //         { error: "ID Offerta non valido, scaduto o già utilizzato." },
          //       ],
          //     };
          //   }
          // }

          /** @param {string} policyNumber @param {string} paymentMethod */
          async function simulateApi_confermaPagamento(
            policyNumber,
            paymentMethod
          ) {
            debugInfo(
              `SIMULAZIONE: Chiamata confermaPagamento per ${policyNumber}, Metodo: ${paymentMethod}`
            );
            await new Promise((resolve) => setTimeout(resolve, 2000)); // Simula attesa

            // Simula sempre successo per ora
            return { status: "ok" };
            // Per simulare errore: return { status: "error", error: [{ error: "Errore durante la conferma del pagamento." }] };
          }

          /** @param {string} pointer */
          async function simulateApi_recuperaDocumento(pointer) {
            debugInfo(
              `SIMULAZIONE: Chiamata recuperaDocumento per pointer: ${pointer}`
            );
            await new Promise((resolve) => setTimeout(resolve, 1000)); // Simula attesa

            // Simula la creazione di un file Blob PDF
            try {
              // Libreria jsPDF richiesta per creare un vero PDF (includere via CDN se si vuole testare)
              // if (typeof jsPDF !== 'undefined') {
              //     const { jsPDF } = window.jspdf;
              //     const doc = new jsPDF();
              //     doc.text(`Documento Simulato per Pointer: ${pointer}`, 10, 10);
              //     doc.text(`Questo è un PDF generato al volo per test.`, 10, 20);
              //     doc.text(`Data: ${new Date().toLocaleString()}`, 10, 30);
              //     return doc.output('blob');
              // } else {
              //     // Fallback a file di testo se jsPDF non è caricata
              //     const textContent = `Contenuto Simulato (Testo)\nPointer: ${pointer}\nData: ${new Date().toLocaleString()}`;
              //     return new Blob([textContent], { type: 'text/plain' });
              // }

              // Simulazione semplice con file di testo
              const textContent = `Contenuto Simulato (Testo)\nPointer: ${pointer}\nData: ${new Date().toLocaleString()}`;
              return new Blob([textContent], { type: "text/plain" });
            } catch (error) {
              debugInfo(
                `Errore nella simulazione recuperaDocumento: ${error.message}`
              );
              throw error; // Rilancia l'errore
            }
          }

          // --- AGGIUNTA EVENT LISTENERS ---

          function addEventListeners() {
            verificaBtn?.addEventListener("click", handleOfferVerification);
            indietroRiepilogoBtn?.addEventListener("click", () => goToStep(0));
            procediBtn?.addEventListener("click", handleProceedToPayment);
            indietroPagamentoBtn?.addEventListener("click", () => goToStep(1));
            confermaPagamentoBtn?.addEventListener(
              "click",
              handlePaymentConfirmation
            );
            riprovaBtn?.addEventListener("click", () => goToStep(0)); // Torna al primo step in caso di errore

            // Mostra/Nascondi dettagli pagamento
            metodoPagamentoSelect?.addEventListener("change", () => {
              const metodo = metodoPagamentoSelect.value;
              toggleElement(datiEbillDiv, metodo === "e-bill");
              toggleElement(datiBonificoDiv, metodo === "bonifico");
            });

            // Link modali
            condizioniLink?.addEventListener("click", (e) => {
              e.preventDefault();
              showModal(
                "Condizioni Generali di Assicurazione (Simulato)",
                `
                <p>Le presenti Condizioni Generali di Assicurazione (CGA) regolano il rapporto contrattuale tra il Contraente e Squarelife LTD.</p>
                <h6>Art. 1 Oggetto del Contratto</h6>
                <p>L'Assicuratore si impegna a pagare il capitale assicurato ai Beneficiari designati in caso di decesso dell'Assicurato durante il periodo di validità del contratto, a fronte del pagamento dei premi da parte del Contraente.</p>
                <h6>Art. 2 Obblighi del Contraente</h6>
                <p>Il Contraente è tenuto a pagare i premi alle scadenze convenute e a fornire informazioni veritiere e complete all'Assicuratore...</p>
                <p><i>(Questo è un testo simulato. Fare riferimento ai documenti ufficiali.)</i></p>
              `
              );
            });
            privacyLink?.addEventListener("click", (e) => {
              e.preventDefault();
              showModal(
                "Informativa sulla Privacy (Simulato)",
                `
                <p>Squarelife LTD tratta i dati personali nel rispetto della normativa vigente sulla protezione dei dati (LPD e GDPR ove applicabile).</p>
                <h6>Finalità del Trattamento</h6>
                <p>I dati sono raccolti e trattati per finalità strettamente connesse alla stipula e gestione del contratto assicurativo, valutazione del rischio, liquidazione dei sinistri, adempimenti legali e prevenzione frodi.</p>
                <h6>Diritti dell'Interessato</h6>
                <p>L'interessato ha diritto di accesso, rettifica, cancellazione, limitazione del trattamento, portabilità dei dati e opposizione...</p>
                 <p><i>(Questo è un testo simulato. Fare riferimento all'informativa completa.)</i></p>
              `
              );
            });

            // Chiusura modal
            modalCloseBtn?.addEventListener("click", closeModal);
            modalConfirmBtn?.addEventListener("click", closeModal);
            overlay?.addEventListener("click", (e) => {
              if (e.target === overlay) closeModal(); // Chiudi cliccando fuori dal modal
            });
          }

          // --- INIZIALIZZAZIONE MODULO ---

          function initializeModule() {
            safeLog("Initializing emission module...");
            checkSessionStorage(); // Verifica disponibilità sessionStorage

            // Pre-compila campi da sessionStorage se disponibili
            if (sessionStorageAvailable) {
              const savedOfferId = sessionStorage.getItem("reference-number"); // Assicurati che la chiave sia corretta
              const datiUtente = getSessionData("datiUtente");

              if (savedOfferId) {
                offertaIdInput.value = savedOfferId;
                debugInfo(`ID Offerta pre-compilato: ${savedOfferId}`);
              }
              if (datiUtente && datiUtente.email) {
                emailConfermaInput.value = datiUtente.email;
                debugInfo(`Email pre-compilata: ${datiUtente.email}`);
              }
            }

            addEventListeners(); // Aggiungi listener ai bottoni e link
            goToStep(0); // Assicura che si parta sempre dal primo step
            safeLog("Emission module initialized successfully.");
          }

          // Esegui l'inizializzazione quando il DOM è pronto
          if (document.readyState === "loading") {
            document.addEventListener("DOMContentLoaded", initializeModule);
          } else {
            initializeModule(); // Esegui subito se già caricato
          }
        })(); // Fine scope isolato
      </script>
    </div>
    <!-- Fine custom-html-3u -->

    <!-- Script JS esistenti del tema -->
    <script src="https://r.mobirisesite.com/1342903/assets/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script src="https://r.mobirisesite.com/1342903/assets/smoothscroll/smooth-scroll.js"></script>
    <script src="https://r.mobirisesite.com/1342903/assets/ytplayer/index.js"></script>
    <script src="https://r.mobirisesite.com/1342903/assets/dropdown/js/navbar-dropdown.js"></script>
    <script src="https://r.mobirisesite.com/1342903/assets/theme/js/script.js"></script>

    <!-- Script API Handler (ASSICURATI CHE ESISTANO E SIANO CORRETTI) -->
    <!-- <script src="https://r.mobirisesite.com/1342903/assets/js/api-handler.js"></script> -->
    <!-- <script src="assets/api-handlerSerhii.js"></script> -->
    <!-- Nota: Le funzioni API simulate sono ora DENTRO lo script principale per test standalone -->
    <!-- Rimuovi le funzioni simulate se usi i file esterni reali -->

    <!-- Script per Lazy Loading immagini (esistente) -->
    <script>
      "use strict";
      // Codice lazy loading esistente...
      if ("loading" in HTMLImageElement.prototype) {
        document.querySelectorAll('img[loading="lazy"]').forEach((e) => {
          if (e.dataset.src) e.src = e.dataset.src;
          // ... resto del codice lazy loading ...
        });
      } else {
        // Fallback lazy loading
      }
    </script>
  </body>
</html>
