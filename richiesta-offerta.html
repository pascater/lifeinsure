<!DOCTYPE html>
<html lang="it">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, minimum-scale=1"
    />
    <title>Richiesta Offerta Polizza Vita</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css"
    />
    <style>
      .form-section {
        display: none;
      }
      .form-section.active {
        display: block;
      }
      .progress {
        height: 8px;
        margin-bottom: 30px;
      }
      .step-indicator {
        display: flex;
        justify-content: space-between;
        margin-bottom: 20px;
      }
      .step {
        text-align: center;
        flex: 1;
        position: relative;
      }
      .step-number {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        background-color: #dee2e6;
        color: #6c757d;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 5px;
        font-weight: bold;
      }
      .step.active .step-number {
        background-color: #0d6efd;
        color: white;
      }
      .step.completed .step-number {
        background-color: #198754;
        color: white;
      }
      .step-title {
        font-size: 0.8rem;
        color: #6c757d;
      }
      .step.active .step-title {
        color: #0d6efd;
        font-weight: bold;
      }
      .step.completed .step-title {
        color: #198754;
      }
      .required-field::after {
        content: "*";
        color: red;
        margin-left: 4px;
      }
      .subtitle {
        background-color: #f8f9fa;
        padding: 10px 15px;
        margin: 20px 0 15px;
        border-left: 4px solid #0d6efd;
        font-size: 1.1rem;
      }
      .info-icon {
        color: #6c757d;
        cursor: pointer;
        margin-left: 5px;
      }
      /* Stili per errori di validazione */
      .is-invalid {
        border-color: #dc3545 !important; /* Usa !important per sovrascrivere stili specifici */
      }
      .invalid-feedback {
        display: none;
        color: #dc3545;
        font-size: 0.875em;
        margin-top: 0.25rem;
      }
      /* Mostra feedback quando l'input � invalido e il form � stato validato */
      .was-validated .form-control:invalid,
      .was-validated .form-select:invalid,
      .was-validated .form-check-input:invalid {
        border-color: #dc3545;
      }
      .was-validated .form-control:invalid ~ .invalid-feedback,
      .was-validated .form-select:invalid ~ .invalid-feedback,
      .was-validated .form-check-input:invalid ~ .invalid-feedback {
        display: block;
      }
      /* Stili specifici per errori radio/checkbox */
      .radio-group-invalid .form-check-label {
        color: #dc3545;
      }
      .radio-group-invalid .invalid-feedback {
        display: block !important; /* Assicura visibilit� */
      }

      .conditional-field {
        margin-top: 1rem;
        padding: 1rem;
        border-left: 3px solid #0d6efd;
        background-color: #f8f9fa;
      }
      @media (max-width: 767px) {
        .step-title {
          display: none;
        }
      }
      .thank-you-message {
        display: none;
        text-align: center;
        padding: 30px 0;
      }
      .thank-you-message.active {
        display: block;
      }
      .beneficiary-container {
        background-color: rgba(13, 110, 253, 0.05);
        padding: 15px;
        margin-bottom: 15px;
        border-radius: 4px;
        border: 1px solid #dee2e6;
      }
      /* Stili aggiunti per la visualizzazione dei documenti */
      .document-list {
        margin: 25px 0;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        overflow: hidden;
      }
      .document-item {
        padding: 15px;
        border-bottom: 1px solid #dee2e6;
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        background-color: #fff;
        transition: background-color 0.3s;
      }
      .document-item:last-child {
        border-bottom: none;
      }
      .document-item:hover {
        background-color: #f8f9fa;
      }
      .document-icon {
        font-size: 24px;
        margin-right: 15px;
        color: #0d6efd;
      }
      .document-details {
        flex-grow: 1;
      }
      .document-title {
        font-weight: 500;
        font-size: 1.1rem;
        margin-bottom: 3px;
      }
      .document-description {
        color: #6c757d;
        font-size: 0.9rem;
        margin-bottom: 0;
      }
      .document-actions {
        display: flex;
        gap: 10px;
        margin-left: auto;
        margin-right: auto;
      }
      .badge-document {
        font-size: 0.75rem;
        padding: 5px 8px;
        margin-top: 5px;
        display: inline-block;
      }
      .document-content-modal {
        /* max-height: 500px; */
        overflow-y: auto;
        padding: 20px;
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 6px;
        margin: 15px 0;
        font-size: 0.9rem;
      }
      .proceed-btn {
        transition: all 0.3s;
      }
      .proceed-btn.disabled {
        position: relative;
        cursor: not-allowed;
        opacity: 0.65; /* Rendi pi� evidente che � disabilitato */
      }
      .proceed-btn.disabled .proceed-lock {
        margin-right: 5px;
      }
      .download-progress {
        margin: 15px 0;
        height: 10px;
      }
      .pulse-animation {
        animation: pulse 1.5s infinite;
      }
      @keyframes pulse {
        0% {
          box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7);
        }
        70% {
          box-shadow: 0 0 0 10px rgba(40, 167, 69, 0);
        }
        100% {
          box-shadow: 0 0 0 0 rgba(40, 167, 69, 0);
        }
      }
      .status-message {
        font-size: 0.9rem;
        color: #6c757d;
        margin-top: 10px;
        text-align: center;
      }
      .highlight-text {
        color: #0d6efd;
        font-weight: bold;
      }
      /* Stile per fieldset */
      fieldset {
        border: none; /* Rimuove bordo di default */
        padding: 0;
        margin: 0 0 1rem 0; /* Aggiunge spazio sotto */
      }
      legend {
        font-size: 1rem; /* Dimensione standard label */
        font-weight: normal; /* Rimuove grassetto di default */
        margin-bottom: 0.5rem;
        float: none; /* Impedisce float strano */
        width: auto; /* Impedisce larghezza 100% */
        padding: 0;
      }
      /* Assicura che la legenda sia visibile agli screen reader */
      legend.visually-hidden {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border: 0;
      }
    </style>
  </head>
  <body>
    <div class="container py-5">
      <div class="row justify-content-center">
        <div class="col-lg-8">
          <div class="card shadow">
            <div class="card-header bg-primary text-white">
              <h4 class="mb-0">Richiesta Offerta Polizza Vita</h4>
            </div>
            <div class="card-body">
              <!-- Indicatore progressione -->
              <div class="step-indicator mb-4">
                <div class="step active" id="step-1">
                  <div class="step-number">1</div>
                  <div class="step-title">Dati personali</div>
                </div>
                <div class="step" id="step-2">
                  <div class="step-number">2</div>
                  <div class="step-title">Questionario medico</div>
                </div>
                <div class="step" id="step-3">
                  <div class="step-number">3</div>
                  <div class="step-title">Beneficiari e conferma</div>
                </div>
              </div>
              <div id="alert-placeholder"></div>
              <div class="progress">
                <div
                  class="progress-bar"
                  role="progressbar"
                  style="width: 33%"
                  aria-valuenow="33"
                  aria-valuemin="0"
                  aria-valuemax="100"
                ></div>
              </div>

              <form id="offer-request-form" novalidate>
                <!-- STEP 1: Dati personali -->
                <div class="form-section active" id="section-1">
                  <div class="subtitle">Dati personali</div>

                  <div class="row mb-3">
                    <div class="col-md-6">
                      <label for="firstname" class="form-label required-field"
                        >Nome</label
                      >
                      <input
                        type="text"
                        class="form-control"
                        id="firstname"
                        name="firstname"
                        required
                      />
                      <div class="invalid-feedback">Inserisci il tuo nome</div>
                    </div>
                    <div class="col-md-6">
                      <label for="lastname" class="form-label required-field"
                        >Cognome</label
                      >
                      <input
                        type="text"
                        class="form-control"
                        id="lastname"
                        name="lastname"
                        required
                      />
                      <div class="invalid-feedback">
                        Inserisci il tuo cognome
                      </div>
                    </div>
                  </div>

                  <div class="row mb-3">
                    <div class="col-md-6">
                      <label for="gender" class="form-label required-field"
                        >Genere</label
                      >
                      <select
                        class="form-select"
                        id="gender"
                        name="gender"
                        required
                      >
                        <option value="" selected disabled>Seleziona...</option>
                        <option value="M">Maschile</option>
                        <option value="F">Femminile</option>
                      </select>
                      <div class="invalid-feedback">
                        Seleziona il tuo genere
                      </div>
                    </div>
                    <div class="col-md-6">
                      <label for="birthdate" class="form-label required-field"
                        >Data di nascita</label
                      >
                      <input
                        type="date"
                        class="form-control"
                        id="birthdate"
                        name="birthdate"
                        required
                      />
                      <div class="invalid-feedback">
                        Inserisci la tua data di nascita
                      </div>
                    </div>
                  </div>

                  <div class="mb-3">
                    <label for="street" class="form-label required-field"
                      >Indirizzo</label
                    >
                    <input
                      type="text"
                      class="form-control"
                      id="street"
                      name="street"
                      required
                    />
                    <div class="invalid-feedback">
                      Inserisci il tuo indirizzo
                    </div>
                  </div>

                  <div class="row mb-3">
                    <div class="col-md-4">
                      <label for="zip" class="form-label required-field"
                        >CAP</label
                      >
                      <input
                        type="text"
                        class="form-control"
                        id="zip"
                        name="zip"
                        required
                        pattern="\d{4}"
                      />
                      <!-- Pattern base per CAP svizzero -->
                      <div class="invalid-feedback">
                        Inserisci un CAP svizzero valido (4 cifre)
                      </div>
                    </div>
                    <div class="col-md-4">
                      <label for="city" class="form-label required-field"
                        >Citt&agrave;</label
                      >
                      <input
                        type="text"
                        class="form-control"
                        id="city"
                        name="city"
                        required
                      />
                      <div class="invalid-feedback">
                        Inserisci la tua citt&agrave;
                      </div>
                    </div>
                    <div class="col-md-4">
                      <label for="country" class="form-label required-field"
                        >Paese</label
                      >
                      <div class="input-group">
                        <input
                          type="text"
                          class="form-control"
                          id="country"
                          name="country"
                          value="Svizzera"
                          readonly
                        />
                        <input type="hidden" name="country_code" value="CH" />
                        <span class="input-group-text"
                          ><i class="bi bi-flag"></i
                        ></span>
                      </div>
                      <small class="text-muted"
                        >Solo residenti in Svizzera</small
                      >
                    </div>
                  </div>

                  <div class="row mb-3">
                    <div class="col-md-6">
                      <label for="email" class="form-label required-field"
                        >Email</label
                      >
                      <!-- Aggiunto pattern per validazione email pi� robusta -->
                      <input
                        type="email"
                        class="form-control"
                        id="email"
                        name="email"
                        required
                        pattern="[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,}$"
                      />
                      <div class="invalid-feedback">
                        Inserisci un indirizzo email valido
                      </div>
                    </div>
                    <div class="col-md-6">
                      <label for="phone" class="form-label required-field"
                        >Telefono</label
                      >
                      <input
                        type="tel"
                        class="form-control"
                        id="phone"
                        name="phone"
                        required
                      />
                      <!-- pattern="[+]*[(]{0,1}[0-9]{1,4}[)]{0,1}[-\s\./0-9]*" -->
                      <div class="invalid-feedback">
                        Inserisci un numero di telefono valido
                      </div>
                    </div>
                  </div>

                  <div class="row mb-3">
                    <div class="col-md-6">
                      <label for="nationality" class="form-label required-field"
                        >Nazionalit&agrave;</label
                      >
                      <select
                        class="form-select"
                        id="nationality"
                        name="nationality"
                        required
                      >
                        <option value="CH" selected>Svizzera</option>
                        <option value="IT">Italiana</option>
                        <option value="DE">Tedesca</option>
                        <option value="FR">Francese</option>
                        <option value="AT">Austriaca</option>
                        <!-- Aggiungere altre nazionalit� se necessario -->
                      </select>
                      <div class="invalid-feedback">
                        Seleziona la tua nazionalit&agrave;
                      </div>
                    </div>
                    <div class="col-md-6">
                      <label for="profession" class="form-label required-field"
                        >Professione</label
                      >
                      <input
                        type="text"
                        class="form-control"
                        id="profession"
                        name="profession"
                        required
                      />
                      <div class="invalid-feedback">
                        Inserisci la tua professione
                      </div>
                    </div>
                  </div>

                  <div class="subtitle">Dettagli polizza</div>

                  <div class="row mb-3">
                    <div class="col-md-6">
                      <label for="duration" class="form-label required-field"
                        >Durata (anni)</label
                      >
                      <input
                        type="number"
                        class="form-control"
                        id="duration"
                        name="duration"
                        min="1"
                        max="40"
                        value="10"
                        required
                      />
                      <div class="invalid-feedback">
                        Inserisci la durata in anni (minimo 1, massimo 40)
                      </div>
                    </div>
                    <div class="col-md-6">
                      <label for="coverage" class="form-label required-field"
                        >Copertura (CHF)</label
                      >
                      <input
                        type="number"
                        class="form-control"
                        id="coverage"
                        name="coverage"
                        min="50000"
                        max="1000000"
                        step="10000"
                        value="100000"
                        required
                      />
                      <div class="invalid-feedback">
                        Inserisci un importo di copertura valido (min 50'000,
                        max 1'000'000)
                      </div>
                    </div>
                  </div>

                  <div class="row mb-3">
                    <div class="col-md-6">
                      <label for="mode" class="form-label required-field"
                        >Modalit&agrave; di pagamento</label
                      >
                      <select
                        class="form-select"
                        id="mode"
                        name="mode"
                        required
                      >
                        <option value="annual" selected>Annuale</option>
                        <option value="monthly">Mensile</option>
                      </select>
                      <div class="invalid-feedback">
                        Seleziona la modalit&agrave; di pagamento
                      </div>
                    </div>
                    <div class="col-md-6">
                      <label
                        for="payment_type"
                        class="form-label required-field"
                        >Tipo di pagamento</label
                      >
                      <select
                        class="form-select"
                        id="payment_type"
                        name="payment_type"
                        required
                      >
                        <option value="invoice_esr" selected>E-Bill</option>
                        <option value="manual">Fattura con QR code</option>
                      </select>
                      <div class="invalid-feedback">
                        Seleziona il tipo di pagamento
                      </div>
                    </div>
                  </div>

                  <div class="d-flex justify-content-end mt-4">
                    <button type="button" id="next-1" class="btn btn-primary">
                      Avanti <i class="bi bi-arrow-right"></i>
                    </button>
                  </div>
                </div>

                <!-- STEP 2: Questionario medico -->
                <div class="form-section" id="section-2">
                  <div class="subtitle">Informazioni di salute</div>

                  <div class="row mb-3">
                    <div class="col-md-6">
                      <label for="height" class="form-label required-field"
                        >Altezza (cm)</label
                      >
                      <input
                        type="number"
                        class="form-control"
                        id="height"
                        name="height"
                        min="100"
                        max="250"
                        required
                      />
                      <div class="invalid-feedback">
                        Inserisci un'altezza valida (tra 100 e 250 cm)
                      </div>
                    </div>
                    <div class="col-md-6">
                      <label for="weight" class="form-label required-field"
                        >Peso (kg)</label
                      >
                      <input
                        type="number"
                        class="form-control"
                        id="weight"
                        name="weight"
                        min="30"
                        max="200"
                        required
                      />
                      <div class="invalid-feedback">
                        Inserisci un peso valido (tra 30 e 200 kg)
                      </div>
                    </div>
                  </div>

                  <!-- Uso di fieldset/legend per accessibilit� gruppi radio -->
                  <fieldset class="mb-3">
                    <legend
                      class="form-label required-field"
                      id="smoker_legend"
                    >
                      Negli ultimi 2 anni hai fumato regolarmente o
                      occasionalmente sigarette, sigari, pipa o sigarette
                      elettroniche?
                    </legend>
                    <div class="form-check">
                      <input
                        class="form-check-input"
                        type="radio"
                        id="smoker_yes"
                        name="smoker"
                        value="yes"
                        required
                      />
                      <label class="form-check-label" for="smoker_yes"
                        >S&igrave;</label
                      >
                    </div>
                    <div class="form-check">
                      <input
                        class="form-check-input"
                        type="radio"
                        id="smoker_no"
                        name="smoker"
                        value="no"
                        required
                      />
                      <label class="form-check-label" for="smoker_no">No</label>
                    </div>
                    <div class="invalid-feedback">Seleziona una risposta</div>
                    <!-- Feedback per il gruppo -->
                  </fieldset>

                  <fieldset class="mb-3">
                    <legend
                      class="form-label required-field"
                      id="existing_insurance_legend"
                    >
                      Hai gi&agrave; altre assicurazioni sulla vita puro rischio
                      decesso?
                    </legend>
                    <div class="form-check">
                      <input
                        class="form-check-input"
                        type="radio"
                        id="existing_insurance_yes"
                        name="existing_insurance"
                        value="yes"
                        required
                      />
                      <label
                        class="form-check-label"
                        for="existing_insurance_yes"
                        >S&igrave;</label
                      >
                    </div>
                    <div class="form-check">
                      <input
                        class="form-check-input"
                        type="radio"
                        id="existing_insurance_no"
                        name="existing_insurance"
                        value="no"
                        required
                      />
                      <label
                        class="form-check-label"
                        for="existing_insurance_no"
                        >No</label
                      >
                    </div>
                    <div class="invalid-feedback">Seleziona una risposta</div>

                    <div
                      id="existing_insurance_details"
                      class="conditional-field d-none mt-2"
                    >
                      <label
                        for="existing_coverage"
                        id="existing_coverage_label"
                        class="form-label required-field"
                        >Copertura totale esistente (CHF)</label
                      >
                      <input
                        type="number"
                        class="form-control"
                        id="existing_coverage"
                        name="existing_coverage"
                        min="0"
                      />
                      <div class="invalid-feedback">
                        Inserisci la copertura esistente (o 0).
                      </div>
                    </div>
                  </fieldset>

                  <fieldset class="mb-3">
                    <legend
                      class="form-label required-field"
                      id="medication_legend"
                    >
                      Hai assunto o ti sono stati prescritti farmaci per
                      pi&ugrave; di 4 settimane consecutive negli ultimi 5 anni?
                    </legend>
                    <div class="form-check">
                      <input
                        class="form-check-input"
                        type="radio"
                        id="medication_yes"
                        name="medication"
                        value="yes"
                        required
                      />
                      <label class="form-check-label" for="medication_yes"
                        >S&igrave;</label
                      >
                    </div>
                    <div class="form-check">
                      <input
                        class="form-check-input"
                        type="radio"
                        id="medication_no"
                        name="medication"
                        value="no"
                        required
                      />
                      <label class="form-check-label" for="medication_no"
                        >No</label
                      >
                    </div>
                    <div class="invalid-feedback">Seleziona una risposta</div>

                    <div
                      id="medication_details"
                      class="conditional-field d-none mt-2"
                    >
                      <fieldset class="mb-2">
                        <legend
                          class="form-label required-field"
                          id="medication_resolved_legend"
                        >
                          La malattia sottostante &egrave; guarita senza
                          conseguenze da almeno 2 anni?
                        </legend>
                        <div class="form-check">
                          <input
                            class="form-check-input"
                            type="radio"
                            id="medication_resolved_yes"
                            name="medication_resolved"
                            value="yes"
                          />
                          <label
                            class="form-check-label"
                            for="medication_resolved_yes"
                            >S&igrave;</label
                          >
                        </div>
                        <div class="form-check">
                          <input
                            class="form-check-input"
                            type="radio"
                            id="medication_resolved_no"
                            name="medication_resolved"
                            value="no"
                          />
                          <label
                            class="form-check-label"
                            for="medication_resolved_no"
                            >No</label
                          >
                        </div>
                        <div class="invalid-feedback">
                          Seleziona una risposta
                        </div>
                      </fieldset>
                      <div>
                        <label for="medication_description" class="form-label"
                          >Descrizione (obbligatoria se hai risposto S� alla
                          domanda principale):</label
                        >
                        <textarea
                          class="form-control"
                          id="medication_description"
                          name="medication_description"
                          rows="2"
                        ></textarea>
                        <div class="invalid-feedback">
                          Fornisci una descrizione.
                        </div>
                      </div>
                    </div>
                  </fieldset>

                  <fieldset class="mb-3">
                    <legend
                      class="form-label required-field"
                      id="hypertension_legend"
                    >
                      Negli ultimi 5 anni hai avuto l'ipertensione?
                    </legend>
                    <div class="form-check">
                      <input
                        class="form-check-input"
                        type="radio"
                        id="hypertension_yes"
                        name="hypertension"
                        value="yes"
                        required
                      />
                      <label class="form-check-label" for="hypertension_yes"
                        >S&igrave;</label
                      >
                    </div>
                    <div class="form-check">
                      <input
                        class="form-check-input"
                        type="radio"
                        id="hypertension_no"
                        name="hypertension"
                        value="no"
                        required
                      />
                      <label class="form-check-label" for="hypertension_no"
                        >No</label
                      >
                    </div>
                    <div class="invalid-feedback">Seleziona una risposta</div>
                  </fieldset>

                  <fieldset class="mb-3">
                    <legend
                      class="form-label required-field"
                      id="hospitalization_legend"
                    >
                      Sei stato ricoverato in ospedale negli ultimi 10 anni?
                    </legend>
                    <div class="form-check">
                      <input
                        class="form-check-input"
                        type="radio"
                        id="hospitalization_yes"
                        name="hospitalization"
                        value="yes"
                        required
                      />
                      <label class="form-check-label" for="hospitalization_yes"
                        >S&igrave;</label
                      >
                    </div>
                    <div class="form-check">
                      <input
                        class="form-check-input"
                        type="radio"
                        id="hospitalization_no"
                        name="hospitalization"
                        value="no"
                        required
                      />
                      <label class="form-check-label" for="hospitalization_no"
                        >No</label
                      >
                    </div>
                    <div class="invalid-feedback">Seleziona una risposta</div>

                    <div
                      id="hospitalization_details"
                      class="conditional-field d-none mt-2"
                    >
                      <fieldset>
                        <legend
                          class="form-label required-field"
                          id="hospitalization_resolved_legend"
                        >
                          La malattia sottostante &egrave; guarita senza
                          conseguenze da almeno 2 anni?
                        </legend>
                        <div class="form-check">
                          <input
                            class="form-check-input"
                            type="radio"
                            id="hospitalization_resolved_yes"
                            name="hospitalization_resolved"
                            value="yes"
                          />
                          <label
                            class="form-check-label"
                            for="hospitalization_resolved_yes"
                            >S&igrave;</label
                          >
                        </div>
                        <div class="form-check">
                          <input
                            class="form-check-input"
                            type="radio"
                            id="hospitalization_resolved_no"
                            name="hospitalization_resolved"
                            value="no"
                          />
                          <label
                            class="form-check-label"
                            for="hospitalization_resolved_no"
                            >No</label
                          >
                        </div>
                        <div class="invalid-feedback">
                          Seleziona una risposta
                        </div>
                      </fieldset>
                    </div>
                  </fieldset>

                  <fieldset class="mb-3">
                    <legend
                      class="form-label required-field"
                      id="planned_exam_legend"
                    >
                      &Egrave; attualmente pianificato un esame (ECG, esami di
                      laboratorio, ecografia, RMT, ecc.)?
                    </legend>
                    <div class="form-check">
                      <input
                        class="form-check-input"
                        type="radio"
                        id="planned_exam_yes"
                        name="planned_exam"
                        value="yes"
                        required
                      />
                      <label class="form-check-label" for="planned_exam_yes"
                        >S&igrave;</label
                      >
                    </div>
                    <div class="form-check">
                      <input
                        class="form-check-input"
                        type="radio"
                        id="planned_exam_no"
                        name="planned_exam"
                        value="no"
                        required
                      />
                      <label class="form-check-label" for="planned_exam_no"
                        >No</label
                      >
                    </div>
                    <div class="invalid-feedback">Seleziona una risposta</div>
                  </fieldset>

                  <fieldset class="mb-3">
                    <legend class="form-label required-field" id="drugs_legend">
                      Negli ultimi 5 anni hai assunto stupefacenti o droghe o
                      sei stato consigliato o trattato per questo?
                    </legend>
                    <div class="form-check">
                      <input
                        class="form-check-input"
                        type="radio"
                        id="drugs_yes"
                        name="drugs"
                        value="yes"
                        required
                      />
                      <label class="form-check-label" for="drugs_yes"
                        >S&igrave;</label
                      >
                    </div>
                    <div class="form-check">
                      <input
                        class="form-check-input"
                        type="radio"
                        id="drugs_no"
                        name="drugs"
                        value="no"
                        required
                      />
                      <label class="form-check-label" for="drugs_no">No</label>
                    </div>
                    <div class="invalid-feedback">Seleziona una risposta</div>
                  </fieldset>

                  <fieldset class="mb-3">
                    <legend class="form-label required-field" id="hiv_legend">
                      Ti &egrave; mai stata diagnosticata un'infezione da HIV
                      (test AIDS positivo) o sei in attesa del risultato?
                    </legend>
                    <div class="form-check">
                      <input
                        class="form-check-input"
                        type="radio"
                        id="hiv_yes"
                        name="hiv"
                        value="yes"
                        required
                      />
                      <label class="form-check-label" for="hiv_yes"
                        >S&igrave;</label
                      >
                    </div>
                    <div class="form-check">
                      <input
                        class="form-check-input"
                        type="radio"
                        id="hiv_no"
                        name="hiv"
                        value="no"
                        required
                      />
                      <label class="form-check-label" for="hiv_no">No</label>
                    </div>
                    <div class="invalid-feedback">Seleziona una risposta</div>
                  </fieldset>

                  <fieldset class="mb-3">
                    <legend
                      class="form-label required-field"
                      id="foreign_stay_legend"
                    >
                      Prevedi un soggiorno all'estero di durata superiore a 6
                      settimane nei prossimi 12 mesi? (Al di fuori di UE,
                      Svizzera, Islanda, Norvegia, USA, Canada)
                    </legend>
                    <div class="form-check">
                      <input
                        class="form-check-input"
                        type="radio"
                        id="foreign_stay_yes"
                        name="foreign_stay"
                        value="yes"
                        required
                      />
                      <label class="form-check-label" for="foreign_stay_yes"
                        >S&igrave;</label
                      >
                    </div>
                    <div class="form-check">
                      <input
                        class="form-check-input"
                        type="radio"
                        id="foreign_stay_no"
                        name="foreign_stay"
                        value="no"
                        required
                      />
                      <label class="form-check-label" for="foreign_stay_no"
                        >No</label
                      >
                    </div>
                    <div class="invalid-feedback">Seleziona una risposta</div>
                  </fieldset>

                  <fieldset class="mb-3">
                    <legend
                      class="form-label required-field"
                      id="dangerous_hobby_legend"
                    >
                      Sei esposto a pericoli particolari nel lavoro o nel tempo
                      libero? (es. manipolazione di esplosivi o armi, protezione
                      personale, soggiorno in zone di crisi, gare
                      automobilistiche, sport aerei, alpinismo, arrampicata,
                      arti marziali, sport estremi, immersioni)
                    </legend>
                    <div class="form-check">
                      <input
                        class="form-check-input"
                        type="radio"
                        id="dangerous_hobby_yes"
                        name="dangerous_hobby"
                        value="yes"
                        required
                      />
                      <label class="form-check-label" for="dangerous_hobby_yes"
                        >S&igrave;</label
                      >
                    </div>
                    <div class="form-check">
                      <input
                        class="form-check-input"
                        type="radio"
                        id="dangerous_hobby_no"
                        name="dangerous_hobby"
                        value="no"
                        required
                      />
                      <label class="form-check-label" for="dangerous_hobby_no"
                        >No</label
                      >
                    </div>
                    <div class="invalid-feedback">Seleziona una risposta</div>
                  </fieldset>

                  <fieldset class="mb-3">
                    <legend
                      class="form-label required-field"
                      id="pension_legend"
                    >
                      Ricevi una pensione o un'indennit&agrave; giornaliera
                      dall'assicurazione invalidit&agrave; o da un'assicurazione
                      infortuni?
                    </legend>
                    <div class="form-check">
                      <input
                        class="form-check-input"
                        type="radio"
                        id="pension_yes"
                        name="pension"
                        value="yes"
                        required
                      />
                      <label class="form-check-label" for="pension_yes"
                        >S&igrave;</label
                      >
                    </div>
                    <div class="form-check">
                      <input
                        class="form-check-input"
                        type="radio"
                        id="pension_no"
                        name="pension"
                        value="no"
                        required
                      />
                      <label class="form-check-label" for="pension_no"
                        >No</label
                      >
                    </div>
                    <div class="invalid-feedback">Seleziona una risposta</div>
                  </fieldset>

                  <fieldset class="mb-3">
                    <legend
                      class="form-label required-field"
                      id="work_absence_legend"
                    >
                      Negli ultimi 5 anni, hai avuto assenze dal lavoro di oltre
                      un mese per malattia?
                    </legend>
                    <div class="form-check">
                      <input
                        class="form-check-input"
                        type="radio"
                        id="work_absence_yes"
                        name="work_absence"
                        value="yes"
                        required
                      />
                      <label class="form-check-label" for="work_absence_yes"
                        >S&igrave;</label
                      >
                    </div>
                    <div class="form-check">
                      <input
                        class="form-check-input"
                        type="radio"
                        id="work_absence_no"
                        name="work_absence"
                        value="no"
                        required
                      />
                      <label class="form-check-label" for="work_absence_no"
                        >No</label
                      >
                    </div>
                    <div class="invalid-feedback">Seleziona una risposta</div>

                    <div
                      id="work_absence_details"
                      class="conditional-field d-none mt-2"
                    >
                      <fieldset>
                        <legend
                          class="form-label required-field"
                          id="work_absence_resolved_legend"
                        >
                          La condizione &egrave; risolta da almeno 2 anni senza
                          trattamenti?
                        </legend>
                        <div class="form-check">
                          <input
                            class="form-check-input"
                            type="radio"
                            id="work_absence_resolved_yes"
                            name="work_absence_resolved"
                            value="yes"
                          />
                          <label
                            class="form-check-label"
                            for="work_absence_resolved_yes"
                            >S&igrave;</label
                          >
                        </div>
                        <div class="form-check">
                          <input
                            class="form-check-input"
                            type="radio"
                            id="work_absence_resolved_no"
                            name="work_absence_resolved"
                            value="no"
                          />
                          <label
                            class="form-check-label"
                            for="work_absence_resolved_no"
                            >No</label
                          >
                        </div>
                        <div class="invalid-feedback">
                          Seleziona una risposta
                        </div>
                      </fieldset>
                    </div>
                  </fieldset>

                  <div class="subtitle">Condizioni mediche</div>

                  <fieldset class="mb-3">
                    <legend class="form-label">
                      Negli ultimi 5 anni, hai sofferto di una delle seguenti
                      condizioni? (Seleziona tutte quelle applicabili)
                    </legend>

                    <div class="form-check mb-2">
                      <input
                        class="form-check-input condition-checkbox"
                        type="checkbox"
                        id="heart_disease"
                        name="Problemi cardiaci o infarto"
                        value="heart_disease"
                      />
                      <label class="form-check-label" for="heart_disease">
                        Problemi cardiaci o infarto
                      </label>
                    </div>

                    <div class="form-check mb-2">
                      <input
                        class="form-check-input condition-checkbox"
                        type="checkbox"
                        id="stroke"
                        name="Ictus"
                        value="stroke"
                      />
                      <label class="form-check-label" for="stroke">
                        Ictus
                      </label>
                    </div>

                    <div class="form-check mb-2">
                      <input
                        class="form-check-input condition-checkbox"
                        type="checkbox"
                        id="diabetes"
                        name="Diabete"
                        value="diabetes"
                      />
                      <label class="form-check-label" for="diabetes">
                        Diabete
                      </label>
                    </div>

                    <div class="form-check mb-2">
                      <input
                        class="form-check-input condition-checkbox"
                        type="checkbox"
                        id="cancer"
                        name="Tumore"
                        value="cancer"
                      />
                      <label class="form-check-label" for="cancer">
                        Tumore
                      </label>
                    </div>

                    <div class="form-check mb-2">
                      <input
                        class="form-check-input condition-checkbox"
                        type="checkbox"
                        id="respiratory"
                        name="Problemi respiratori cronici (es. BPCO, enfisema)"
                        value="respiratory"
                      />
                      <label class="form-check-label" for="respiratory">
                        Problemi respiratori cronici (es. BPCO, enfisema)
                      </label>
                    </div>

                    <div class="form-check mb-2">
                      <input
                        class="form-check-input condition-checkbox"
                        type="checkbox"
                        id="liver"
                        name="Malattie del fegato"
                        value="liver"
                      />
                      <label class="form-check-label" for="liver">
                        Malattie del fegato
                      </label>
                    </div>

                    <div class="form-check mb-2">
                      <input
                        class="form-check-input condition-checkbox"
                        type="checkbox"
                        id="kidney"
                        name="Malattie renali"
                        value="kidney"
                      />
                      <label class="form-check-label" for="kidney">
                        Malattie renali
                      </label>
                    </div>

                    <div class="form-check mb-2">
                      <input
                        class="form-check-input condition-checkbox"
                        type="checkbox"
                        id="epilepsy"
                        name="Epilessia"
                        value="epilepsy"
                      />
                      <label class="form-check-label" for="epilepsy">
                        Epilessia
                      </label>
                    </div>

                    <div class="form-check mb-2">
                      <input
                        class="form-check-input condition-checkbox"
                        type="checkbox"
                        id="multiple_sclerosis"
                        name="Sclerosi multipla"
                        value="multiple_sclerosis"
                      />
                      <label class="form-check-label" for="multiple_sclerosis">
                        Sclerosi multipla
                      </label>
                    </div>

                    <div class="form-check mb-2">
                      <input
                        class="form-check-input condition-checkbox"
                        type="checkbox"
                        id="mental_health"
                        name="Problemi di salute mentale"
                        value="mental_health"
                      />
                      <label class="form-check-label" for="mental_health">
                        Problemi di salute mentale
                      </label>
                    </div>

                    <div
                      id="condition_details"
                      class="conditional-field d-none mt-3"
                    >
                      <label
                        for="condition_notes"
                        id="condition_notes_label"
                        class="form-label required-field"
                        >Fornisci dettagli sulle condizioni selezionate:</label
                      >
                      <textarea
                        class="form-control"
                        id="condition_notes"
                        name="condition_notes"
                        rows="3"
                      ></textarea>
                      <div class="invalid-feedback">
                        Fornisci dettagli sulle condizioni selezionate.
                      </div>
                    </div>
                  </fieldset>

                  <div class="d-flex justify-content-between mt-4">
                    <button type="button" id="prev-2" class="btn btn-secondary">
                      <i class="bi bi-arrow-left"></i> Indietro
                    </button>
                    <button type="button" id="next-2" class="btn btn-primary">
                      Avanti <i class="bi bi-arrow-right"></i>
                    </button>
                  </div>
                </div>

                <!-- STEP 3: Beneficiari e Conferma -->
                <div class="form-section" id="section-3">
                  <div class="subtitle">Beneficiari</div>

                  <div class="row mb-3">
                    <div class="col-md-12">
                      <label
                        for="beneficiary_type"
                        class="form-label required-field"
                        >Tipo di beneficiario</label
                      >
                      <select
                        class="form-select"
                        id="beneficiary_type"
                        name="beneficiary_type"
                        required
                      >
                        <option value="" selected disabled>Seleziona...</option>
                        <option value="legal">Coniuge</option>
                        <option value="child">Figli (collettivamente)</option>
                        <option value="parents">
                          Genitori (collettivamente)
                        </option>
                        <option value="custom">Altro (specificare)</option>
                      </select>
                      <div class="invalid-feedback">
                        Seleziona il tipo di beneficiario
                      </div>
                    </div>
                  </div>

                  <!-- Implementazione per i beneficiari multipli (tipo 'other') -->
                  <div id="other_beneficiary" class="conditional-field d-none">
                    <div id="beneficiary-list">
                      <!-- Il primo beneficiario � sempre presente -->
                      <div class="beneficiary-container" data-index="0">
                        <div
                          class="d-flex justify-content-between align-items-center mb-2"
                        >
                          <h6 class="mb-0">Beneficiario #1</h6>
                          <!-- Il pulsante Rimuovi � nascosto per il primo -->
                          <button
                            type="button"
                            class="btn btn-sm btn-outline-danger remove-beneficiary d-none"
                            data-index="0"
                          >
                            <i class="bi bi-trash"></i> Rimuovi
                          </button>
                        </div>

                        <div class="row mb-3">
                          <div class="col-md-6">
                            <label
                              for="beneficiary_firstname_0"
                              class="form-label required-field"
                              >Nome</label
                            >
                            <input
                              type="text"
                              class="form-control"
                              id="beneficiary_firstname_0"
                              name="beneficiary_firstname_0"
                              data-beneficiary-firstname
                            />
                            <div class="invalid-feedback">
                              Inserisci il nome del beneficiario.
                            </div>
                          </div>
                          <div class="col-md-6">
                            <label
                              for="beneficiary_lastname_0"
                              class="form-label required-field"
                              >Cognome</label
                            >
                            <input
                              type="text"
                              class="form-control"
                              id="beneficiary_lastname_0"
                              name="beneficiary_lastname_0"
                              data-beneficiary-lastname
                            />
                            <div class="invalid-feedback">
                              Inserisci il cognome del beneficiario.
                            </div>
                          </div>
                        </div>

                        <div class="row mb-3">
                          <div class="col-md-8">
                            <label
                              for="beneficiary_relation_0"
                              class="form-label"
                              >Relazione con l'assicurato</label
                            >
                            <input
                              type="text"
                              class="form-control"
                              id="beneficiary_relation_0"
                              name="beneficiary_relation_0"
                              data-beneficiary-relation
                            />
                            <!-- Non obbligatorio di default, ma potrebbe esserlo a seconda delle regole -->
                          </div>
                          <div class="col-md-4">
                            <label
                              for="beneficiary_percentage_0"
                              class="form-label required-field"
                              >Percentuale (%)</label
                            >
                            <input
                              type="number"
                              class="form-control beneficiary-percentage"
                              id="beneficiary_percentage_0"
                              name="beneficiary_percentage_0"
                              min="1"
                              max="100"
                              value="100"
                              required
                              data-beneficiary-percentage
                            />
                            <div class="invalid-feedback">
                              Inserisci una percentuale valida (1-100).
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                    <!-- Fine #beneficiary-list -->

                    <!-- Template per nuovi beneficiari (nascosto) -->
                    <template id="beneficiary-template">
                      <div class="beneficiary-container" data-index="{INDEX}">
                        <div
                          class="d-flex justify-content-between align-items-center mb-2"
                        >
                          <h6 class="mb-0">Beneficiario #{NUMBER}</h6>
                          <button
                            type="button"
                            class="btn btn-sm btn-outline-danger remove-beneficiary"
                            data-index="{INDEX}"
                          >
                            <i class="bi bi-trash"></i> Rimuovi
                          </button>
                        </div>

                        <div class="row mb-3">
                          <div class="col-md-6">
                            <label
                              for="beneficiary_firstname_{INDEX}"
                              class="form-label required-field"
                              >Nome</label
                            >
                            <input
                              type="text"
                              class="form-control"
                              id="beneficiary_firstname_{INDEX}"
                              name="beneficiary_firstname_{INDEX}"
                              required
                              data-beneficiary-firstname
                            />
                            <div class="invalid-feedback">
                              Inserisci il nome del beneficiario.
                            </div>
                          </div>
                          <div class="col-md-6">
                            <label
                              for="beneficiary_lastname_{INDEX}"
                              class="form-label required-field"
                              >Cognome</label
                            >
                            <input
                              type="text"
                              class="form-control"
                              id="beneficiary_lastname_{INDEX}"
                              name="beneficiary_lastname_{INDEX}"
                              required
                              data-beneficiary-lastname
                            />
                            <div class="invalid-feedback">
                              Inserisci il cognome del beneficiario.
                            </div>
                          </div>
                        </div>

                        <div class="row mb-3">
                          <div class="col-md-8">
                            <label
                              for="beneficiary_relation_{INDEX}"
                              class="form-label"
                              >Relazione con l'assicurato</label
                            >
                            <input
                              type="text"
                              class="form-control"
                              id="beneficiary_relation_{INDEX}"
                              name="beneficiary_relation_{INDEX}"
                              data-beneficiary-relation
                            />
                          </div>
                          <div class="col-md-4">
                            <label
                              for="beneficiary_percentage_{INDEX}"
                              class="form-label required-field"
                              >Percentuale (%)</label
                            >
                            <input
                              type="number"
                              class="form-control beneficiary-percentage"
                              id="beneficiary_percentage_{INDEX}"
                              name="beneficiary_percentage_{INDEX}"
                              min="1"
                              max="100"
                              required
                              data-beneficiary-percentage
                            />
                            <div class="invalid-feedback">
                              Inserisci una percentuale valida (1-100).
                            </div>
                          </div>
                        </div>
                      </div>
                    </template>

                    <!-- Avviso per la percentuale totale con aria-live -->
                    <div
                      class="alert alert-info mb-3"
                      id="percentage-info"
                      role="alert"
                      aria-live="polite"
                    >
                      Percentuale totale allocata:
                      <strong id="total-percentage">100</strong>%
                    </div>

                    <!-- Pulsante per aggiungere altri beneficiari -->
                    <div class="text-center mb-3">
                      <button
                        type="button"
                        id="add-beneficiary"
                        class="btn btn-outline-primary"
                      >
                        <i class="bi bi-plus-circle"></i> Aggiungi beneficiario
                      </button>
                    </div>
                  </div>

                  <div class="subtitle">Consensi e Dichiarazioni</div>

                  <div class="mb-3 form-check">
                    <input
                      class="form-check-input"
                      type="checkbox"
                      id="privacy_consent"
                      name="privacy_consent"
                      required
                    />
                    <label
                      id="privacy_consent_label"
                      class="form-check-label required-field"
                      for="privacy_consent"
                    >
                      Ho letto e acconsento all'informativa sulla privacy e al
                      trattamento dei miei dati personali per le finalit&agrave;
                      indicate.
                    </label>
                    <div class="invalid-feedback">
                      Devi accettare l'informativa sulla privacy
                    </div>
                  </div>

                  <div class="mb-3 form-check">
                    <input
                      class="form-check-input"
                      type="checkbox"
                      id="terms_consent"
                      name="terms_consent"
                      required
                    />
                    <label
                      id="terms_consent_label"
                      class="form-check-label required-field"
                      for="terms_consent"
                    >
                      Dichiaro che le informazioni fornite sono veritiere e
                      complete e acconsento ai termini e condizioni del
                      servizio.
                    </label>
                    <div class="invalid-feedback">
                      Devi accettare i termini e condizioni
                    </div>
                  </div>

                  <div class="mb-3 form-check">
                    <input
                      class="form-check-input"
                      type="checkbox"
                      id="mandate_consent"
                      name="mandate_consent"
                      required
                    />
                    <label
                      id="mandate_consent_label"
                      class="form-check-label required-field"
                      for="mandate_consent"
                    >
                      Conferisco mandato fiduciario per mediazione di servizi
                      assicurativi a Lifensure SA.
                    </label>
                    <div class="invalid-feedback">
                      &Egrave; necessario conferire il mandato per procedere
                    </div>
                  </div>

                  <div class="mb-3 form-check">
                    <input
                      class="form-check-input"
                      type="checkbox"
                      id="marketing_consent"
                      name="marketing_consent"
                    />
                    <label
                      id="marketing_consent_label"
                      class="form-check-label"
                      for="marketing_consent"
                    >
                      Acconsento a ricevere comunicazioni commerciali e
                      promozionali anche da terze parti (facoltativo).
                    </label>
                  </div>

                  <div class="mb-4">
                    <label for="notes" class="form-label"
                      >Note aggiuntive (facoltativo)</label
                    >
                    <textarea
                      class="form-control"
                      id="notes"
                      name="notes"
                      rows="3"
                    ></textarea>
                  </div>

                  <div class="d-flex justify-content-between mt-4">
                    <button type="button" id="prev-3" class="btn btn-secondary">
                      <i class="bi bi-arrow-left"></i> Indietro
                    </button>
                    <button
                      type="submit"
                      id="submit-form"
                      class="btn btn-success"
                    >
                      <i class="bi bi-check-lg"></i> Invia richiesta
                    </button>
                  </div>
                </div>
              </form>

              <!-- Messaggio di ringraziamento -->
              <div class="thank-you-message" id="thank-you">
                <div class="alert alert-success mb-4" id="thank-you-alert">
                  <h4 class="alert-heading">Grazie per la tua richiesta!</h4>
                  <p>
                    La tua richiesta di offerta &egrave; stata inviata con
                    successo. Riceverai un'email di conferma all'indirizzo
                    fornito.
                  </p>
                  <hr />
                  <p class="mb-0">
                    Un nostro consulente ti contatter&agrave; entro 48 ore
                    lavorative.
                  </p>
                </div>
                <p>
                  Numero di riferimento:
                  <strong id="reference-number">-</strong>
                </p>

                <!-- BLOCCO DOCUMENTI (mostrato solo se non serve verifica manuale) -->
                <div class="card mt-4" id="documents-section">
                  <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Documenti di riepilogo</h5>
                  </div>
                  <div class="card-body">
                    <p>
                      Prima di procedere all'emissione della polizza, visualizza
                      e scarica i seguenti documenti:
                    </p>

                    <div class="progress download-progress">
                      <div
                        id="documents-progress-bar"
                        class="progress-bar bg-primary"
                        role="progressbar"
                        style="width: 0%"
                        aria-valuenow="0"
                        aria-valuemin="0"
                        aria-valuemax="100"
                      ></div>
                    </div>

                    <div class="document-list" id="document-container">
                      <!-- Placeholder caricamento documenti -->
                      <div class="text-center p-4" id="documents-loading">
                        <div class="spinner-border text-primary" role="status">
                          <span class="visually-hidden"
                            >Caricamento documenti...</span
                          >
                        </div>
                        <p class="mt-3">Recupero dei documenti in corso...</p>
                      </div>
                    </div>

                    <div class="status-message" id="download-status">
                      <i class="bi bi-info-circle"></i> Visualizza e scarica
                      <span class="highlight-text">tutti i documenti</span> per
                      procedere all'emissione della polizza.
                    </div>

                    <div class="d-grid gap-2 mt-4">
                      <button
                        id="proceed-button"
                        class="btn btn-success btn-lg proceed-btn disabled"
                        disabled
                      >
                        <!-- Aggiunto disabled HTML -->
                        <i class="bi bi-lock-fill proceed-lock"></i> Procedi con
                        l'emissione della polizza
                      </button>
                    </div>
                  </div>
                </div>

                <button
                  type="button"
                  id="new-request"
                  class="btn btn-link mt-3"
                >
                  Effettua una nuova richiesta
                </button>
              </div>

              <!-- Modal per visualizzare i documenti -->
              <div
                class="modal fade"
                id="documentModal"
                tabindex="-1"
                aria-labelledby="documentModalLabel"
                aria-hidden="true"
              >
                <div class="modal-dialog modal-lg">
                  <div class="modal-content">
                    <div class="modal-header">
                      <h5 class="modal-title" id="documentModalLabel">
                        Visualizza documento
                      </h5>
                      <button
                        type="button"
                        class="btn-close"
                        data-bs-dismiss="modal"
                        aria-label="Chiudi"
                      ></button>
                    </div>
                    <div class="modal-body">
                      <div class="document-content-modal" id="document-content">
                        <!-- Il contenuto del documento verr� inserito qui -->
                      </div>
                    </div>
                    <div class="modal-footer">
                      <button
                        type="button"
                        class="btn btn-secondary"
                        data-bs-dismiss="modal"
                      >
                        Chiudi
                      </button>
                      <button
                        type="button"
                        class="btn btn-primary"
                        id="modal-download-btn"
                      >
                        <i class="bi bi-download"></i> Scarica
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <!-- Fine card-body -->
          </div>
          <!-- Fine card -->
        </div>
        <!-- Fine col -->
      </div>
      <!-- Fine row -->
    </div>
    <!-- Fine container -->
    <script src="assets/api/test-connection.js"></script>
    <script src="assets/api/richiedi-oferta.js"></script>
    <script src="assets/api/recupera-documento.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // --- COSTANTI E VARIABILI GLOBALI ---
        const BMI_UNDERWEIGHT_THRESHOLD = 18.5; // Soglia standard OMS
        const BMI_OBESE_THRESHOLD = 40; // Soglia alta per possibile verifica

        const form = document.getElementById("offer-request-form");
        const sections = document.querySelectorAll(".form-section");
        const progressBar = document.querySelector(".progress-bar");
        const steps = document.querySelectorAll(".step");
        const thankYouMessage = document.getElementById("thank-you");
        const thankYouAlert = document.getElementById("thank-you-alert");
        const documentsSection = document.getElementById("documents-section");

        // Bottoni di navigazione
        const nextBtn1 = document.getElementById("next-1");
        const nextBtn2 = document.getElementById("next-2");
        const prevBtn2 = document.getElementById("prev-2");
        const prevBtn3 = document.getElementById("prev-3");
        const submitBtn = document.getElementById("submit-form");
        const newRequestBtn = document.getElementById("new-request");

        // Elementi per la gestione dei documenti
        const documentContainer = document.getElementById("document-container");
        const documentsLoading = document.getElementById("documents-loading");
        const progressDocuments = document.getElementById(
          "documents-progress-bar"
        );
        const proceedButton = document.getElementById("proceed-button");
        const downloadStatus = document.getElementById("download-status");
        const documentModalElement = document.getElementById("documentModal");
        const documentModal = new bootstrap.Modal(documentModalElement);
        const documentContent = document.getElementById("document-content");
        const documentModalLabel =
          document.getElementById("documentModalLabel");
        const modalDownloadBtn = document.getElementById("modal-download-btn");

        // Elementi per campi condizionali
        const existingInsuranceRadios = document.querySelectorAll(
          'input[name="existing_insurance"]'
        );
        const existingInsuranceDetails = document.getElementById(
          "existing_insurance_details"
        );
        const existingCoverageInput =
          document.getElementById("existing_coverage");

        const medicationRadios = document.querySelectorAll(
          'input[name="medication"]'
        );
        const medicationDetails = document.getElementById("medication_details");
        const medicationDescription = document.getElementById(
          "medication_description"
        );
        const medicationResolvedRadios = medicationDetails.querySelectorAll(
          'input[name="medication_resolved"]'
        );

        const hospitalizationRadios = document.querySelectorAll(
          'input[name="hospitalization"]'
        );
        const hospitalizationDetails = document.getElementById(
          "hospitalization_details"
        );
        const hospitalizationResolvedRadios =
          hospitalizationDetails.querySelectorAll(
            'input[name="hospitalization_resolved"]'
          );

        const workAbsenceRadios = document.querySelectorAll(
          'input[name="work_absence"]'
        );
        const workAbsenceDetails = document.getElementById(
          "work_absence_details"
        );
        const workAbsenceResolvedRadios = workAbsenceDetails.querySelectorAll(
          'input[name="work_absence_resolved"]'
        );

        const conditionCheckboxes = document.querySelectorAll(
          ".condition-checkbox"
        );
        const conditionDetails = document.getElementById("condition_details");
        const conditionNotes = document.getElementById("condition_notes");

        // Elementi beneficiari
        const beneficiaryTypeSelect =
          document.getElementById("beneficiary_type");
        const otherBeneficiarySection =
          document.getElementById("other_beneficiary");
        const beneficiaryList = document.getElementById("beneficiary-list");
        const beneficiaryTemplate = document.getElementById(
          "beneficiary-template"
        );
        const addBeneficiaryBtn = document.getElementById("add-beneficiary");
        const totalPercentageDisplay =
          document.getElementById("total-percentage");
        const percentageInfoAlert = document.getElementById("percentage-info");

        // Stato interno
        let currentStep = 1;
        let beneficiaryCount = 1; // Inizia con 1 perch� il primo � sempre presente
        let beneficiaryIndexes = [0]; // Tiene traccia degli indici dei beneficiari attivi
        let documentsViewed = 0;
        let documentsDownloaded = 0;
        let totalDocuments = 4; // Valore predefinito, verr� aggiornato
        let documentTypes = []; // Verr� popolato dalla simulazione/API
        let sessionStorageAvailable = false; // Flag per disponibilit� sessionStorage

        // --- CONTROLLO FUNZIONALIT� BROWSER ---
        try {
          sessionStorage.setItem("test", "test");
          sessionStorage.removeItem("test");
          sessionStorageAvailable = true;
        } catch (e) {
          console.warn("SessionStorage non � disponibile o accessibile.");
          // Potrebbe essere utile mostrare un messaggio all'utente
          // alert("Attenzione: la funzionalit� di salvataggio automatico potrebbe non funzionare correttamente nel tuo browser.");
        }

        // --- FUNZIONI API SIMULATE (DA SOSTITUIRE CON CHIAMATE BACKEND) ---

        /**
         * SIMULAZIONE: Recupera i documenti.
         * NEL MONDO REALE: Questa funzione dovrebbe chiamare il TUO backend,
         * il quale a sua volta chiamerebbe l'API Squarelife in modo sicuro.
         * @param {string} referenceNumber - Il numero di riferimento (generato dal backend).
         * @param {object} userData - Dati utente per personalizzazione.
         * @returns {Promise<Array>} - Promise che risolve con un array di oggetti documento.
         */
        let pointerDocuments = [];

        /**
         * SIMULAZIONE: Ottiene il contenuto di un documento per il modal.
         * NEL MONDO REALE: Chiamata al TUO backend, che recupera il contenuto dall'API Squarelife.
         * @param {string} documentId - ID del documento.
         * @param {string} referenceNumber - Numero di riferimento.
         * @returns {Promise<string>} - Promise con il contenuto HTML (simulato).
         */
        async function getDocumentContentFromAPI(documentId, referenceNumber) {
          console.log(
            "Simulazione chiamata API per contenuto documento:",
            documentId,
            "per ref:",
            referenceNumber
          );
          // !!! IMPORTANTE: NESSUNA CHIAVE API QUI !!!
          const url = await loadDocumentFromAPI(documentId);
          // return `<embed src="${url}" type="application/pdf" width="100%" height="80vh" />`;
          const isMobile = /iPhone|iPad|iPod|Android/i.test(
            navigator.userAgent
          );

          if (isMobile) {
            window.open(url, "_blank");
            return '<p class="text-center">Il documento è stato aperto in una nuova finestra.</p>';
          } else {
            return `<iframe src="${url}" style="width:100%; height:100vh;" frameborder="0"></iframe>`;
          }
          // new Promise((resolve) => {
          //   setTimeout(() => {
          //     // Simula contenuto HTML diverso per ogni documento
          //     let simulatedContent = `<p>Contenuto simulato per il documento <strong>${documentId}</strong>.</p>`;
          //     simulatedContent += `<p>Numero di riferimento: ${referenceNumber}</p>`;
          //     simulatedContent += `<p>Questo � un testo segnaposto generato dalla simulazione frontend. In un'applicazione reale, qui verrebbe visualizzato il contenuto effettivo del documento recuperato tramite il backend dall'API Squarelife.</p>`;
          //     if (documentId === "summary") {
          //       simulatedContent +=
          //         "<h4>Dettagli Riepilogo (Simulati)</h4><ul><li>Nome: Mario Rossi</li><li>Copertura: 100'000 CHF</li><li>Durata: 10 anni</li></ul>";
          //     } else if (documentId === "terms") {
          //       simulatedContent +=
          //         "<h4>Estratto Termini (Simulati)</h4><p>Art. 1: Definizioni...</p><p>Art. 2: Obblighi dell'assicurato...</p>";
          //     }
          //     resolve(simulatedContent);
          //   }, 500); // Simula ritardo minore per il contenuto
          // });
        }

        /**
         * SIMULAZIONE: Scarica un documento.
         * NEL MONDO REALE: Chiamata al TUO backend, che gestisce il download sicuro dall'API Squarelife.
         * @param {string} documentId - ID del documento.
         * @param {string} referenceNumber - Numero di riferimento.
         * @returns {Promise<string>} - Promise con un URL di download (simulato).
         */
        async function downloadDocumentFromAPI(documentId, referenceNumber) {
          console.log(
            "Simulazione chiamata API per download documento:",
            documentId,
            "per ref:",
            referenceNumber
          );
          // !!! IMPORTANTE: NESSUNA CHIAVE API QUI !!!

          const simulatedUrl = loadDocumentFromAPI(documentId);
          // return new Promise((resolve) => {
          //   setTimeout(() => {
          //     // Simula un URL di download. Potrebbe essere un link a un file statico o un blob URL generato.
          //     // Per semplicit�, usiamo un URL fittizio che non funzioner� realmente.
          //     const simulatedUrl = `data:text/plain;charset=utf-8,Contenuto%20simulato%20del%20documento%20${documentId}%20per%20${referenceNumber}.txt`;
          //     // In alternativa, per simulare un PDF:
          //     // const pdfBlob = new Blob(['Simulated PDF content for ' + documentId], { type: 'application/pdf' });
          //     // const simulatedUrl = URL.createObjectURL(pdfBlob);
          //     resolve(simulatedUrl);
          //   }, 800); // Simula ritardo
          // });
          return simulatedUrl;
        }

        // --- FUNZIONI GESTIONE DOCUMENTI ---

        function createDocumentElements() {
          documentContainer.innerHTML = ""; // Pulisce il contenitore
          documentsLoading.style.display = "none"; // Nasconde il caricamento

          if (!documentTypes || documentTypes.length === 0) {
            documentContainer.innerHTML =
              '<div class="alert alert-warning">Nessun documento da visualizzare.</div>';
            return;
          }

          documentTypes.forEach((doc) => {
            const documentItem = document.createElement("div");
            documentItem.className = "document-item";
            documentItem.dataset.docId = doc.id;

            const icon = getDocumentIcon(doc.id);

            // Crea i badge iniziali
            let viewedBadge = `<span class="badge bg-warning badge-document viewed-badge"><i class="bi bi-eye-slash"></i> Non visualizzato</span>`;
            let downloadedBadge = `<span class="badge bg-danger badge-document downloaded-badge"><i class="bi bi-x-circle"></i> Non scaricato</span>`;

            documentItem.innerHTML = `
            <div class="document-icon">
              <i class="bi ${icon}"></i>
            </div>
            <div class="document-details">
              <h5 class="document-title">${
                doc.title || "Documento senza titolo"
              }</h5>
              <p class="document-description">${
                doc.description || "Nessuna descrizione"
              }</p>
              <div>
                ${viewedBadge}
                ${downloadedBadge}
              </div>
            </div>
            <div class="document-actions">
              <button class="btn btn-primary btn-sm view-document" data-doc-id="${
                doc.id
              }">
                <i class="bi bi-eye"></i> Visualizza
              </button>
              <button class="btn btn-success btn-sm download-document" data-doc-id="${
                doc.id
              }" disabled> <!-- Inizia disabilitato -->
                <i class="bi bi-download"></i> Scarica
              </button>
            </div>
          `;
            documentContainer.appendChild(documentItem);
            // Aggiorna subito lo stato UI se caricato da sessionStorage
            updateDocumentUI(doc.id);
          });

          setupDocumentListeners();
        }

        function setupDocumentListeners() {
          document.querySelectorAll(".view-document").forEach((button) => {
            // Rimuovi listener precedenti per evitare duplicati se questa funzione viene chiamata pi� volte
            button.replaceWith(button.cloneNode(true));
          });
          document.querySelectorAll(".download-document").forEach((button) => {
            button.replaceWith(button.cloneNode(true));
          });

          // Aggiungi nuovi listener
          document.querySelectorAll(".view-document").forEach((button) => {
            button.addEventListener("click", function () {
              const docId = this.dataset.docId;
              showDocumentInModal(docId);
            });
          });

          document.querySelectorAll(".download-document").forEach((button) => {
            button.addEventListener("click", function () {
              const docId = this.dataset.docId;
              downloadDocument(docId);
            });
          });
        }

        async function showDocumentInModal(docId) {
          const documentData = documentTypes.find((doc) => doc.id === docId);
          if (!documentData) return;

          documentModalLabel.textContent =
            documentData.title || "Visualizza documento";
          documentContent.innerHTML = `
          <div class="text-center p-4">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Caricamento...</span>
            </div>
            <p class="mt-3">Caricamento del documento...</p>
          </div>
        `;
          documentModal.show();

          try {
            const referenceNumber = sessionStorageAvailable
              ? sessionStorage.getItem("referenceNumber")
              : null;
            if (!referenceNumber)
              throw new Error("Numero di riferimento non trovato.");

            const content = await getDocumentContentFromAPI(
              docId,
              referenceNumber
            );
            documentContent.innerHTML = content;

            // Configura pulsante download modale
            modalDownloadBtn.dataset.docId = docId;
            modalDownloadBtn.disabled = documentData.downloaded;
            modalDownloadBtn.innerHTML = documentData.downloaded
              ? '<i class="bi bi-check"></i> Gi&agrave; scaricato'
              : '<i class="bi bi-download"></i> Scarica';

            // Rimuovi e riaggiungi listener per evitare duplicati
            // const newModalDownloadBtn = modalDownloadBtn.cloneNode(true);
            // console.log("Nuovo pulsante download:", newModalDownloadBtn);
            // console.log("Vecchio pulsante download:", modalDownloadBtn);

            // modalDownloadBtn.parentNode.replaceChild(
            //   newModalDownloadBtn,
            //   modalDownloadBtn
            // );
            // newModalDownloadBtn.addEventListener("click", function () {
            //   downloadDocument(docId);
            //   documentModal.hide();
            // });
            modalDownloadBtn.replaceWith(modalDownloadBtn.cloneNode(true));
            const refreshedModalDownloadBtn =
              document.getElementById("modal-download-btn");
            refreshedModalDownloadBtn.dataset.docId = docId;
            refreshedModalDownloadBtn.disabled = documentData.downloaded;
            refreshedModalDownloadBtn.innerHTML = documentData.downloaded
              ? '<i class="bi bi-check"></i> Già scaricato'
              : '<i class="bi bi-download"></i> Scarica';

            refreshedModalDownloadBtn.addEventListener("click", function () {
              downloadDocument(docId);
              documentModal.hide();
            });

            // Segna come visualizzato se non lo era gi�
            if (!documentData.viewed) {
              documentData.viewed = true;
              documentsViewed = documentTypes.filter((d) => d.viewed).length; // Ricalcola
              updateDocumentUI(docId); // Aggiorna UI specifica
              updateProgressBarAndStatus(); // Aggiorna barra e stato generale
              saveDocumentState(); // Salva stato
            }
          } catch (error) {
            console.error("Errore caricamento contenuto documento:", error);
            documentContent.innerHTML = `
            <div class="alert alert-danger">
              <h5>Errore nel caricamento</h5>
              <p>Non � stato possibile caricare il contenuto. Puoi provare a scaricarlo.</p>
              <p><small>${error.message}</small></p>
            </div>
          `;
            modalDownloadBtn.disabled = true; // Disabilita download se contenuto fallisce
            modalDownloadBtn.innerHTML =
              '<i class="bi bi-download"></i> Scarica';
          }
        }

        async function downloadDocument(docId) {
          const documentData = documentTypes.find((doc) => doc.id === docId);
          if (!documentData || documentData.downloaded) return;

          const downloadBtn = document.querySelector(
            `.download-document[data-doc-id="${docId}"]`
          );
          if (!downloadBtn) return;

          downloadBtn.disabled = true;
          downloadBtn.innerHTML =
            '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Scaricamento...';

          try {
            const referenceNumber = sessionStorageAvailable
              ? sessionStorage.getItem("referenceNumber")
              : null;
            if (!referenceNumber)
              throw new Error("Numero di riferimento non trovato.");

            const downloadData = await downloadDocumentFromAPI(
              docId,
              referenceNumber
            );

            if (typeof downloadData === "string") {
              const link = document.createElement("a");
              link.href = downloadData;
              // Tenta di dare un nome al file (potrebbe non funzionare per data URI in tutti i browser)
              link.download = `${(documentData.title || docId).replace(
                /\s+/g,
                "_"
              )}.pdf`; // o .pdf se si simula pdf
              // Per blob URL funzionerebbe meglio: link.download = ...
              document.body.appendChild(link);
              link.click();
              document.body.removeChild(link);
              // Per blob URL: URL.revokeObjectURL(downloadData);
            } else {
              throw new Error(
                "Formato di download non gestito dalla simulazione."
              );
            }

            documentData.downloaded = true;
            documentsDownloaded = documentTypes.filter(
              (d) => d.downloaded
            ).length; // Ricalcola
            updateDocumentUI(docId);
            updateProgressBarAndStatus();
            checkAllDocumentsDownloaded();
            saveDocumentState();
          } catch (error) {
            console.error("Errore durante il download (simulato):", error);
            alert(
              `Errore durante il download del documento: ${error.message}. Riprova pi� tardi.`
            );
            // Ripristina il pulsante solo se non � stato effettivamente scaricato
            if (!documentData.downloaded) {
              downloadBtn.disabled = !documentData.viewed; // Riabilita solo se era stato visualizzato
              downloadBtn.innerHTML = '<i class="bi bi-download"></i> Scarica';
            }
          }
        }

        function updateDocumentUI(docId) {
          const docElement = document.querySelector(
            `.document-item[data-doc-id="${docId}"]`
          );
          if (!docElement) return;

          const documentData = documentTypes.find((doc) => doc.id === docId);
          if (!documentData) return;

          const viewedBadge = docElement.querySelector(".viewed-badge");
          const downloadedBadge = docElement.querySelector(".downloaded-badge");
          const downloadBtn = docElement.querySelector(".download-document");

          if (viewedBadge) {
            viewedBadge.className = `badge badge-document viewed-badge ${
              documentData.viewed ? "bg-success" : "bg-warning"
            }`;
            viewedBadge.innerHTML = documentData.viewed
              ? '<i class="bi bi-eye-fill"></i> Visualizzato'
              : '<i class="bi bi-eye-slash"></i> Non visualizzato';
          }

          if (downloadedBadge) {
            downloadedBadge.className = `badge badge-document downloaded-badge ${
              documentData.downloaded ? "bg-success" : "bg-danger"
            }`;
            downloadedBadge.innerHTML = documentData.downloaded
              ? '<i class="bi bi-check-circle"></i> Scaricato'
              : '<i class="bi bi-x-circle"></i> Non scaricato';
          }

          if (downloadBtn) {
            downloadBtn.disabled =
              !documentData.viewed || documentData.downloaded;
            downloadBtn.innerHTML = documentData.downloaded
              ? '<i class="bi bi-check"></i> Scaricato'
              : '<i class="bi bi-download"></i> Scarica';
          }
        }

        function updateProgressBarAndStatus() {
          if (totalDocuments === 0) return; // Evita divisione per zero

          // Ricalcola conteggi per sicurezza
          documentsViewed = documentTypes.filter((d) => d.viewed).length;
          documentsDownloaded = documentTypes.filter(
            (d) => d.downloaded
          ).length;

          const percentage = Math.floor(
            (documentsDownloaded / totalDocuments) * 100
          );
          progressDocuments.style.width = percentage + "%";
          progressDocuments.setAttribute("aria-valuenow", percentage);

          updateStatusMessage();
        }

        function updateStatusMessage() {
          if (totalDocuments === 0) {
            downloadStatus.innerHTML =
              '<i class="bi bi-info-circle"></i> Nessun documento disponibile.';
            return;
          }

          if (documentsDownloaded === 0) {
            downloadStatus.innerHTML = `<i class="bi bi-info-circle"></i> Visualizza e scarica <span class="highlight-text">${totalDocuments} documenti</span> per procedere.`;
          } else if (documentsDownloaded < totalDocuments) {
            const remaining = totalDocuments - documentsDownloaded;
            downloadStatus.innerHTML = `<i class="bi bi-exclamation-circle"></i> Hai scaricato <span class="highlight-text">${documentsDownloaded} di ${totalDocuments}</span> documenti. Ne mancano ${remaining}.`;
          } else {
            downloadStatus.innerHTML =
              '<i class="bi bi-check-circle-fill text-success"></i> <span class="highlight-text">Tutti i documenti sono stati scaricati</span>. Puoi procedere.';
          }
        }
        proceedButton.addEventListener("click", handleProceedClick);
        function checkAllDocumentsDownloaded() {
          if (totalDocuments > 0 && documentsDownloaded === totalDocuments) {
            proceedButton.disabled = false;
            proceedButton.classList.remove("disabled");
            proceedButton.classList.add("pulse-animation");
            proceedButton.innerHTML =
              '<i class="bi bi-arrow-right-circle"></i> Procedi con l\'emissione della polizza';
          } else {
            proceedButton.disabled = true;
            proceedButton.classList.add("disabled");
            proceedButton.classList.remove("pulse-animation");
            proceedButton.innerHTML =
              '<i class="bi bi-lock-fill proceed-lock"></i> Procedi con l\'emissione della polizza';
          }
        }
        function handleProceedClick() {
          if (proceedButton.disabled) return;

          if (sessionStorageAvailable) {
            const refNum = sessionStorage.getItem("referenceNumber");
            sessionStorage.setItem(
              "finalOfferData",
              JSON.stringify({ reference: refNum })
            );
          }

          window.location.href = "emissione-polizza.html";
        }

        function saveDocumentState() {
          if (!sessionStorageAvailable) return;
          try {
            const state = {
              viewedCount: documentsViewed,
              downloadedCount: documentsDownloaded,
              totalCount: totalDocuments,
              documents: documentTypes.map((d) => ({
                id: d.id,
                viewed: d.viewed,
                downloaded: d.downloaded,
              })),
            };
            sessionStorage.setItem("documentsState", JSON.stringify(state));
          } catch (error) {
            console.error(
              "Errore durante il salvataggio dello stato dei documenti:",
              error
            );
          }
        }

        function loadDocumentState() {
          if (!sessionStorageAvailable) return;
          try {
            const stateString = sessionStorage.getItem("documentsState");
            if (stateString) {
              const parsedState = JSON.parse(stateString);

              // Verifica coerenza (es. se il numero totale � cambiato)
              if (
                parsedState.totalCount === totalDocuments &&
                parsedState.documents &&
                parsedState.documents.length === totalDocuments
              ) {
                documentsViewed = parsedState.viewedCount || 0;
                documentsDownloaded = parsedState.downloadedCount || 0;

                // Aggiorna lo stato di ogni documento locale basato su quello salvato
                documentTypes.forEach((localDoc) => {
                  const savedDoc = parsedState.documents.find(
                    (saved) => saved.id === localDoc.id
                  );
                  if (savedDoc) {
                    localDoc.viewed = savedDoc.viewed || false;
                    localDoc.downloaded = savedDoc.downloaded || false;
                  }
                });
                console.log("Stato documenti caricato da sessionStorage.");
              } else {
                console.warn(
                  "Stato documenti salvato non coerente con i documenti attuali. Reset."
                );
                sessionStorage.removeItem("documentsState"); // Rimuovi stato vecchio
              }
            }
          } catch (error) {
            console.error(
              "Errore durante il caricamento o parsing dello stato dei documenti:",
              error
            );
            sessionStorage.removeItem("documentsState"); // Rimuovi stato corrotto
          }
        }

        // --- FUNZIONI NAVIGAZIONE E VALIDAZIONE FORM ---

        function goToStep(stepNumber) {
          currentStep = stepNumber;
          // Nascondi tutti
          sections.forEach((section) => section.classList.remove("active"));
          // Mostra corrente
          const currentSection = document.getElementById(
            `section-${stepNumber}`
          );
          if (currentSection) {
            currentSection.classList.add("active");
            // Rimuovi la classe 'was-validated' quando si naviga verso uno step
            currentSection.classList.remove("was-validated");
          }

          // Aggiorna indicatori
          steps.forEach((step, index) => {
            step.classList.remove("active", "completed");
            const stepIndex = index + 1;
            if (stepIndex === stepNumber) {
              step.classList.add("active");
            } else if (stepIndex < stepNumber) {
              step.classList.add("completed");
            }
          });

          // Aggiorna progress bar
          // La logica originale era (stepNumber - 1) / (sections.length - 1) * 100
          // Ma sections.length include la sezione thank-you che non � uno step.
          // Usiamo il numero di step visibili (3).
          const progressPercentage = Math.max(0, ((stepNumber - 1) / 3) * 100);
          progressBar.style.width = progressPercentage + "%";
          progressBar.setAttribute("aria-valuenow", progressPercentage);

          // Scrolla all'inizio della sezione
          window.scrollTo({ top: form.offsetTop - 20, behavior: "smooth" });
        }

        // Funzione per validare i campi di uno step specifico
        function validateStep(stepNumber) {
          const section = document.getElementById(`section-${stepNumber}`);
          if (!section) return false;

          // Aggiungi la classe per mostrare i feedback di validazione HTML5
          section.classList.add("was-validated");

          let isStepValid = true;
          const inputs = section.querySelectorAll(
            "input[required], select[required], textarea[required]"
          );

          inputs.forEach((input) => {
            // Controlla se l'input � visibile (non dentro un .d-none)
            let parent = input.parentElement;
            let isVisible = true;
            while (parent && parent !== section) {
              if (parent.classList.contains("d-none")) {
                isVisible = false;
                break;
              }
              parent = parent.parentElement;
            }

            if (isVisible) {
              if (input.type === "checkbox") {
                if (!input.checked) {
                  isStepValid = false;
                  // L'invalid-feedback per checkbox � gestito da Bootstrap con was-validated
                }
              } else if (input.type === "radio") {
                // La validazione radio � gestita separatamente da validateRadioGroups
              } else {
                // Per altri input (text, number, select, email, etc.)
                if (!input.checkValidity()) {
                  // Usa checkValidity() per pattern, min, max etc.
                  isStepValid = false;
                }
              }
            } else {
              // Se non � visibile, rimuovi 'required' temporaneamente per non bloccare la validazione
              // Questo � un workaround, idealmente la logica show/hide dovrebbe gestire required
              // input.removeAttribute('required');
              // Oppure, assicurati che la logica show/hide aggiunga/rimuova 'required'
            }
          });

          // Validazione specifica per gruppi radio nello step 2
          if (stepNumber === 2) {
            if (!validateRadioGroups(section)) {
              isStepValid = false;
            }
            // Validazione campi testuali condizionali obbligatori
            if (
              medicationRadios[0].checked &&
              medicationDetails.querySelector(
                '[name="medication_resolved"]:checked'
              ) &&
              !medicationDescription.value
            ) {
              medicationDescription.classList.add("is-invalid");
              isStepValid = false;
            } else {
              medicationDescription.classList.remove("is-invalid");
            }
            if (conditionCheckboxesChecked() && !conditionNotes.value) {
              conditionNotes.classList.add("is-invalid");
              isStepValid = false;
            } else {
              conditionNotes.classList.remove("is-invalid");
            }
            if (
              existingInsuranceRadios[0].checked &&
              !existingCoverageInput.value
            ) {
              existingCoverageInput.classList.add("is-invalid");
              isStepValid = false;
            } else {
              existingCoverageInput.classList.remove("is-invalid");
            }
          }

          // Validazione specifica per beneficiari step 3
          if (stepNumber === 3) {
            if (beneficiaryTypeSelect.value === "custom") {
              //custom
              const totalPercentage = calculateTotalPercentage();
              if (totalPercentage !== 100) {
                percentageInfoAlert.classList.remove(
                  "alert-success",
                  "alert-info"
                );
                percentageInfoAlert.classList.add("alert-danger");
                isStepValid = false;
                // Scrolla all'alert percentuale
                percentageInfoAlert.scrollIntoView({
                  behavior: "smooth",
                  block: "center",
                });
              } else {
                percentageInfoAlert.classList.remove(
                  "alert-danger",
                  "alert-info"
                );
                percentageInfoAlert.classList.add("alert-success");
              }
            }
          }

          if (!isStepValid) {
            // Trova il primo campo invalido visibile e scrolla
            const firstInvalid = section.querySelector(
              ".is-invalid:not(.d-none), input:invalid:not(.d-none), select:invalid:not(.d-none), .radio-group-invalid"
            );
            if (firstInvalid) {
              firstInvalid.scrollIntoView({
                behavior: "smooth",
                block: "center",
              });
            }
          } else {
            // Rimuovi was-validated se lo step � valido (opzionale, per pulizia)
            // section.classList.remove('was-validated');
          }

          return isStepValid;
        }

        // Funzione specifica per validare gruppi di radio button visibili
        function validateRadioGroups(section) {
          let allGroupsValid = true;
          const radioGroups = {};

          // Raccogli tutti i radio nello step
          section.querySelectorAll('input[type="radio"]').forEach((radio) => {
            if (!radioGroups[radio.name]) {
              radioGroups[radio.name] = {
                radios: [],
                container: null,
                isVisible: false,
              };
            }
            radioGroups[radio.name].radios.push(radio);
            if (!radioGroups[radio.name].container) {
              // Trova il contenitore del gruppo (es. fieldset o div.mb-3)
              radioGroups[radio.name].container =
                radio.closest("fieldset") || radio.closest(".mb-3");
            }
            // Controlla se almeno un radio del gruppo � visibile
            let parent = radio.parentElement;
            let isRadioVisible = true;
            while (parent && parent !== section) {
              if (parent.classList.contains("d-none")) {
                isRadioVisible = false;
                break;
              }
              parent = parent.parentElement;
            }
            if (isRadioVisible) {
              radioGroups[radio.name].isVisible = true;
            }
          });

          // Valida ogni gruppo visibile
          for (const name in radioGroups) {
            const group = radioGroups[name];
            if (group.isVisible) {
              // Valida solo se il gruppo � visibile
              const isChecked = group.radios.some((radio) => radio.checked);
              const feedbackElement = group.container
                ? group.container.querySelector(".invalid-feedback")
                : null;

              if (!isChecked) {
                allGroupsValid = false;
                if (group.container) {
                  group.container.classList.add("radio-group-invalid"); // Aggiungi classe per stile errore
                }
                if (feedbackElement) {
                  feedbackElement.style.display = "block"; // Mostra messaggio errore
                }
              } else {
                if (group.container) {
                  group.container.classList.remove("radio-group-invalid");
                }
                if (feedbackElement) {
                  feedbackElement.style.display = ""; // Nascondi messaggio errore
                }
              }
            } else {
              // Se il gruppo non � visibile, rimuovi eventuali stati di errore precedenti
              if (group.container) {
                group.container.classList.remove("radio-group-invalid");
              }
              const feedbackElement = group.container
                ? group.container.querySelector(".invalid-feedback")
                : null;
              if (feedbackElement) {
                feedbackElement.style.display = "";
              }
            }
          }
          return allGroupsValid;
        }

        // --- FUNZIONI GESTIONE BENEFICIARI ---

        function calculateTotalPercentage() {
          let total = 0;
          const percentageInputs = beneficiaryList.querySelectorAll(
            ".beneficiary-percentage"
          );
          percentageInputs.forEach((input) => {
            total += parseInt(input.value, 10) || 0;
          });
          return total;
        }

        function updateTotalPercentageDisplay() {
          if (beneficiaryTypeSelect.value !== "custom") return; // Aggiorna solo se la sezione � attiva

          const total = calculateTotalPercentage();
          totalPercentageDisplay.textContent = total;

          percentageInfoAlert.classList.remove(
            "alert-success",
            "alert-warning",
            "alert-danger",
            "alert-info"
          );
          if (total === 100) {
            percentageInfoAlert.classList.add("alert-success");
            submitBtn.disabled = false; // Abilita invio se 100% (e altri campi validi)
          } else if (total < 100) {
            percentageInfoAlert.classList.add("alert-warning");
            submitBtn.disabled = true; // Disabilita invio se < 100%
          } else {
            // total > 100
            percentageInfoAlert.classList.add("alert-danger");
            submitBtn.disabled = true; // Disabilita invio se > 100%
          }
        }

        function distributePercentages() {
          const percentageInputs = Array.from(
            beneficiaryList.querySelectorAll(".beneficiary-percentage")
          );
          const count = percentageInputs.length;
          if (count === 0) return;

          const basePercentage = Math.floor(100 / count);
          const remainder = 100 % count;

          percentageInputs.forEach((input, index) => {
            input.value = basePercentage + (index < remainder ? 1 : 0);
          });
          updateTotalPercentageDisplay();
        }

        function addBeneficiary() {
          beneficiaryCount++;
          const newIndex = Date.now(); // Usa timestamp per indice univoco
          beneficiaryIndexes.push(newIndex);

          const templateNode = beneficiaryTemplate.content.cloneNode(true);
          const newBeneficiaryElement = templateNode.firstElementChild;

          // Aggiorna ID, name, for e data-index nel nuovo elemento
          newBeneficiaryElement.dataset.index = newIndex;
          newBeneficiaryElement.querySelector(
            "h6"
          ).textContent = `Beneficiario #${beneficiaryCount}`;
          newBeneficiaryElement
            .querySelectorAll('[id*="{INDEX}"]')
            .forEach((el) => {
              el.id = el.id.replace("{INDEX}", newIndex);
            });
          newBeneficiaryElement
            .querySelectorAll('[name*="{INDEX}"]')
            .forEach((el) => {
              el.name = el.name.replace("{INDEX}", newIndex);
            });
          newBeneficiaryElement
            .querySelectorAll('[for*="{INDEX}"]')
            .forEach((el) => {
              el.htmlFor = el.htmlFor.replace("{INDEX}", newIndex);
            });
          newBeneficiaryElement
            .querySelectorAll('[data-index="{INDEX}"]')
            .forEach((el) => {
              el.dataset.index = newIndex;
            });

          // Aggiungi listener input percentuale
          const percentageInput = newBeneficiaryElement.querySelector(
            ".beneficiary-percentage"
          );
          percentageInput.addEventListener(
            "input",
            updateTotalPercentageDisplay
          );

          // Aggiungi listener pulsante rimuovi
          const removeBtn = newBeneficiaryElement.querySelector(
            ".remove-beneficiary"
          );
          removeBtn.addEventListener("click", function () {
            removeBeneficiary(newIndex);
          });

          // Inserisci nel DOM
          beneficiaryList.appendChild(newBeneficiaryElement);

          // Mostra pulsante rimuovi sul primo se ora ce ne sono pi� di uno
          if (beneficiaryCount > 1) {
            const firstRemoveBtn = beneficiaryList.querySelector(
              '.beneficiary-container[data-index="0"] .remove-beneficiary'
            );
            if (firstRemoveBtn) {
              firstRemoveBtn.classList.remove("d-none");
            }
          }

          distributePercentages(); // Ridistribuisci
        }

        function removeBeneficiary(indexToRemove) {
          const containerToRemove = beneficiaryList.querySelector(
            `.beneficiary-container[data-index="${indexToRemove}"]`
          );
          if (!containerToRemove) return;

          containerToRemove.remove();
          beneficiaryCount--;

          // Rimuovi indice dall'array
          beneficiaryIndexes = beneficiaryIndexes.filter(
            (idx) => idx !== indexToRemove
          );

          // Aggiorna numerazione visibile
          beneficiaryList
            .querySelectorAll(".beneficiary-container")
            .forEach((container, idx) => {
              container.querySelector("h6").textContent = `Beneficiario #${
                idx + 1
              }`;
            });

          // Nascondi pulsante rimuovi sul primo se ne rimane solo uno
          if (beneficiaryCount === 1) {
            const firstRemoveBtn = beneficiaryList.querySelector(
              '.beneficiary-container[data-index="0"] .remove-beneficiary'
            );
            if (firstRemoveBtn) {
              firstRemoveBtn.classList.add("d-none");
            }
          }

          distributePercentages(); // Ridistribuisci
        }

        // --- FUNZIONI AUSILIARIE ---

        function generateUniqueIdPlaceholder() {
          // Semplice placeholder, il vero ID dovrebbe venire dal backend
          return (
            "REQ-" + Math.random().toString(36).substring(2, 10).toUpperCase()
          );
        }

        function getDocumentIcon(documentId) {
          switch (documentId) {
            case "summary":
              return "bi-file-earmark-person"; // Icona pi� specifica
            case "terms":
              return "bi-file-earmark-ruled";
            case "privacy":
              return "bi-shield-lock";
            case "conditions":
              return "bi-file-earmark-medical";
            default:
              return "bi-file-earmark";
          }
        }

        function conditionCheckboxesChecked() {
          return Array.from(conditionCheckboxes).some((cb) => cb.checked);
        }

        function checkIfRequiresManualVerification() {
          // Controllo BMI
          const heightCm = parseFloat(document.getElementById("height").value);
          const weightKg = parseFloat(document.getElementById("weight").value);
          let requiresVerification = false;

          if (heightCm && weightKg) {
            const heightM = heightCm / 100;
            const bmi = weightKg / (heightM * heightM);
            if (bmi < BMI_UNDERWEIGHT_THRESHOLD || bmi > BMI_OBESE_THRESHOLD) {
              console.log(
                "Verifica manuale richiesta per BMI:",
                bmi.toFixed(1)
              );
              requiresVerification = true;
            }
          }

          // Controllo risposte "S�" che richiedono verifica (adattare secondo regole reali)
          const criticalYesAnswers = [
            // "medication_yes", // Forse non sempre critico se risolto? Dipende dalle regole
            "hypertension_yes",
            // "hospitalization_yes", // Forse non sempre critico se risolto?
            "planned_exam_yes",
            "drugs_yes",
            "hiv_yes",
            "foreign_stay_yes",
            "dangerous_hobby_yes",
            "pension_yes",
            // "work_absence_yes" // Forse non sempre critico se risolto?
          ];

          for (const questionId of criticalYesAnswers) {
            const element = document.getElementById(questionId);
            if (element && element.checked) {
              console.log("Verifica manuale richiesta per:", questionId);
              requiresVerification = true;
              break; // Basta una risposta critica
            }
          }
          if (requiresVerification) return true; // Esci presto

          // Controllo condizioni mediche selezionate (potrebbero richiedere sempre verifica)
          if (conditionCheckboxesChecked()) {
            console.log(
              "Verifica manuale richiesta per condizioni mediche selezionate."
            );
            requiresVerification = true;
          }
          if (requiresVerification) return true;

          // Controllo risposte "No" a domande su risoluzione (se la domanda principale era "S�")
          if (
            document.getElementById("medication_yes")?.checked &&
            document.getElementById("medication_resolved_no")?.checked
          ) {
            console.log("Verifica manuale richiesta per farmaci non risolti.");
            requiresVerification = true;
          }
          if (
            document.getElementById("hospitalization_yes")?.checked &&
            document.getElementById("hospitalization_resolved_no")?.checked
          ) {
            console.log("Verifica manuale richiesta per ricovero non risolto.");
            requiresVerification = true;
          }
          if (
            document.getElementById("work_absence_yes")?.checked &&
            document.getElementById("work_absence_resolved_no")?.checked
          ) {
            console.log(
              "Verifica manuale richiesta per assenza lavoro non risolta."
            );
            requiresVerification = true;
          }

          return requiresVerification;
        }

        // --- GESTIONE INVIO FORM ---

        async function submitFormAction(requiresManualVerification) {
          submitBtn.disabled = true;
          submitBtn.innerHTML =
            '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Invio in corso...';

          // !!! NEL MONDO REALE: Qui invieresti i dati del form al TUO backend !!!
          const formData = new FormData(form);
          const responseRichiediOfferta = await richiediOfferta(
            formData,
            requiresManualVerification
          );
          console.log("Risposta backend:", responseRichiediOfferta);
          // console.log("requiresManualVerification", requiresManualVerification);

          if (!responseRichiediOfferta.status === "ok") {
            throw new Error("Errore invio dati al backend");
          }
          // const result = await response.json();
          const referenceNumber = responseRichiediOfferta.id; // Ottieni il vero ref number dal backend

          // --- INIZIO SIMULAZIONE ---
          //  await new Promise((resolve) => setTimeout(resolve, 1500)); // Simula attesa backend
          // const referenceNumber = generateUniqueIdPlaceholder(); // Usa placeholder
          // --- FINE SIMULAZIONE ---

          // Salva riferimento (anche se placeholder) per recupero documenti simulato
          if (sessionStorageAvailable) {
            sessionStorage.setItem("referenceNumber", referenceNumber);
          }
          document.getElementById("reference-number").textContent =
            referenceNumber;

          // Nascondi form e mostra messaggio thank you
          form.style.display = "none";
          document.querySelector(".step-indicator").style.display = "none";
          document.querySelector(".progress").style.display = "none";
          thankYouMessage.classList.add("active");

          if (requiresManualVerification) {
            thankYouAlert.className = "alert alert-info mb-4"; // Cambia colore alert
            thankYouAlert.innerHTML = `
            <h4 class="alert-heading">Richiesta inviata con successo!</h4>
            <p>La tua richiesta richiede una valutazione aggiuntiva da parte del nostro team a causa delle informazioni fornite.</p>
            <hr>
            <p class="mb-0">Un nostro consulente ti contatter&agrave; entro 48 ore lavorative per discutere i prossimi passi.</p>
          `;
            documentsSection.style.display = "none"; // Nascondi sezione documenti
          } else {
            // Procedura standard: recupera e mostra documenti
            thankYouAlert.className = "alert alert-success mb-4"; // Assicura colore standard
            thankYouAlert.innerHTML = `
                <h4 class="alert-heading">Grazie per la tua richiesta!</h4>
                <p>La tua richiesta di offerta &egrave; stata inviata con successo. Riceverai un'email di conferma all'indirizzo fornito.</p>
                <hr>
                <p class="mb-0">Un nostro consulente ti contatter&agrave; entro 48 ore lavorative.</p>
              `;
            documentsSection.style.display = "block"; // Mostra sezione documenti
            documentsLoading.style.display = "block"; // Mostra caricamento iniziale
            documentContainer.innerHTML = ""; // Pulisci eventuale contenuto precedente

            try {
              // Raccogli dati utente (solo per simulazione, il backend li avrebbe gi�)
              const userData = {
                firstname:
                  document.getElementById("firstname")
                    .value /* ... altri dati ... */,
              };

              documentTypes = responseRichiediOfferta.document_pointers.map(
                (doc) => ({
                  id: doc.pointer,
                  title: doc.description,
                  description: doc.description,
                  url: doc.url || "", // URL per download diretto (simulato)
                  contentUrl: doc.contentUrl || "", // URL per contenuto modal (simulato)
                  viewed: false,
                  downloaded: false,
                })
              );
              totalDocuments = documentTypes.length;
              documentsViewed = 0;
              documentsDownloaded = 0;

              loadDocumentState(); // Carica stato pre-esistente se presente
              createDocumentElements(); // Crea elementi UI
              updateProgressBarAndStatus(); // Aggiorna UI progresso
              checkAllDocumentsDownloaded(); // Controlla se gi� completato
            } catch (error) {
              console.error(
                "Errore nel recupero/gestione documenti (simulato):",
                error
              );
              documentsLoading.style.display = "none";
              documentContainer.innerHTML = `<div class="alert alert-danger">Si � verificato un errore nel caricamento dei documenti di riepilogo. Contatta l'assistenza citando il riferimento ${referenceNumber}.</div>`;
              documentsSection.style.display = "block"; // Mostra comunque la sezione con l'errore
              proceedButton.disabled = true; // Assicura che sia disabilitato
              proceedButton.classList.add("disabled");
            }
          }
        }

        // --- EVENT LISTENERS ---

        // Navigazione
        nextBtn1?.addEventListener("click", () => {
          if (validateStep(1)) goToStep(2);
        });
        prevBtn2?.addEventListener("click", () => goToStep(1));
        nextBtn2?.addEventListener("click", () => {
          if (validateStep(2)) goToStep(3);
        });
        prevBtn3?.addEventListener("click", () => goToStep(2));

        // Campi condizionali
        existingInsuranceRadios.forEach((radio) =>
          radio.addEventListener("change", function () {
            const isYes = this.value === "yes" && this.checked;
            existingInsuranceDetails.classList.toggle("d-none", !isYes);
            existingCoverageInput.required = isYes; // Rendi obbligatorio solo se visibile
            if (!isYes) existingCoverageInput.value = ""; // Pulisci se nascosto
          })
        );

        medicationRadios.forEach((radio) =>
          radio.addEventListener("change", function () {
            const isYes = this.value === "yes" && this.checked;
            medicationDetails.classList.toggle("d-none", !isYes);
            // Rendi obbligatori i campi interni solo se la sezione � visibile
            medicationResolvedRadios.forEach((r) => (r.required = isYes));
            medicationDescription.required = isYes;
            if (!isYes) {
              // Pulisci e rimuovi required se nascosto
              medicationResolvedRadios.forEach((r) => (r.checked = false));
              medicationDescription.value = "";
              medicationDescription.classList.remove("is-invalid");
              medicationDetails
                .querySelector("fieldset")
                ?.classList.remove("radio-group-invalid");
            }
          })
        );

        hospitalizationRadios.forEach((radio) =>
          radio.addEventListener("change", function () {
            const isYes = this.value === "yes" && this.checked;
            hospitalizationDetails.classList.toggle("d-none", !isYes);
            hospitalizationResolvedRadios.forEach((r) => (r.required = isYes));
            if (!isYes) {
              hospitalizationResolvedRadios.forEach((r) => (r.checked = false));
              hospitalizationDetails
                .querySelector("fieldset")
                ?.classList.remove("radio-group-invalid");
            }
          })
        );

        workAbsenceRadios.forEach((radio) =>
          radio.addEventListener("change", function () {
            const isYes = this.value === "yes" && this.checked;
            workAbsenceDetails.classList.toggle("d-none", !isYes);
            workAbsenceResolvedRadios.forEach((r) => (r.required = isYes));
            if (!isYes) {
              workAbsenceResolvedRadios.forEach((r) => (r.checked = false));
              workAbsenceDetails
                .querySelector("fieldset")
                ?.classList.remove("radio-group-invalid");
            }
          })
        );

        conditionCheckboxes.forEach((checkbox) =>
          checkbox.addEventListener("change", function () {
            const anyChecked = conditionCheckboxesChecked();
            conditionDetails.classList.toggle("d-none", !anyChecked);
            conditionNotes.required = anyChecked; // Rendi obbligatorio solo se visibile
            if (!anyChecked) {
              conditionNotes.value = ""; // Pulisci se nascosto
              conditionNotes.classList.remove("is-invalid");
            }
          })
        );

        // Gestione beneficiari
        beneficiaryTypeSelect?.addEventListener("change", function () {
          const isOther = this.value === "custom";
          otherBeneficiarySection.classList.toggle("d-none", !isOther);
          // Rendi obbligatori i campi del primo beneficiario solo se 'other' � selezionato
          const firstBeneficiaryInputs = beneficiaryList
            .querySelector('.beneficiary-container[data-index="0"]')
            ?.querySelectorAll("input[required], select[required]");
          firstBeneficiaryInputs?.forEach(
            (input) => (input.required = isOther)
          );

          if (isOther) {
            distributePercentages(); // Imposta/distribuisci percentuali quando si seleziona 'other'
          } else {
            submitBtn.disabled = false; // Riabilita submit se si cambia da 'other' (verr� ri-validato)
          }
        });

        addBeneficiaryBtn?.addEventListener("click", addBeneficiary);

        // Aggiungi listener al primo input percentuale (gli altri vengono aggiunti dinamicamente)
        document
          .getElementById("beneficiary_percentage_0")
          ?.addEventListener("input", updateTotalPercentageDisplay);

        // Invio Form
        form?.addEventListener("submit", function (e) {
          e.preventDefault();
          e.stopPropagation(); // Impedisce bubbling se necessario

          // Valida lo step corrente (che dovrebbe essere il 3)
          if (validateStep(currentStep)) {
            const requiresManualVerification =
              checkIfRequiresManualVerification();
            submitFormAction(requiresManualVerification);
          } else {
            console.log("Validazione fallita per lo step:", currentStep);
            // La validazione mostra gi� gli errori e scrolla al primo
          }
        });

        // Nuova Richiesta
        newRequestBtn?.addEventListener("click", function () {
          // Resetta stato
          if (sessionStorageAvailable) {
            sessionStorage.removeItem("documentsState");
            sessionStorage.removeItem("referenceNumber");
            sessionStorage.removeItem("datiPreventivo"); // Rimuovi anche questi se usati
          }
          form.reset();
          form.classList.remove("was-validated"); // Rimuovi stato validazione
          sections.forEach((s) => s.classList.remove("was-validated")); // Rimuovi da tutte le sezioni

          // Resetta UI documenti
          documentTypes = [];
          totalDocuments = 4; // Resetta a default
          documentsViewed = 0;
          documentsDownloaded = 0;
          documentContainer.innerHTML = "";
          documentsLoading.style.display = "block"; // Mostra di nuovo loader placeholder
          updateProgressBarAndStatus();
          checkAllDocumentsDownloaded(); // Assicura che bottone procedi sia disabilitato

          // Resetta beneficiari dinamici
          beneficiaryList.innerHTML = ""; // Rimuovi tutti tranne il template
          beneficiaryIndexes = [0];
          beneficiaryCount = 1;
          // Ricrea il primo beneficiario dal template
          const templateNode = beneficiaryTemplate.content.cloneNode(true);
          const firstBeneficiaryElement = templateNode.firstElementChild;
          firstBeneficiaryElement.dataset.index = 0;
          firstBeneficiaryElement.querySelector(
            "h6"
          ).textContent = `Beneficiario #1`;
          firstBeneficiaryElement
            .querySelectorAll('[id*="{INDEX}"]')
            .forEach((el) => (el.id = el.id.replace("{INDEX}", 0)));
          firstBeneficiaryElement
            .querySelectorAll('[name*="{INDEX}"]')
            .forEach((el) => (el.name = el.name.replace("{INDEX}", 0)));
          firstBeneficiaryElement
            .querySelectorAll('[for*="{INDEX}"]')
            .forEach((el) => (el.htmlFor = el.htmlFor.replace("{INDEX}", 0)));
          const firstRemoveBtn = firstBeneficiaryElement.querySelector(
            ".remove-beneficiary"
          );
          firstRemoveBtn.dataset.index = 0;
          firstRemoveBtn.classList.add("d-none"); // Nascosto all'inizio
          const firstPercInput = firstBeneficiaryElement.querySelector(
            ".beneficiary-percentage"
          );
          firstPercInput.value = 100; // Resetta a 100
          firstPercInput.addEventListener(
            "input",
            updateTotalPercentageDisplay
          );
          beneficiaryList.appendChild(firstBeneficiaryElement);
          otherBeneficiarySection.classList.add("d-none"); // Nascondi sezione 'other'

          // Ripristina visualizzazione
          thankYouMessage.classList.remove("active");
          form.style.display = "block";
          document.querySelector(".step-indicator").style.display = "flex";
          document.querySelector(".progress").style.display = "block";
          submitBtn.disabled = false; // Riabilita bottone invio
          submitBtn.innerHTML =
            '<i class="bi bi-check-lg"></i> Invia richiesta';

          // Torna al primo step e carica dati pre-compilati se presenti
          goToStep(1);
          loadDataFromPreviousModule();
        });

        // --- INIZIALIZZAZIONE ---

        function loadDataFromPreviousModule() {
          if (!sessionStorageAvailable) return;
          try {
            const datiPreventivoString =
              sessionStorage.getItem("datiPreventivo");
            if (datiPreventivoString) {
              const datiPreventivo = JSON.parse(datiPreventivoString);
              console.log("Caricamento dati da preventivo:", datiPreventivo);

              // Compila campi Step 1
              document.getElementById("duration").value =
                datiPreventivo.durata || 10;
              document.getElementById("coverage").value =
                datiPreventivo.copertura || 100000;
              document.getElementById("birthdate").value =
                datiPreventivo.dataNascita || "";

              // Compila campi Step 2
              document.getElementById("height").value =
                datiPreventivo.altezza || "";
              document.getElementById("weight").value =
                datiPreventivo.peso || "";
              if (datiPreventivo.fumatore !== undefined) {
                document.getElementById(
                  datiPreventivo.fumatore ? "smoker_yes" : "smoker_no"
                ).checked = true;
              }
              const alertPlaceholder =
                document.getElementById("alert-placeholder");
              // Pulisci alert precedente
              if (alertPlaceholder) {
                alertPlaceholder.className =
                  "alert alert-info alert-dismissible fade show mb-4";
                alertPlaceholder.innerHTML = `
                        <strong>Dati preventivo importati:</strong> Copertura: ${
                          datiPreventivo.copertura
                        } ${datiPreventivo.currency || "CHF"},
                        Durata: ${datiPreventivo.durata} anni, Premio: ${
                  datiPreventivo.premio
                } ${datiPreventivo.currency || "CHF"}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Chiudi"></button>
                    `;
              }
            }
          } catch (error) {
            console.error(
              "Errore durante il parsing dei dati preventivo:",
              error
            );
            sessionStorage.removeItem("datiPreventivo"); // Rimuovi dati corrotti
          }
        }

        // Carica dati iniziali e vai al primo step
        loadDataFromPreviousModule();
        goToStep(1); // Assicura che si parta sempre dal primo step al caricamento
      }); // Fine DOMContentLoaded
    </script>
  </body>
</html>
