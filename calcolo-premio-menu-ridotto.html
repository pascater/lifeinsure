<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1">
  <title>Richiesta Offerta Polizza Vita</title>

  <!-- Link CSS (invariati) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  <link rel="stylesheet" href="https://r.mobirisesite.com/1342903/assets/Material-Design-Icons/css/material.css" />
  <link rel="stylesheet" href="https://r.mobirisesite.com/1342903/assets/icon54/style.css" />
  <link rel="stylesheet" href="https://r.mobirisesite.com/1342903/assets/bootstrap/css/bootstrap-grid.min.css" />
  <link rel="stylesheet" href="https://r.mobirisesite.com/1342903/assets/bootstrap/css/bootstrap-reboot.min.css" />
  <link rel="stylesheet" href="https://r.mobirisesite.com/1342903/assets/dropdown/css/style.css" />
  <link rel="stylesheet" href="https://r.mobirisesite.com/1342903/assets/socicon/css/styles.css" />
  <link rel="stylesheet" href="https://r.mobirisesite.com/1342903/assets/theme/css/style.css" />
  <link rel="preload" href="https://fonts.googleapis.com/css?family=Space+Grotesk:300,400,500,600,700&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'" />
  <noscript><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Space+Grotesk:300,400,500,600,700&display=swap" /></noscript>
  <link rel="preload" as="style" href="https://r.mobirisesite.com/1342903/assets/mobirise/css/mbr-additional.css?v=1TZWWw" />
  <link rel="stylesheet" href="https://r.mobirisesite.com/1342903/assets/mobirise/css/mbr-additional.css?v=1TZWWw" type="text/css" />

  <!-- Stili specifici del modulo richiesta offerta + NUOVI OVERRIDES MENU -->
  <style>
    /* Stili modulo (invariati) */
    .form-section { display: none; }
    .form-section.active { display: block; }
    .progress { height: 8px; margin-bottom: 30px; }
    .step-indicator { display: flex; justify-content: space-between; margin-bottom: 20px; }
    .step { text-align: center; flex: 1; position: relative; }
    .step-number { width: 30px; height: 30px; border-radius: 50%; background-color: #dee2e6; color: #6c757d; display: flex; align-items: center; justify-content: center; margin: 0 auto 5px; font-weight: bold; }
    .step.active .step-number { background-color: #0d6efd; color: white; }
    .step.completed .step-number { background-color: #198754; color: white; }
    .step-title { font-size: 0.8rem; color: #6c757d; }
    .step.active .step-title { color: #0d6efd; font-weight: bold; }
    .step.completed .step-title { color: #198754; }
    .required-field::after { content: "*"; color: red; margin-left: 4px; }
    .subtitle { background-color: #f8f9fa; padding: 10px 15px; margin: 20px 0 15px; border-left: 4px solid #0d6efd; font-size: 1.1rem; }
    .info-icon { color: #6c757d; cursor: pointer; margin-left: 5px; }
    .is-invalid { border-color: #dc3545 !important; }
    .invalid-feedback { display: none; color: #dc3545; font-size: 0.875em; margin-top: 0.25rem; }
    .was-validated .form-control:invalid, .was-validated .form-select:invalid, .was-validated .form-check-input:invalid { border-color: #dc3545; }
    .was-validated .form-control:invalid ~ .invalid-feedback, .was-validated .form-select:invalid ~ .invalid-feedback, .was-validated .form-check-input:invalid ~ .invalid-feedback { display: block; }
    .radio-group-invalid .form-check-label { color: #dc3545; }
    .radio-group-invalid .invalid-feedback { display: block !important; }
    .conditional-field { margin-top: 1rem; padding: 1rem; border-left: 3px solid #0d6efd; background-color: #f8f9fa; }
    @media (max-width: 767px) { .step-title { display: none; } }
    .thank-you-message { display: none; text-align: center; padding: 30px 0; }
    .thank-you-message.active { display: block; }
    .beneficiary-container { background-color: rgba(13, 110, 253, 0.05); padding: 15px; margin-bottom: 15px; border-radius: 4px; border: 1px solid #dee2e6; }
    .document-list { margin: 25px 0; border: 1px solid #dee2e6; border-radius: 8px; overflow: hidden; }
    .document-item { padding: 15px; border-bottom: 1px solid #dee2e6; display: flex; align-items: center; background-color: #fff; transition: background-color 0.3s; }
    .document-item:last-child { border-bottom: none; }
    .document-item:hover { background-color: #f8f9fa; }
    .document-icon { font-size: 24px; margin-right: 15px; color: #0d6efd; }
    .document-details { flex-grow: 1; }
    .document-title { font-weight: 500; font-size: 1.1rem; margin-bottom: 3px; }
    .document-description { color: #6c757d; font-size: 0.9rem; margin-bottom: 0; }
    .document-actions { display: flex; gap: 10px; }
    .badge-document { font-size: 0.75rem; padding: 5px 8px; margin-top: 5px; display: inline-block; }
    .document-content-modal { max-height: 500px; overflow-y: auto; padding: 20px; background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 6px; margin: 15px 0; font-size: 0.9rem; }
    .proceed-btn { transition: all 0.3s; }
    .proceed-btn.disabled { position: relative; cursor: not-allowed; opacity: 0.65; }
    .proceed-btn.disabled .proceed-lock { margin-right: 5px; }
    .download-progress { margin: 15px 0; height: 10px; }
    .pulse-animation { animation: pulse 1.5s infinite; }
    @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(40, 167, 69, 0); } 100% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0); } }
    .status-message { font-size: 0.9rem; color: #6c757d; margin-top: 10px; text-align: center; }
    .highlight-text { color: #0d6efd; font-weight: bold; }
    fieldset { border: none; padding: 0; margin: 0 0 1rem 0; }
    legend { font-size: 1rem; font-weight: normal; margin-bottom: 0.5rem; float: none; width: auto; padding: 0; }
    legend.visually-hidden { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border: 0; }

    /* --- NUOVI STILI PER RIDURRE ALTEZZA MENU --- */
    /* Selettore più specifico usando l'ID della sezione menu */
    /* Assicurati che l'ID #menu01-3s sia corretto per questa pagina */
    section#menu01-3s .navbar {
        padding-top: 0.4rem; /* Riduci padding sopra/sotto */
        padding-bottom: 0.4rem;
        min-height: auto; /* Permetti alla navbar di ridursi */
    }
    section#menu01-3s .navbar-brand .navbar-logo img {
        height: 2.2rem !important; /* Riduci altezza logo, !important per sovrascrivere stile inline */
        max-height: 2.2rem;
    }
    section#menu01-3s .navbar-nav .nav-link {
        padding-top: 0.3rem; /* Riduci padding link */
        padding-bottom: 0.3rem;
        font-size: 0.9rem; /* Opzionale: Riduci leggermente font */
    }
    section#menu01-3s .navbar-buttons .btn {
        padding: 0.3rem 0.8rem; /* Riduci padding bottone */
        font-size: 0.85rem; /* Riduci font bottone */
        /* Rimuovi btn-lg se presente per evitare padding extra */
    }
    section#menu01-3s .navbar-toggler {
        padding: 0.25rem 0.5rem; /* Riduci padding toggler mobile */
        font-size: 1rem; /* Riduci dimensione icona toggler */
    }
    /* Aggiusta padding top del body per la nuova altezza della navbar */
    body {
        padding-top: 55px; /* Valore stimato, aggiusta se necessario */
    }
    /* --- FINE NUOVI STILI MENU --- */

  </style>
</head>
<body>

  <!-- ================== MENU (ORA CON STILI PER RIDURRE ALTEZZA) ================== -->
  <section data-bs-version="5.1" class="inspirem5 menu menu1 cid-uHcV8yKzqs" once="menu" id="menu01-3s">
      <nav class="navbar navbar-dropdown navbar-fixed-top navbar-expand-lg">
        <div class="container-fluid">
          <div class="navbar-brand">
            <span class="navbar-logo">
              <a href="index.html#top">
                <img src="data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="LifeInsure Logo" style="height: 3.6rem" loading="lazy" class="lazyload" data-src="https://r.mobirisesite.com/1342903/assets/images/lifeinsure-1-172x172.png?v=1TZWWw" />
              </a>
            </span>
          </div>
          <button class="navbar-toggler" type="button" data-toggle="collapse" data-bs-toggle="collapse" data-target="#navbarSupportedContent" data-bs-target="#navbarSupportedContent" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation">
            <div class="hamburger"><span></span><span></span><span></span><span></span></div>
          </button>
          <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav nav-dropdown" data-app-modern-menu="true">
              <li class="nav-item"><a class="nav-link link text-primary display-7" href="index.html#header01-2">Home</a></li>
              <li class="nav-item dropdown">
                <a class="nav-link link text-primary dropdown-toggle display-7" href="#" data-toggle="dropdown-submenu" data-bs-toggle="dropdown" data-bs-auto-close="outside" aria-expanded="false">Polizza decesso</a>
                <div class="dropdown-menu" aria-labelledby="dropdown-707">
                  <a class="text-primary dropdown-item display-7" href="index.html#progress-bars02-0">Vantaggi</a>
                  <a class="text-primary show dropdown-item display-7" href="index.html#progress-bars01-j">Valore</a>
                  <a class="text-primary show dropdown-item display-7" href="#" data-toggle="modal" data-bs-toggle="modal" data-target="#mbr-popup-2k" data-bs-target="#mbr-popup-2k"><span class="mdi-content-markunread mbr-iconfont mbr-iconfont-btn"></span>Una storia vera (leggi)</a>
                  <a class="text-primary show dropdown-item display-7" href="index.html#testimonials04-g">Testimonianze</a>
                </div>
              </li>
              <li class="nav-item"><a class="nav-link link text-primary display-7" href="index.html#forms03-5">Chi siamo</a></li>
              <li class="nav-item"><a class="nav-link link text-primary display-7" href="index.html#forms03-5">Contatti</a></li>
              <li class="nav-item dropdown">
                 <a class="nav-link link text-primary dropdown-toggle show display-7" href="#" data-toggle="dropdown-submenu" data-bs-toggle="dropdown" data-bs-auto-close="outside" aria-expanded="false"><span class="icon54-v1-translate2 mbr-iconfont mbr-iconfont-btn"></span></a>
                 <div class="dropdown-menu show" aria-labelledby="dropdown-852" data-bs-popper="none">
                     <a class="text-primary dropdown-item display-7" href="https://de.lifeinsure.ch" target="_blank">Deutsch</a>
                     <a class="text-primary dropdown-item display-7" href="https://fr.lifeinsure.ch" target="_blank">Français</a>
                 </div>
              </li>
            </ul>
            <div class="navbar-buttons mbr-section-btn">
              <!-- Rimosso btn-lg per renderlo più piccolo con CSS -->
              <a class="btn btn-danger display-4" href="index.html#features04-2"><span class="icon54-v1-click-1 mbr-iconfont mbr-iconfont-btn"></span>PREVENTIVO&nbsp;</a>
            </div>
          </div>
        </div>
      </nav>
  </section>
  <!-- ================== FINE MENU ================== -->


  <!-- ================== CONTENUTO MODULO RICHIESTA OFFERTA (OTTIMIZZATO) ================== -->
  <div class="container py-5">
    <div class="row justify-content-center">
      <div class="col-lg-8">
        <div class="card shadow">
          <div class="card-header bg-primary text-white">
            <h4 class="mb-0">Richiesta Offerta Polizza Vita</h4>
          </div>
          <div class="card-body">
            <!-- Indicatore progressione -->
            <div class="step-indicator mb-4">
              <div class="step active" id="step-1">
                <div class="step-number">1</div>
                <div class="step-title">Dati personali</div>
              </div>
              <div class="step" id="step-2">
                <div class="step-number">2</div>
                <div class="step-title">Questionario medico</div>
              </div>
              <div class="step" id="step-3">
                <div class="step-number">3</div>
                <div class="step-title">Beneficiari e conferma</div>
              </div>
            </div>

            <div class="progress">
              <div class="progress-bar" role="progressbar" style="width: 33%" aria-valuenow="33" aria-valuemin="0" aria-valuemax="100"></div>
            </div>

            <form id="offer-request-form" novalidate>
              <!-- STEP 1: Dati personali -->
              <div class="form-section active" id="section-1">
                <div class="subtitle">Dati personali</div>

                <div class="row mb-3">
                  <div class="col-md-6">
                    <label for="firstname" class="form-label required-field">Nome</label>
                    <input type="text" class="form-control" id="firstname" name="firstname" required>
                    <div class="invalid-feedback">Inserisci il tuo nome</div>
                  </div>
                  <div class="col-md-6">
                    <label for="lastname" class="form-label required-field">Cognome</label>
                    <input type="text" class="form-control" id="lastname" name="lastname" required>
                    <div class="invalid-feedback">Inserisci il tuo cognome</div>
                  </div>
                </div>

                <div class="row mb-3">
                  <div class="col-md-6">
                    <label for="gender" class="form-label required-field">Genere</label>
                    <select class="form-select" id="gender" name="gender" required>
                      <option value="" selected disabled>Seleziona...</option>
                      <option value="M">Maschile</option>
                      <option value="F">Femminile</option>
                    </select>
                    <div class="invalid-feedback">Seleziona il tuo genere</div>
                  </div>
                  <div class="col-md-6">
                    <label for="birthdate" class="form-label required-field">Data di nascita</label>
                    <input type="date" class="form-control" id="birthdate" name="birthdate" required>
                    <div class="invalid-feedback">Inserisci la tua data di nascita</div>
                  </div>
                </div>

                <div class="mb-3">
                  <label for="street" class="form-label required-field">Indirizzo</label>
                  <input type="text" class="form-control" id="street" name="street" required>
                  <div class="invalid-feedback">Inserisci il tuo indirizzo</div>
                </div>

                <div class="row mb-3">
                  <div class="col-md-4">
                    <label for="zip" class="form-label required-field">CAP</label>
                    <input type="text" class="form-control" id="zip" name="zip" required pattern="\d{4}">
                    <div class="invalid-feedback">Inserisci un CAP svizzero valido (4 cifre)</div>
                  </div>
                  <div class="col-md-4">
                    <label for="city" class="form-label required-field">Citt&agrave;</label>
                    <input type="text" class="form-control" id="city" name="city" required>
                    <div class="invalid-feedback">Inserisci la tua citt&agrave;</div>
                  </div>
                  <div class="col-md-4">
                    <label for="country" class="form-label required-field">Paese</label>
                    <div class="input-group">
                      <input type="text" class="form-control" id="country" name="country" value="Svizzera" readonly>
                      <input type="hidden" name="country_code" value="CH">
                      <span class="input-group-text"><i class="bi bi-flag"></i></span>
                    </div>
                    <small class="text-muted">Solo residenti in Svizzera</small>
                  </div>
                </div>

                <div class="row mb-3">
                  <div class="col-md-6">
                    <label for="email" class="form-label required-field">Email</label>
                    <input type="email" class="form-control" id="email" name="email" required pattern="[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,}$">
                    <div class="invalid-feedback">Inserisci un indirizzo email valido</div>
                  </div>
                  <div class="col-md-6">
                    <label for="phone" class="form-label required-field">Telefono</label>
                    <input type="tel" class="form-control" id="phone" name="phone" required>
                    <div class="invalid-feedback">Inserisci un numero di telefono valido</div>
                  </div>
                </div>

                <div class="row mb-3">
                  <div class="col-md-6">
                    <label for="nationality" class="form-label required-field">Nazionalit&agrave;</label>
                    <select class="form-select" id="nationality" name="nationality" required>
                      <option value="CH" selected>Svizzera</option>
                      <option value="IT">Italiana</option>
                      <option value="DE">Tedesca</option>
                      <option value="FR">Francese</option>
                      <option value="AT">Austriaca</option>
                    </select>
                    <div class="invalid-feedback">Seleziona la tua nazionalit&agrave;</div>
                  </div>
                  <div class="col-md-6">
                    <label for="profession" class="form-label required-field">Professione</label>
                    <input type="text" class="form-control" id="profession" name="profession" required>
                    <div class="invalid-feedback">Inserisci la tua professione</div>
                  </div>
                </div>

                <div class="subtitle">Dettagli polizza</div>

                <div class="row mb-3">
                  <div class="col-md-6">
                    <label for="duration" class="form-label required-field">Durata (anni)</label>
                    <input type="number" class="form-control" id="duration" name="duration" min="1" max="40" value="10" required>
                    <div class="invalid-feedback">Inserisci la durata in anni (minimo 1, massimo 40)</div>
                  </div>
                  <div class="col-md-6">
                    <label for="coverage" class="form-label required-field">Copertura (CHF)</label>
                    <input type="number" class="form-control" id="coverage" name="coverage" min="50000" max="1000000" step="10000" value="100000" required>
                    <div class="invalid-feedback">Inserisci un importo di copertura valido (min 50'000, max 1'000'000)</div>
                  </div>
                </div>

                <div class="row mb-3">
                  <div class="col-md-6">
                    <label for="mode" class="form-label required-field">Modalit&agrave; di pagamento</label>
                    <select class="form-select" id="mode" name="mode" required>
                      <option value="annual" selected>Annuale</option>
                      <option value="monthly">Mensile</option>
                    </select>
                    <div class="invalid-feedback">Seleziona la modalit&agrave; di pagamento</div>
                  </div>
                  <div class="col-md-6">
                    <label for="payment_type" class="form-label required-field">Tipo di pagamento</label>
                    <select class="form-select" id="payment_type" name="payment_type" required>
                      <option value="e-bill" selected>E-Bill</option>
                      <option value="manual">Fattura con QR code</option>
                    </select>
                    <div class="invalid-feedback">Seleziona il tipo di pagamento</div>
                  </div>
                </div>

                <div class="d-flex justify-content-end mt-4">
                  <button type="button" id="next-1" class="btn btn-primary">Avanti <i class="bi bi-arrow-right"></i></button>
                </div>
              </div>

              <!-- STEP 2: Questionario medico (invariato) -->
              <div class="form-section" id="section-2">
                 <div class="subtitle">Informazioni di salute</div>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="height" class="form-label required-field">Altezza (cm)</label>
                        <input type="number" class="form-control" id="height" name="height" min="100" max="250" required>
                        <div class="invalid-feedback">Inserisci un'altezza valida (tra 100 e 250 cm)</div>
                    </div>
                    <div class="col-md-6">
                        <label for="weight" class="form-label required-field">Peso (kg)</label>
                        <input type="number" class="form-control" id="weight" name="weight" min="30" max="200" required>
                        <div class="invalid-feedback">Inserisci un peso valido (tra 30 e 200 kg)</div>
                    </div>
                </div>
                <fieldset class="mb-3">
                  <legend class="form-label required-field">Negli ultimi 2 anni hai fumato regolarmente o occasionalmente sigarette, sigari, pipa o sigarette elettroniche?</legend>
                  <div class="form-check"><input class="form-check-input" type="radio" id="smoker_yes" name="smoker" value="yes" required><label class="form-check-label" for="smoker_yes">S&igrave;</label></div>
                  <div class="form-check"><input class="form-check-input" type="radio" id="smoker_no" name="smoker" value="no" required><label class="form-check-label" for="smoker_no">No</label></div>
                  <div class="invalid-feedback">Seleziona una risposta</div>
                </fieldset>
                <fieldset class="mb-3">
                  <legend class="form-label required-field">Hai gi&agrave; altre assicurazioni sulla vita puro rischio decesso?</legend>
                  <div class="form-check"><input class="form-check-input" type="radio" id="existing_insurance_yes" name="existing_insurance" value="yes" required><label class="form-check-label" for="existing_insurance_yes">S&igrave;</label></div>
                  <div class="form-check"><input class="form-check-input" type="radio" id="existing_insurance_no" name="existing_insurance" value="no" required><label class="form-check-label" for="existing_insurance_no">No</label></div>
                  <div class="invalid-feedback">Seleziona una risposta</div>
                  <div id="existing_insurance_details" class="conditional-field d-none mt-2">
                    <label for="existing_coverage" class="form-label required-field">Copertura totale esistente (CHF)</label>
                    <input type="number" class="form-control" id="existing_coverage" name="existing_coverage" min="0">
                    <div class="invalid-feedback">Inserisci la copertura esistente (o 0).</div>
                  </div>
                </fieldset>
                <fieldset class="mb-3">
                  <legend class="form-label required-field">Hai assunto o ti sono stati prescritti farmaci per pi&ugrave; di 4 settimane consecutive negli ultimi 5 anni?</legend>
                  <div class="form-check"><input class="form-check-input" type="radio" id="medication_yes" name="medication" value="yes" required><label class="form-check-label" for="medication_yes">S&igrave;</label></div>
                  <div class="form-check"><input class="form-check-input" type="radio" id="medication_no" name="medication" value="no" required><label class="form-check-label" for="medication_no">No</label></div>
                   <div class="invalid-feedback">Seleziona una risposta</div>
                  <div id="medication_details" class="conditional-field d-none mt-2">
                    <fieldset class="mb-2">
                        <legend class="form-label required-field">La malattia sottostante &egrave; guarita senza conseguenze da almeno 2 anni?</legend>
                        <div class="form-check"><input class="form-check-input" type="radio" id="medication_resolved_yes" name="medication_resolved" value="yes"><label class="form-check-label" for="medication_resolved_yes">S&igrave;</label></div>
                        <div class="form-check"><input class="form-check-input" type="radio" id="medication_resolved_no" name="medication_resolved" value="no"><label class="form-check-label" for="medication_resolved_no">No</label></div>
                        <div class="invalid-feedback">Seleziona una risposta</div>
                    </fieldset>
                    <div>
                      <label for="medication_description" class="form-label">Descrizione (obbligatoria se hai risposto Sì alla domanda principale):</label>
                      <textarea class="form-control" id="medication_description" name="medication_description" rows="2"></textarea>
                      <div class="invalid-feedback">Fornisci una descrizione.</div>
                    </div>
                  </div>
                </fieldset>
                <fieldset class="mb-3">
                  <legend class="form-label required-field">Negli ultimi 5 anni hai avuto l'ipertensione?</legend>
                  <div class="form-check"><input class="form-check-input" type="radio" id="hypertension_yes" name="hypertension" value="yes" required><label class="form-check-label" for="hypertension_yes">S&igrave;</label></div>
                  <div class="form-check"><input class="form-check-input" type="radio" id="hypertension_no" name="hypertension" value="no" required><label class="form-check-label" for="hypertension_no">No</label></div>
                   <div class="invalid-feedback">Seleziona una risposta</div>
                </fieldset>
                <fieldset class="mb-3">
                  <legend class="form-label required-field">Sei stato ricoverato in ospedale negli ultimi 10 anni?</legend>
                  <div class="form-check"><input class="form-check-input" type="radio" id="hospitalization_yes" name="hospitalization" value="yes" required><label class="form-check-label" for="hospitalization_yes">S&igrave;</label></div>
                  <div class="form-check"><input class="form-check-input" type="radio" id="hospitalization_no" name="hospitalization" value="no" required><label class="form-check-label" for="hospitalization_no">No</label></div>
                   <div class="invalid-feedback">Seleziona una risposta</div>
                  <div id="hospitalization_details" class="conditional-field d-none mt-2">
                     <fieldset>
                        <legend class="form-label required-field">La malattia sottostante &egrave; guarita senza conseguenze da almeno 2 anni?</legend>
                        <div class="form-check"><input class="form-check-input" type="radio" id="hospitalization_resolved_yes" name="hospitalization_resolved" value="yes"><label class="form-check-label" for="hospitalization_resolved_yes">S&igrave;</label></div>
                        <div class="form-check"><input class="form-check-input" type="radio" id="hospitalization_resolved_no" name="hospitalization_resolved" value="no"><label class="form-check-label" for="hospitalization_resolved_no">No</label></div>
                        <div class="invalid-feedback">Seleziona una risposta</div>
                    </fieldset>
                  </div>
                </fieldset>
                <fieldset class="mb-3">
                  <legend class="form-label required-field">&Egrave; attualmente pianificato un esame (ECG, esami di laboratorio, ecografia, RMT, ecc.)?</legend>
                  <div class="form-check"><input class="form-check-input" type="radio" id="planned_exam_yes" name="planned_exam" value="yes" required><label class="form-check-label" for="planned_exam_yes">S&igrave;</label></div>
                  <div class="form-check"><input class="form-check-input" type="radio" id="planned_exam_no" name="planned_exam" value="no" required><label class="form-check-label" for="planned_exam_no">No</label></div>
                   <div class="invalid-feedback">Seleziona una risposta</div>
                </fieldset>
                <fieldset class="mb-3">
                  <legend class="form-label required-field">Negli ultimi 5 anni hai assunto stupefacenti o droghe o sei stato consigliato o trattato per questo?</legend>
                  <div class="form-check"><input class="form-check-input" type="radio" id="drugs_yes" name="drugs" value="yes" required><label class="form-check-label" for="drugs_yes">S&igrave;</label></div>
                  <div class="form-check"><input class="form-check-input" type="radio" id="drugs_no" name="drugs" value="no" required><label class="form-check-label" for="drugs_no">No</label></div>
                   <div class="invalid-feedback">Seleziona una risposta</div>
                </fieldset>
                <fieldset class="mb-3">
                  <legend class="form-label required-field">Ti &egrave; mai stata diagnosticata un'infezione da HIV (test AIDS positivo) o sei in attesa del risultato?</legend>
                  <div class="form-check"><input class="form-check-input" type="radio" id="hiv_yes" name="hiv" value="yes" required><label class="form-check-label" for="hiv_yes">S&igrave;</label></div>
                  <div class="form-check"><input class="form-check-input" type="radio" id="hiv_no" name="hiv" value="no" required><label class="form-check-label" for="hiv_no">No</label></div>
                   <div class="invalid-feedback">Seleziona una risposta</div>
                </fieldset>
                <fieldset class="mb-3">
                  <legend class="form-label required-field">Prevedi un soggiorno all'estero di durata superiore a 6 settimane nei prossimi 12 mesi? (Al di fuori di UE, Svizzera, Islanda, Norvegia, USA, Canada)</legend>
                  <div class="form-check"><input class="form-check-input" type="radio" id="foreign_stay_yes" name="foreign_stay" value="yes" required><label class="form-check-label" for="foreign_stay_yes">S&igrave;</label></div>
                  <div class="form-check"><input class="form-check-input" type="radio" id="foreign_stay_no" name="foreign_stay" value="no" required><label class="form-check-label" for="foreign_stay_no">No</label></div>
                   <div class="invalid-feedback">Seleziona una risposta</div>
                </fieldset>
                <fieldset class="mb-3">
                  <legend class="form-label required-field">Sei esposto a pericoli particolari nel lavoro o nel tempo libero? (es. manipolazione di esplosivi o armi, protezione personale, soggiorno in zone di crisi, gare automobilistiche, sport aerei, alpinismo, arrampicata, arti marziali, sport estremi, immersioni)</legend>
                  <div class="form-check"><input class="form-check-input" type="radio" id="dangerous_hobby_yes" name="dangerous_hobby" value="yes" required><label class="form-check-label" for="dangerous_hobby_yes">S&igrave;</label></div>
                  <div class="form-check"><input class="form-check-input" type="radio" id="dangerous_hobby_no" name="dangerous_hobby" value="no" required><label class="form-check-label" for="dangerous_hobby_no">No</label></div>
                   <div class="invalid-feedback">Seleziona una risposta</div>
                </fieldset>
                <fieldset class="mb-3">
                  <legend class="form-label required-field">Ricevi una pensione o un'indennit&agrave; giornaliera dall'assicurazione invalidit&agrave; o da un'assicurazione infortuni?</legend>
                  <div class="form-check"><input class="form-check-input" type="radio" id="pension_yes" name="pension" value="yes" required><label class="form-check-label" for="pension_yes">S&igrave;</label></div>
                  <div class="form-check"><input class="form-check-input" type="radio" id="pension_no" name="pension" value="no" required><label class="form-check-label" for="pension_no">No</label></div>
                   <div class="invalid-feedback">Seleziona una risposta</div>
                </fieldset>
                <fieldset class="mb-3">
                  <legend class="form-label required-field">Negli ultimi 5 anni, hai avuto assenze dal lavoro di oltre un mese per malattia?</legend>
                  <div class="form-check"><input class="form-check-input" type="radio" id="work_absence_yes" name="work_absence" value="yes" required><label class="form-check-label" for="work_absence_yes">S&igrave;</label></div>
                  <div class="form-check"><input class="form-check-input" type="radio" id="work_absence_no" name="work_absence" value="no" required><label class="form-check-label" for="work_absence_no">No</label></div>
                   <div class="invalid-feedback">Seleziona una risposta</div>
                  <div id="work_absence_details" class="conditional-field d-none mt-2">
                    <fieldset>
                        <legend class="form-label required-field">La condizione &egrave; risolta da almeno 2 anni senza trattamenti?</legend>
                        <div class="form-check"><input class="form-check-input" type="radio" id="work_absence_resolved_yes" name="work_absence_resolved" value="yes"><label class="form-check-label" for="work_absence_resolved_yes">S&igrave;</label></div>
                        <div class="form-check"><input class="form-check-input" type="radio" id="work_absence_resolved_no" name="work_absence_resolved" value="no"><label class="form-check-label" for="work_absence_resolved_no">No</label></div>
                        <div class="invalid-feedback">Seleziona una risposta</div>
                    </fieldset>
                  </div>
                </fieldset>
                <div class="subtitle">Condizioni mediche</div>
                <fieldset class="mb-3">
                  <legend class="form-label">Negli ultimi 5 anni, hai sofferto di una delle seguenti condizioni? (Seleziona tutte quelle applicabili)</legend>
                  <div class="form-check mb-2"><input class="form-check-input condition-checkbox" type="checkbox" id="heart_disease" name="conditions[]" value="heart_disease"><label class="form-check-label" for="heart_disease">Problemi cardiaci o infarto</label></div>
                  <div class="form-check mb-2"><input class="form-check-input condition-checkbox" type="checkbox" id="stroke" name="conditions[]" value="stroke"><label class="form-check-label" for="stroke">Ictus</label></div>
                  <div class="form-check mb-2"><input class="form-check-input condition-checkbox" type="checkbox" id="diabetes" name="conditions[]" value="diabetes"><label class="form-check-label" for="diabetes">Diabete</label></div>
                  <div class="form-check mb-2"><input class="form-check-input condition-checkbox" type="checkbox" id="cancer" name="conditions[]" value="cancer"><label class="form-check-label" for="cancer">Tumore</label></div>
                  <div class="form-check mb-2"><input class="form-check-input condition-checkbox" type="checkbox" id="respiratory" name="conditions[]" value="respiratory"><label class="form-check-label" for="respiratory">Problemi respiratori cronici (es. BPCO, enfisema)</label></div>
                  <div class="form-check mb-2"><input class="form-check-input condition-checkbox" type="checkbox" id="liver" name="conditions[]" value="liver"><label class="form-check-label" for="liver">Malattie del fegato</label></div>
                  <div class="form-check mb-2"><input class="form-check-input condition-checkbox" type="checkbox" id="kidney" name="conditions[]" value="kidney"><label class="form-check-label" for="kidney">Malattie renali</label></div>
                  <div class="form-check mb-2"><input class="form-check-input condition-checkbox" type="checkbox" id="epilepsy" name="conditions[]" value="epilepsy"><label class="form-check-label" for="epilepsy">Epilessia</label></div>
                  <div class="form-check mb-2"><input class="form-check-input condition-checkbox" type="checkbox" id="multiple_sclerosis" name="conditions[]" value="multiple_sclerosis"><label class="form-check-label" for="multiple_sclerosis">Sclerosi multipla</label></div>
                  <div class="form-check mb-2"><input class="form-check-input condition-checkbox" type="checkbox" id="mental_health" name="conditions[]" value="mental_health"><label class="form-check-label" for="mental_health">Problemi di salute mentale</label></div>
                  <div id="condition_details" class="conditional-field d-none mt-3">
                    <label for="condition_notes" class="form-label required-field">Fornisci dettagli sulle condizioni selezionate:</label>
                    <textarea class="form-control" id="condition_notes" name="condition_notes" rows="3"></textarea>
                    <div class="invalid-feedback">Fornisci dettagli sulle condizioni selezionate.</div>
                  </div>
                </fieldset>
                <div class="d-flex justify-content-between mt-4">
                  <button type="button" id="prev-2" class="btn btn-secondary"><i class="bi bi-arrow-left"></i> Indietro</button>
                  <button type="button" id="next-2" class="btn btn-primary">Avanti <i class="bi bi-arrow-right"></i></button>
                </div>
              </div>

              <!-- STEP 3: Beneficiari e Conferma (invariato) -->
              <div class="form-section" id="section-3">
                <div class="subtitle">Beneficiari</div>
                <div class="row mb-3">
                  <div class="col-md-12">
                    <label for="beneficiary_type" class="form-label required-field">Tipo di beneficiario</label>
                    <select class="form-select" id="beneficiary_type" name="beneficiary_type" required>
                      <option value="" selected disabled>Seleziona...</option>
                      <option value="spouse">Coniuge</option>
                      <option value="children">Figli (collettivamente)</option>
                      <option value="parents">Genitori (collettivamente)</option>
                      <option value="other">Altro (specificare)</option>
                    </select>
                    <div class="invalid-feedback">Seleziona il tipo di beneficiario</div>
                  </div>
                </div>
                <div id="other_beneficiary" class="conditional-field d-none">
                  <div id="beneficiary-list">
                      <div class="beneficiary-container" data-index="0">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                          <h6 class="mb-0">Beneficiario #1</h6>
                          <button type="button" class="btn btn-sm btn-outline-danger remove-beneficiary d-none" data-index="0"><i class="bi bi-trash"></i> Rimuovi</button>
                        </div>
                        <div class="row mb-3">
                          <div class="col-md-6">
                            <label for="beneficiary_firstname_0" class="form-label required-field">Nome</label>
                            <input type="text" class="form-control" id="beneficiary_firstname_0" name="beneficiary_firstname_0">
                             <div class="invalid-feedback">Inserisci il nome del beneficiario.</div>
                          </div>
                          <div class="col-md-6">
                            <label for="beneficiary_lastname_0" class="form-label required-field">Cognome</label>
                            <input type="text" class="form-control" id="beneficiary_lastname_0" name="beneficiary_lastname_0">
                            <div class="invalid-feedback">Inserisci il cognome del beneficiario.</div>
                          </div>
                        </div>
                        <div class="row mb-3">
                          <div class="col-md-8">
                            <label for="beneficiary_relation_0" class="form-label">Relazione con l'assicurato</label>
                            <input type="text" class="form-control" id="beneficiary_relation_0" name="beneficiary_relation_0">
                          </div>
                          <div class="col-md-4">
                            <label for="beneficiary_percentage_0" class="form-label required-field">Percentuale (%)</label>
                            <input type="number" class="form-control beneficiary-percentage" id="beneficiary_percentage_0" name="beneficiary_percentage_0" min="1" max="100" value="100" required>
                            <div class="invalid-feedback">Inserisci una percentuale valida (1-100).</div>
                          </div>
                        </div>
                      </div>
                  </div>
                  <template id="beneficiary-template">
                    <div class="beneficiary-container" data-index="{INDEX}">
                      <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="mb-0">Beneficiario #{NUMBER}</h6>
                        <button type="button" class="btn btn-sm btn-outline-danger remove-beneficiary" data-index="{INDEX}"><i class="bi bi-trash"></i> Rimuovi</button>
                      </div>
                      <div class="row mb-3">
                        <div class="col-md-6">
                          <label for="beneficiary_firstname_{INDEX}" class="form-label required-field">Nome</label>
                          <input type="text" class="form-control" id="beneficiary_firstname_{INDEX}" name="beneficiary_firstname_{INDEX}" required>
                           <div class="invalid-feedback">Inserisci il nome del beneficiario.</div>
                        </div>
                        <div class="col-md-6">
                          <label for="beneficiary_lastname_{INDEX}" class="form-label required-field">Cognome</label>
                          <input type="text" class="form-control" id="beneficiary_lastname_{INDEX}" name="beneficiary_lastname_{INDEX}" required>
                           <div class="invalid-feedback">Inserisci il cognome del beneficiario.</div>
                        </div>
                      </div>
                      <div class="row mb-3">
                        <div class="col-md-8">
                          <label for="beneficiary_relation_{INDEX}" class="form-label">Relazione con l'assicurato</label>
                          <input type="text" class="form-control" id="beneficiary_relation_{INDEX}" name="beneficiary_relation_{INDEX}">
                        </div>
                        <div class="col-md-4">
                          <label for="beneficiary_percentage_{INDEX}" class="form-label required-field">Percentuale (%)</label>
                          <input type="number" class="form-control beneficiary-percentage" id="beneficiary_percentage_{INDEX}" name="beneficiary_percentage_{INDEX}" min="1" max="100" required>
                           <div class="invalid-feedback">Inserisci una percentuale valida (1-100).</div>
                        </div>
                      </div>
                    </div>
                  </template>
                  <div class="alert alert-info mb-3" id="percentage-info" role="alert" aria-live="polite">Percentuale totale allocata: <strong id="total-percentage">100</strong>%</div>
                  <div class="text-center mb-3"><button type="button" id="add-beneficiary" class="btn btn-outline-primary"><i class="bi bi-plus-circle"></i> Aggiungi beneficiario</button></div>
                </div>
                <div class="subtitle">Consensi e Dichiarazioni</div>
                <div class="mb-3 form-check">
                    <input class="form-check-input" type="checkbox" id="privacy_consent" name="privacy_consent" required>
                    <label class="form-check-label required-field" for="privacy_consent">Ho letto e acconsento all'informativa sulla privacy e al trattamento dei miei dati personali per le finalit&agrave; indicate.</label>
                    <div class="invalid-feedback">Devi accettare l'informativa sulla privacy</div>
                </div>
                <div class="mb-3 form-check">
                    <input class="form-check-input" type="checkbox" id="terms_consent" name="terms_consent" required>
                    <label class="form-check-label required-field" for="terms_consent">Dichiaro che le informazioni fornite sono veritiere e complete e acconsento ai termini e condizioni del servizio.</label>
                    <div class="invalid-feedback">Devi accettare i termini e condizioni</div>
                </div>
                <div class="mb-3 form-check">
                    <input class="form-check-input" type="checkbox" id="mandate_consent" name="mandate_consent" required>
                    <label class="form-check-label required-field" for="mandate_consent">Conferisco mandato fiduciario per mediazione di servizi assicurativi a Lifensure SA.</label>
                    <div class="invalid-feedback">&Egrave; necessario conferire il mandato per procedere</div>
                </div>
                <div class="mb-3 form-check">
                    <input class="form-check-input" type="checkbox" id="marketing_consent" name="marketing_consent">
                    <label class="form-check-label" for="marketing_consent">Acconsento a ricevere comunicazioni commerciali e promozionali anche da terze parti (facoltativo).</label>
                </div>
                <div class="mb-4">
                  <label for="notes" class="form-label">Note aggiuntive (facoltativo)</label>
                  <textarea class="form-control" id="notes" name="notes" rows="3"></textarea>
                </div>
                <div class="d-flex justify-content-between mt-4">
                  <button type="button" id="prev-3" class="btn btn-secondary"><i class="bi bi-arrow-left"></i> Indietro</button>
                  <button type="submit" id="submit-form" class="btn btn-success"><i class="bi bi-check-lg"></i> Invia richiesta</button>
                </div>
              </div>
            </form>

            <!-- Messaggio di ringraziamento (invariato) -->
            <div class="thank-you-message" id="thank-you">
              <div class="alert alert-success mb-4" id="thank-you-alert">
                <h4 class="alert-heading">Grazie per la tua richiesta!</h4>
                <p>La tua richiesta di offerta &egrave; stata inviata con successo. Riceverai un'email di conferma all'indirizzo fornito.</p>
                <hr>
                <p class="mb-0">Un nostro consulente ti contatter&agrave; entro 48 ore lavorative.</p>
              </div>
              <p>Numero di riferimento: <strong id="reference-number">-</strong></p>
              <div class="card mt-4" id="documents-section">
                <div class="card-header bg-primary text-white"><h5 class="mb-0">Documenti di riepilogo</h5></div>
                <div class="card-body">
                  <p>Prima di procedere all'emissione della polizza, visualizza e scarica i seguenti documenti:</p>
                  <div class="progress download-progress"><div id="documents-progress-bar" class="progress-bar bg-primary" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div></div>
                  <div class="document-list" id="document-container"><div class="text-center p-4" id="documents-loading"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Caricamento documenti...</span></div><p class="mt-3">Recupero dei documenti in corso...</p></div></div>
                  <div class="status-message" id="download-status"><i class="bi bi-info-circle"></i> Visualizza e scarica <span class="highlight-text">tutti i documenti</span> per procedere all'emissione della polizza.</div>
                  <div class="d-grid gap-2 mt-4"><button id="proceed-button" class="btn btn-success btn-lg proceed-btn disabled" disabled><i class="bi bi-lock-fill proceed-lock"></i> Procedi con l'emissione della polizza</button></div>
                </div>
              </div>
              <button type="button" id="new-request" class="btn btn-link mt-3">Effettua una nuova richiesta</button>
            </div>

            <!-- Modal per visualizzare i documenti (invariato) -->
            <div class="modal fade" id="documentModal" tabindex="-1" aria-labelledby="documentModalLabel" aria-hidden="true">
              <div class="modal-dialog modal-lg">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title" id="documentModalLabel">Visualizza documento</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Chiudi"></button>
                  </div>
                  <div class="modal-body"><div class="document-content-modal" id="document-content"></div></div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Chiudi</button>
                    <button type="button" class="btn btn-primary" id="modal-download-btn"><i class="bi bi-download"></i> Scarica</button>
                  </div>
                </div>
              </div>
            </div>
          </div> <!-- Fine card-body -->
        </div> <!-- Fine card -->
      </div> <!-- Fine col -->
    </div> <!-- Fine row -->
  </div> <!-- Fine container -->
  <!-- ================== FINE CONTENUTO MODULO RICHIESTA OFFERTA ================== -->


  <!-- Script Bootstrap e Mobirise (invariati) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://r.mobirisesite.com/1342903/assets/smoothscroll/smooth-scroll.js"></script>
  <script src="https://r.mobirisesite.com/1342903/assets/ytplayer/index.js"></script>
  <script src="https://r.mobirisesite.com/1342903/assets/dropdown/js/navbar-dropdown.js"></script>
  <script src="https://r.mobirisesite.com/1342903/assets/theme/js/script.js"></script>

  <!-- Script personalizzato del modulo richiesta offerta (invariato rispetto all'ultima versione funzionante) -->
  <script>
    document.addEventListener("DOMContentLoaded", function() {
      'use strict'; // Abilita strict mode

      // --- COSTANTI E VARIABILI GLOBALI ---
      const BMI_UNDERWEIGHT_THRESHOLD = 18.5;
      const BMI_OBESE_THRESHOLD = 40;

      const form = document.getElementById("offer-request-form");
      const sections = document.querySelectorAll(".form-section");
      const progressBar = document.querySelector(".progress-bar");
      const steps = document.querySelectorAll(".step");
      const thankYouMessage = document.getElementById("thank-you");
      const thankYouAlert = document.getElementById("thank-you-alert");
      const documentsSection = document.getElementById("documents-section");

      // Bottoni di navigazione
      const nextBtn1 = document.getElementById("next-1");
      const nextBtn2 = document.getElementById("next-2");
      const prevBtn2 = document.getElementById("prev-2");
      const prevBtn3 = document.getElementById("prev-3");
      const submitBtn = document.getElementById("submit-form");
      const newRequestBtn = document.getElementById("new-request");

      // Elementi gestione documenti
      const documentContainer = document.getElementById("document-container");
      const documentsLoading = document.getElementById("documents-loading");
      const progressDocuments = document.getElementById("documents-progress-bar");
      const proceedButton = document.getElementById("proceed-button");
      const downloadStatus = document.getElementById("download-status");
      const documentModalElement = document.getElementById("documentModal");
      const documentModal = documentModalElement ? new bootstrap.Modal(documentModalElement) : null;
      const documentContent = document.getElementById("document-content");
      const documentModalLabel = document.getElementById("documentModalLabel");
      const modalDownloadBtn = document.getElementById("modal-download-btn");

      // Elementi campi condizionali
      const existingInsuranceRadios = document.querySelectorAll('input[name="existing_insurance"]');
      const existingInsuranceDetails = document.getElementById("existing_insurance_details");
      const existingCoverageInput = document.getElementById("existing_coverage");
      const medicationRadios = document.querySelectorAll('input[name="medication"]');
      const medicationDetails = document.getElementById("medication_details");
      const medicationDescription = document.getElementById("medication_description");
      const medicationResolvedRadios = medicationDetails?.querySelectorAll('input[name="medication_resolved"]');
      const hospitalizationRadios = document.querySelectorAll('input[name="hospitalization"]');
      const hospitalizationDetails = document.getElementById("hospitalization_details");
      const hospitalizationResolvedRadios = hospitalizationDetails?.querySelectorAll('input[name="hospitalization_resolved"]');
      const workAbsenceRadios = document.querySelectorAll('input[name="work_absence"]');
      const workAbsenceDetails = document.getElementById("work_absence_details");
      const workAbsenceResolvedRadios = workAbsenceDetails?.querySelectorAll('input[name="work_absence_resolved"]');
      const conditionCheckboxes = document.querySelectorAll('.condition-checkbox');
      const conditionDetails = document.getElementById("condition_details");
      const conditionNotes = document.getElementById("condition_notes");

      // Elementi beneficiari
      const beneficiaryTypeSelect = document.getElementById("beneficiary_type");
      const otherBeneficiarySection = document.getElementById("other_beneficiary");
      const beneficiaryList = document.getElementById("beneficiary-list");
      const beneficiaryTemplate = document.getElementById("beneficiary-template");
      const addBeneficiaryBtn = document.getElementById('add-beneficiary');
      const totalPercentageDisplay = document.getElementById('total-percentage');
      const percentageInfoAlert = document.getElementById('percentage-info');

      // Stato interno
      let currentStep = 1;
      let beneficiaryCount = 1;
      let beneficiaryIndexes = [0];
      let documentsViewed = 0;
      let documentsDownloaded = 0;
      let totalDocuments = 4;
      let documentTypes = [];
      let sessionStorageAvailable = false;

      // --- CONTROLLO FUNZIONALITÀ BROWSER ---
      try {
          sessionStorage.setItem('test', 'test');
          sessionStorage.removeItem('test');
          sessionStorageAvailable = true;
      } catch (e) {
          console.warn("SessionStorage non è disponibile o accessibile.");
      }

      // --- FUNZIONI API SIMULATE (invariate) ---
      async function fetchDocumentsFromAPI(referenceNumber, userData) {
        console.log("[Simulazione] Recupero documenti per:", referenceNumber);
        return new Promise((resolve) => {
          setTimeout(() => {
            const simulatedDocuments = [
              { id: "summary", title: "Riepilogo Dati Personali", description: "Dati personali e dettagli polizza", url: `#simulated_download/${referenceNumber}/summary.pdf`, contentUrl: `#simulated_content/${referenceNumber}/summary` },
              { id: "terms", title: "Termini e Condizioni", description: "Termini generali del servizio", url: `#simulated_download/${referenceNumber}/terms.pdf`, contentUrl: `#simulated_content/${referenceNumber}/terms` },
              { id: "privacy", title: "Informativa Privacy", description: "Trattamento dati personali", url: `#simulated_download/${referenceNumber}/privacy.pdf`, contentUrl: `#simulated_content/${referenceNumber}/privacy` },
              { id: "conditions", title: "Condizioni Assicurazione", description: "Condizioni contrattuali polizza", url: `#simulated_download/${referenceNumber}/conditions.pdf`, contentUrl: `#simulated_content/${referenceNumber}/conditions` }
            ];
            resolve(simulatedDocuments);
          }, 1000);
        });
      }
      async function getDocumentContentFromAPI(documentId, referenceNumber) {
         console.log("[Simulazione] Recupero contenuto per:", documentId, "Ref:", referenceNumber);
         return new Promise((resolve) => {
            setTimeout(() => {
                let simulatedContent = `<p>Contenuto simulato per <strong>${documentId}</strong> (Ref: ${referenceNumber}).</p><p>Questo testo sostituisce il contenuto reale che verrebbe caricato dal backend.</p>`;
                resolve(simulatedContent);
            }, 500);
         });
      }
      async function downloadDocumentFromAPI(documentId, referenceNumber) {
        console.log("[Simulazione] Download per:", documentId, "Ref:", referenceNumber);
        return new Promise((resolve) => {
            setTimeout(() => {
                const simulatedUrl = `data:text/plain;charset=utf-8,Contenuto%20simulato%20del%20documento%20${documentId}%20per%20${referenceNumber}.txt`;
                resolve(simulatedUrl);
            }, 800);
        });
      }

      // --- FUNZIONI GESTIONE DOCUMENTI (invariate) ---
      function createDocumentElements() {
        if (!documentContainer || !documentsLoading) return;
        documentContainer.innerHTML = "";
        documentsLoading.style.display = 'none';

        if (!documentTypes || documentTypes.length === 0) {
            documentContainer.innerHTML = '<div class="alert alert-warning">Nessun documento da visualizzare.</div>';
            return;
        }
        documentTypes.forEach((doc) => {
          const item = document.createElement("div");
          item.className = "document-item";
          item.dataset.docId = doc.id;
          const icon = getDocumentIcon(doc.id);
          item.innerHTML = `
            <div class="document-icon"><i class="bi ${icon}"></i></div>
            <div class="document-details">
              <h5 class="document-title">${doc.title || 'N/D'}</h5>
              <p class="document-description">${doc.description || 'N/D'}</p>
              <div>
                <span class="badge bg-warning badge-document viewed-badge"><i class="bi bi-eye-slash"></i> Non visualizzato</span>
                <span class="badge bg-danger badge-document downloaded-badge"><i class="bi bi-x-circle"></i> Non scaricato</span>
              </div>
            </div>
            <div class="document-actions">
              <button class="btn btn-primary btn-sm view-document" data-doc-id="${doc.id}"><i class="bi bi-eye"></i> Visualizza</button>
              <button class="btn btn-success btn-sm download-document" data-doc-id="${doc.id}" disabled><i class="bi bi-download"></i> Scarica</button>
            </div>`;
          documentContainer.appendChild(item);
          updateDocumentUI(doc.id);
        });
        setupDocumentListeners();
      }
      function setupDocumentListeners() {
        documentContainer?.querySelectorAll(".view-document").forEach(button => {
          button.replaceWith(button.cloneNode(true));
        });
        documentContainer?.querySelectorAll(".download-document").forEach(button => {
           button.replaceWith(button.cloneNode(true));
        });
        documentContainer?.querySelectorAll(".view-document").forEach(button => {
          button.addEventListener("click", function() { showDocumentInModal(this.dataset.docId); });
        });
        documentContainer?.querySelectorAll(".download-document").forEach(button => {
          button.addEventListener("click", function() { downloadDocument(this.dataset.docId); });
        });
      }
      async function showDocumentInModal(docId) {
        const docData = documentTypes.find(doc => doc.id === docId);
        if (!docData || !documentModal || !documentModalLabel || !documentContent || !modalDownloadBtn) return;

        documentModalLabel.textContent = docData.title || "Visualizza documento";
        documentContent.innerHTML = `<div class="text-center p-4"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Caricamento...</span></div><p class="mt-3">Caricamento...</p></div>`;
        documentModal.show();

        try {
          const refNum = sessionStorageAvailable ? sessionStorage.getItem("referenceNumber") : null;
          if (!refNum) throw new Error("Riferimento non trovato.");
          const content = await getDocumentContentFromAPI(docId, refNum);
          documentContent.innerHTML = content;

          modalDownloadBtn.dataset.docId = docId;
          modalDownloadBtn.disabled = docData.downloaded;
          modalDownloadBtn.innerHTML = docData.downloaded ? '<i class="bi bi-check"></i> Già scaricato' : '<i class="bi bi-download"></i> Scarica';

          const newModalBtn = modalDownloadBtn.cloneNode(true);
          modalDownloadBtn.parentNode.replaceChild(newModalBtn, modalDownloadBtn);
          newModalBtn.addEventListener('click', function() { downloadDocument(docId); documentModal.hide(); });

          if (!docData.viewed) {
            docData.viewed = true;
            documentsViewed = documentTypes.filter(d => d.viewed).length;
            updateDocumentUI(docId);
            updateProgressBarAndStatus();
            saveDocumentState();
          }
        } catch (error) {
          console.error("Errore caricamento contenuto:", error);
          documentContent.innerHTML = `<div class="alert alert-danger"><h5>Errore</h5><p>Impossibile caricare il contenuto. Prova a scaricarlo.</p><p><small>${error.message}</small></p></div>`;
          modalDownloadBtn.disabled = true;
          modalDownloadBtn.innerHTML = '<i class="bi bi-download"></i> Scarica';
        }
      }
      async function downloadDocument(docId) {
        const docData = documentTypes.find(doc => doc.id === docId);
        const downloadBtn = documentContainer?.querySelector(`.download-document[data-doc-id="${docId}"]`);
        if (!docData || docData.downloaded || !downloadBtn) return;

        downloadBtn.disabled = true;
        downloadBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';

        try {
          const refNum = sessionStorageAvailable ? sessionStorage.getItem("referenceNumber") : null;
          if (!refNum) throw new Error("Riferimento non trovato.");
          const downloadData = await downloadDocumentFromAPI(docId, refNum);

          if (typeof downloadData === 'string') {
            const link = document.createElement('a');
            link.href = downloadData;
            link.download = `${(docData.title || docId).replace(/\s+/g, '_')}.txt`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
          } else { throw new Error("Formato download non gestito."); }

          docData.downloaded = true;
          documentsDownloaded = documentTypes.filter(d => d.downloaded).length;
          updateDocumentUI(docId);
          updateProgressBarAndStatus();
          checkAllDocumentsDownloaded();
          saveDocumentState();
        } catch (error) {
          console.error("Errore download:", error);
          alert(`Errore download: ${error.message}.`);
          if (!docData.downloaded) {
              downloadBtn.disabled = !docData.viewed;
              downloadBtn.innerHTML = '<i class="bi bi-download"></i> Scarica';
          }
        }
      }
      function updateDocumentUI(docId) {
        const item = documentContainer?.querySelector(`.document-item[data-doc-id="${docId}"]`);
        const docData = documentTypes.find(doc => doc.id === docId);
        if (!item || !docData) return;
        const viewedBadge = item.querySelector('.viewed-badge');
        const downloadedBadge = item.querySelector('.downloaded-badge');
        const downloadBtn = item.querySelector('.download-document');
        if (viewedBadge) {
          viewedBadge.className = `badge badge-document viewed-badge ${docData.viewed ? 'bg-success' : 'bg-warning'}`;
          viewedBadge.innerHTML = docData.viewed ? '<i class="bi bi-eye-fill"></i> Visualizzato' : '<i class="bi bi-eye-slash"></i> Non visualizzato';
        }
        if (downloadedBadge) {
          downloadedBadge.className = `badge badge-document downloaded-badge ${docData.downloaded ? 'bg-success' : 'bg-danger'}`;
          downloadedBadge.innerHTML = docData.downloaded ? '<i class="bi bi-check-circle"></i> Scaricato' : '<i class="bi bi-x-circle"></i> Non scaricato';
        }
        if (downloadBtn) {
          downloadBtn.disabled = !docData.viewed || docData.downloaded;
          downloadBtn.innerHTML = docData.downloaded ? '<i class="bi bi-check"></i> Scaricato' : '<i class="bi bi-download"></i> Scarica';
        }
      }
      function updateProgressBarAndStatus() {
        if (!progressDocuments || !downloadStatus || totalDocuments === 0) return;
        documentsViewed = documentTypes.filter(d => d.viewed).length;
        documentsDownloaded = documentTypes.filter(d => d.downloaded).length;
        const percentage = Math.floor((documentsDownloaded / totalDocuments) * 100);
        progressDocuments.style.width = percentage + "%";
        progressDocuments.setAttribute("aria-valuenow", percentage);
        updateStatusMessage();
      }
      function updateStatusMessage() {
        if (!downloadStatus || totalDocuments === 0) return;
        if (documentsDownloaded === 0) downloadStatus.innerHTML = `<i class="bi bi-info-circle"></i> Visualizza e scarica <span class="highlight-text">${totalDocuments} documenti</span> per procedere.`;
        else if (documentsDownloaded < totalDocuments) downloadStatus.innerHTML = `<i class="bi bi-exclamation-circle"></i> Hai scaricato <span class="highlight-text">${documentsDownloaded} di ${totalDocuments}</span> documenti. Ne mancano ${totalDocuments - documentsDownloaded}.`;
        else downloadStatus.innerHTML = '<i class="bi bi-check-circle-fill text-success"></i> <span class="highlight-text">Tutti i documenti sono stati scaricati</span>. Puoi procedere.';
      }
      function checkAllDocumentsDownloaded() {
        if (!proceedButton) return;
        const allDownloaded = totalDocuments > 0 && documentsDownloaded === totalDocuments;
        proceedButton.classList.toggle("disabled", !allDownloaded);
        proceedButton.disabled = !allDownloaded;
        proceedButton.classList.toggle("pulse-animation", allDownloaded);
        proceedButton.innerHTML = allDownloaded
          ? '<i class="bi bi-arrow-right-circle"></i> Procedi con l\'emissione della polizza'
          : '<i class="bi bi-lock-fill proceed-lock"></i> Procedi con l\'emissione della polizza';

        const newProceedBtn = proceedButton.cloneNode(true);
        proceedButton.parentNode.replaceChild(newProceedBtn, proceedButton);
        if (allDownloaded) {
          newProceedBtn.addEventListener("click", function() {
            if (sessionStorageAvailable) {
                 const refNum = sessionStorage.getItem("referenceNumber");
                 // Salva dati necessari per il modulo di emissione
                 sessionStorage.setItem("finalOfferData", JSON.stringify({ reference: refNum }));
                 // Salva anche dati utente e preventivo per il modulo emissione
                 saveUserDataToSession(); // Assicurati che questa funzione esista e salvi i dati corretti
                 saveQuoteDataToSession(); // Assicurati che questa funzione esista e salvi i dati corretti
             }
            // !!! MODIFICARE QUESTO LINK ALLA PAGINA DI EMISSIONE REALE !!!
            window.location.href = "page8.html"; // O il nome corretto della pagina di emissione
          });
        }
      }
      function saveDocumentState() {
        if (!sessionStorageAvailable) return;
        try {
            const state = {
              viewedCount: documentsViewed, downloadedCount: documentsDownloaded, totalCount: totalDocuments,
              documents: documentTypes.map(d => ({ id: d.id, viewed: d.viewed, downloaded: d.downloaded }))
            };
            sessionStorage.setItem("documentsState", JSON.stringify(state));
        } catch (error) { console.error("Errore salvataggio stato documenti:", error); }
      }
      function loadDocumentState() {
        if (!sessionStorageAvailable) return;
        try {
            const stateString = sessionStorage.getItem("documentsState");
            if (stateString) {
              const parsedState = JSON.parse(stateString);
              if (parsedState.totalCount === totalDocuments && parsedState.documents?.length === totalDocuments) {
                  documentsViewed = parsedState.viewedCount || 0;
                  documentsDownloaded = parsedState.downloadedCount || 0;
                  documentTypes.forEach(localDoc => {
                      const savedDoc = parsedState.documents.find(saved => saved.id === localDoc.id);
                      if (savedDoc) { localDoc.viewed = savedDoc.viewed; localDoc.downloaded = savedDoc.downloaded; }
                  });
                  console.log("Stato documenti caricato.");
              } else { sessionStorage.removeItem("documentsState"); }
            }
        } catch (error) { console.error("Errore caricamento stato documenti:", error); sessionStorage.removeItem("documentsState"); }
      }
      // Funzioni per salvare dati utente/preventivo (da implementare se necessario)
      function saveUserDataToSession() {
          if (!sessionStorageAvailable || !form) return;
          try {
              const userData = {
                  firstname: document.getElementById('firstname')?.value,
                  lastname: document.getElementById('lastname')?.value,
                  gender: document.getElementById('gender')?.value,
                  birthdate: document.getElementById('birthdate')?.value,
                  street: document.getElementById('street')?.value,
                  zip: document.getElementById('zip')?.value,
                  city: document.getElementById('city')?.value,
                  email: document.getElementById('email')?.value,
                  phone: document.getElementById('phone')?.value,
                  nationality: document.getElementById('nationality')?.value,
                  profession: document.getElementById('profession')?.value,
                  // Aggiungere altri dati rilevanti se necessario
              };
              sessionStorage.setItem('datiUtente', JSON.stringify(userData));
              console.log("Dati utente salvati in sessionStorage.");
          } catch (error) {
              console.error("Errore salvataggio dati utente:", error);
          }
      }
      function saveQuoteDataToSession() {
           if (!sessionStorageAvailable || !form) return;
           try {
               const quoteData = {
                   duration: document.getElementById('duration')?.value,
                   coverage: document.getElementById('coverage')?.value,
                   mode: document.getElementById('mode')?.value,
                   payment_type: document.getElementById('payment_type')?.value,
                   // Aggiungere dati questionario medico se rilevanti per emissione
                   height: document.getElementById('height')?.value,
                   weight: document.getElementById('weight')?.value,
                   smoker: document.querySelector('input[name="smoker"]:checked')?.value,
                   // ... altri dati ...
               };
               sessionStorage.setItem('datiPreventivo', JSON.stringify(quoteData)); // Usa la stessa chiave del modulo preventivo? O una nuova?
               console.log("Dati preventivo/questionario salvati in sessionStorage.");
           } catch (error) {
                console.error("Errore salvataggio dati preventivo/questionario:", error);
           }
      }


      // --- FUNZIONI NAVIGAZIONE E VALIDAZIONE FORM (invariate) ---
      function goToStep(stepNumber) {
        if (!form || !progressBar || !steps.length) return;
        currentStep = stepNumber;
        sections.forEach(section => section.classList.remove("active", "was-validated"));
        const currentSection = document.getElementById(`section-${stepNumber}`);
        if (currentSection) currentSection.classList.add("active");

        steps.forEach((step, index) => {
          step.classList.remove("active", "completed");
          if (index + 1 === stepNumber) step.classList.add("active");
          else if (index + 1 < stepNumber) step.classList.add("completed");
        });
        const progressPercentage = Math.max(0, (stepNumber - 1) / 3 * 100);
        progressBar.style.width = progressPercentage + "%";
        progressBar.setAttribute("aria-valuenow", progressPercentage);
        window.scrollTo({ top: form.offsetTop - 80, behavior: 'smooth' });
      }
      function validateStep(stepNumber) {
        const section = document.getElementById(`section-${stepNumber}`);
        if (!section) return false;
        section.classList.add('was-validated');
        let isStepValid = true;
        let firstInvalidField = null; // Per scrollare al primo errore

        // Validazione input/select/textarea required visibili
        section.querySelectorAll('input[required], select[required], textarea[required]').forEach(input => {
            if (input.offsetParent !== null) { // Controlla se è visibile
                if (!input.checkValidity()){
                     isStepValid = false;
                     if (!firstInvalidField) firstInvalidField = input; // Salva il primo
                }
            }
        });
        // Validazione radio visibili
        if (!validateRadioGroups(section)) {
            isStepValid = false;
            if (!firstInvalidField) {
                // Trova il primo gruppo radio invalido per lo scroll
                firstInvalidField = section.querySelector('.radio-group-invalid');
            }
        }
        // Validazione campi testuali condizionali obbligatori (se visibili)
        if (stepNumber === 2) {
             if (medicationDetails && !medicationDetails.classList.contains('d-none') && medicationRadios[0].checked && !medicationDescription.value) {
                 medicationDescription.classList.add('is-invalid'); isStepValid = false; if (!firstInvalidField) firstInvalidField = medicationDescription;
             } else { medicationDescription?.classList.remove('is-invalid'); }

             if (conditionDetails && !conditionDetails.classList.contains('d-none') && conditionCheckboxesChecked() && !conditionNotes.value) {
                 conditionNotes.classList.add('is-invalid'); isStepValid = false; if (!firstInvalidField) firstInvalidField = conditionNotes;
             } else { conditionNotes?.classList.remove('is-invalid'); }

             if (existingInsuranceDetails && !existingInsuranceDetails.classList.contains('d-none') && existingInsuranceRadios[0].checked && !existingCoverageInput.value) {
                 existingCoverageInput.classList.add('is-invalid'); isStepValid = false; if (!firstInvalidField) firstInvalidField = existingCoverageInput;
             } else { existingCoverageInput?.classList.remove('is-invalid'); }
        }
        // Validazione percentuale beneficiari
        if (stepNumber === 3 && beneficiaryTypeSelect?.value === 'other') {
             const totalPercentage = calculateTotalPercentage();
             if (totalPercentage !== 100) {
                 percentageInfoAlert?.classList.remove('alert-success', 'alert-info');
                 percentageInfoAlert?.classList.add('alert-danger');
                 isStepValid = false;
                 if (!firstInvalidField) firstInvalidField = percentageInfoAlert; // Scrolla all'alert
             } else {
                 percentageInfoAlert?.classList.remove('alert-danger', 'alert-info');
                 percentageInfoAlert?.classList.add('alert-success');
             }
         }
        if (!isStepValid && firstInvalidField) {
            firstInvalidField.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
        return isStepValid;
      }
      function validateRadioGroups(section) {
          let allGroupsValid = true;
          const radioGroups = {};
          section.querySelectorAll('input[type="radio"]').forEach(radio => {
              if (!radioGroups[radio.name]) radioGroups[radio.name] = { radios: [], container: radio.closest('fieldset') || radio.closest('.mb-3'), isVisible: false };
              radioGroups[radio.name].radios.push(radio);
              if (radio.offsetParent !== null) radioGroups[radio.name].isVisible = true;
          });
          for (const name in radioGroups) {
              const group = radioGroups[name];
              const feedbackElement = group.container?.querySelector('.invalid-feedback');
              if (group.isVisible) {
                  const isChecked = group.radios.some(radio => radio.checked);
                  if (!isChecked) {
                      allGroupsValid = false;
                      group.container?.classList.add('radio-group-invalid');
                      if (feedbackElement) feedbackElement.style.display = 'block';
                  } else {
                      group.container?.classList.remove('radio-group-invalid');
                      if (feedbackElement) feedbackElement.style.display = '';
                  }
              } else {
                  group.container?.classList.remove('radio-group-invalid');
                  if (feedbackElement) feedbackElement.style.display = '';
              }
          }
          return allGroupsValid;
      }

      // --- FUNZIONI GESTIONE BENEFICIARI (invariate) ---
      function calculateTotalPercentage() {
          let total = 0;
          beneficiaryList?.querySelectorAll('.beneficiary-percentage').forEach(input => { total += parseInt(input.value, 10) || 0; });
          return total;
      }
      function updateTotalPercentageDisplay() {
          if (!beneficiaryTypeSelect || beneficiaryTypeSelect.value !== 'other' || !totalPercentageDisplay || !percentageInfoAlert || !submitBtn) return;
          const total = calculateTotalPercentage();
          totalPercentageDisplay.textContent = total;
          percentageInfoAlert.classList.remove('alert-success', 'alert-warning', 'alert-danger', 'alert-info');
          if (total === 100) { percentageInfoAlert.classList.add('alert-success'); submitBtn.disabled = false; }
          else if (total < 100) { percentageInfoAlert.classList.add('alert-warning'); submitBtn.disabled = true; }
          else { percentageInfoAlert.classList.add('alert-danger'); submitBtn.disabled = true; }
      }
      function distributePercentages() {
          const inputs = Array.from(beneficiaryList?.querySelectorAll('.beneficiary-percentage') || []);
          const count = inputs.length;
          if (count === 0) return;
          const base = Math.floor(100 / count);
          const remainder = 100 % count;
          inputs.forEach((input, index) => { input.value = base + (index < remainder ? 1 : 0); });
          updateTotalPercentageDisplay();
      }
      function addBeneficiary() {
          if (!beneficiaryTemplate || !beneficiaryList) return;
          beneficiaryCount++;
          const newIndex = Date.now();
          beneficiaryIndexes.push(newIndex);
          const templateNode = beneficiaryTemplate.content.cloneNode(true);
          const newElement = templateNode.firstElementChild;
          if (!newElement) return;

          newElement.dataset.index = newIndex;
          newElement.querySelector('h6').textContent = `Beneficiario #${beneficiaryCount}`;
          newElement.querySelectorAll('[id*="{INDEX}"]').forEach(el => { el.id = el.id.replace('{INDEX}', newIndex); });
          newElement.querySelectorAll('[name*="{INDEX}"]').forEach(el => { el.name = el.name.replace('{INDEX}', newIndex); });
          newElement.querySelectorAll('[for*="{INDEX}"]').forEach(el => { el.htmlFor = el.htmlFor.replace('{INDEX}', newIndex); });
          newElement.querySelectorAll('[data-index="{INDEX}"]').forEach(el => { el.dataset.index = newIndex; });

          newElement.querySelector('.beneficiary-percentage')?.addEventListener('input', updateTotalPercentageDisplay);
          newElement.querySelector('.remove-beneficiary')?.addEventListener('click', function() { removeBeneficiary(newIndex); });
          beneficiaryList.appendChild(newElement);

          if (beneficiaryCount > 1) {
              beneficiaryList.querySelector('.beneficiary-container[data-index="0"] .remove-beneficiary')?.classList.remove('d-none');
          }
          distributePercentages();
      }
      function removeBeneficiary(indexToRemove) {
          const container = beneficiaryList?.querySelector(`.beneficiary-container[data-index="${indexToRemove}"]`);
          if (!container) return;
          container.remove();
          beneficiaryCount--;
          beneficiaryIndexes = beneficiaryIndexes.filter(idx => idx !== indexToRemove);
          beneficiaryList?.querySelectorAll('.beneficiary-container').forEach((cont, idx) => { cont.querySelector('h6').textContent = `Beneficiario #${idx + 1}`; });
          if (beneficiaryCount === 1) {
              beneficiaryList?.querySelector('.beneficiary-container[data-index="0"] .remove-beneficiary')?.classList.add('d-none');
          }
          distributePercentages();
      }

      // --- FUNZIONI AUSILIARIE (invariate) ---
      function generateUniqueIdPlaceholder() { return 'REQ-' + Math.random().toString(36).substring(2, 10).toUpperCase(); }
      function getDocumentIcon(id) {
          switch(id) {
              case "summary": return "bi-file-earmark-person";
              case "terms": return "bi-file-earmark-ruled";
              case "privacy": return "bi-shield-lock";
              case "conditions": return "bi-file-earmark-medical";
              default: return "bi-file-earmark";
          }
      }
      function conditionCheckboxesChecked() { return Array.from(conditionCheckboxes).some(cb => cb.checked); }
      function checkIfRequiresManualVerification() {
          const heightCm = parseFloat(document.getElementById('height')?.value);
          const weightKg = parseFloat(document.getElementById('weight')?.value);
          let requiresVerification = false;
          if (heightCm && weightKg) {
              const heightM = heightCm / 100;
              const bmi = weightKg / (heightM * heightM);
              if (bmi < BMI_UNDERWEIGHT_THRESHOLD || bmi > BMI_OBESE_THRESHOLD) requiresVerification = true;
          }
          const criticalYesAnswers = ["hypertension_yes", "planned_exam_yes", "drugs_yes", "hiv_yes", "foreign_stay_yes", "dangerous_hobby_yes", "pension_yes"];
          if (!requiresVerification) {
              for (const id of criticalYesAnswers) { if (document.getElementById(id)?.checked) { requiresVerification = true; break; } }
          }
          if (!requiresVerification && conditionCheckboxesChecked()) requiresVerification = true;
          if (!requiresVerification && document.getElementById('medication_yes')?.checked && document.getElementById('medication_resolved_no')?.checked) requiresVerification = true;
          if (!requiresVerification && document.getElementById('hospitalization_yes')?.checked && document.getElementById('hospitalization_resolved_no')?.checked) requiresVerification = true;
          if (!requiresVerification && document.getElementById('work_absence_yes')?.checked && document.getElementById('work_absence_resolved_no')?.checked) requiresVerification = true;
          if(requiresVerification) console.log("Verifica manuale richiesta.");
          return requiresVerification;
      }

      // --- GESTIONE INVIO FORM (invariata) ---
      async function submitFormAction(requiresManualVerification) {
        if (!submitBtn || !form || !thankYouMessage || !documentsSection || !thankYouAlert) return;
        // Usa setButtonLoading helper
        const submitButtonHelper = {
            button: submitBtn,
            setLoading: function(isLoading, text) {
                setButtonLoading(this.button, isLoading, text);
            }
        };
        submitButtonHelper.setLoading(true, 'Invio in corso...');

        await new Promise(resolve => setTimeout(resolve, 1500));
        const referenceNumber = generateUniqueIdPlaceholder();

        if (sessionStorageAvailable) sessionStorage.setItem("referenceNumber", referenceNumber);
        document.getElementById("reference-number").textContent = referenceNumber;

        form.style.display = "none";
        document.querySelector(".step-indicator")?.style.display = "none";
        document.querySelector(".progress")?.style.display = "none";
        thankYouMessage.classList.add("active");

        if (requiresManualVerification) {
          thankYouAlert.className = "alert alert-info mb-4";
          thankYouAlert.innerHTML = `<h4 class="alert-heading">Richiesta inviata!</h4><p>La tua richiesta richiede una valutazione aggiuntiva.</p><hr><p class="mb-0">Un consulente ti contatterà entro 48 ore.</p>`;
          documentsSection.style.display = "none";
          submitButtonHelper.setLoading(false);
        } else {
          thankYouAlert.className = "alert alert-success mb-4";
          thankYouAlert.innerHTML = `<h4 class="alert-heading">Grazie!</h4><p>Richiesta inviata con successo. Riceverai un'email di conferma.</p><hr><p class="mb-0">Un consulente ti contatterà entro 48 ore.</p>`;
          documentsSection.style.display = "block";
          if(documentsLoading) documentsLoading.style.display = 'block';
          if(documentContainer) documentContainer.innerHTML = '';

          try {
            const userData = { firstname: document.getElementById("firstname")?.value };
            const apiDocuments = await fetchDocumentsFromAPI(referenceNumber, userData);
            documentTypes = apiDocuments.map(doc => ({ ...doc, viewed: false, downloaded: false }));
            totalDocuments = documentTypes.length;
            documentsViewed = 0; documentsDownloaded = 0;
            loadDocumentState();
            createDocumentElements();
            updateProgressBarAndStatus();
            checkAllDocumentsDownloaded();
          } catch (error) {
            console.error("Errore recupero documenti:", error);
            if(documentsLoading) documentsLoading.style.display = 'none';
            if(documentContainer) documentContainer.innerHTML = `<div class="alert alert-danger">Errore caricamento documenti. Contatta l'assistenza (Ref: ${referenceNumber}).</div>`;
            if(documentsSection) documentsSection.style.display = 'block';
            if(proceedButton) { proceedButton.disabled = true; proceedButton.classList.add('disabled'); }
          } finally {
              submitButtonHelper.setLoading(false);
          }
        }
      }

      // --- EVENT LISTENERS (invariati) ---
      function addEventListeners() {
          nextBtn1?.addEventListener("click", () => { if (validateStep(1)) goToStep(2); });
          prevBtn2?.addEventListener("click", () => goToStep(1));
          nextBtn2?.addEventListener("click", () => { if (validateStep(2)) goToStep(3); });
          prevBtn3?.addEventListener("click", () => goToStep(2));

          // Campi condizionali
          existingInsuranceRadios.forEach(radio => radio.addEventListener("change", function() {
              const isYes = this.value === 'yes' && this.checked;
              toggleElement(existingInsuranceDetails, isYes);
              if(existingCoverageInput) existingCoverageInput.required = isYes;
              if (!isYes && existingCoverageInput) existingCoverageInput.value = '';
          }));
          medicationRadios.forEach(radio => radio.addEventListener("change", function() {
              const isYes = this.value === 'yes' && this.checked;
              toggleElement(medicationDetails, isYes);
              medicationResolvedRadios?.forEach(r => r.required = isYes);
              if(medicationDescription) medicationDescription.required = isYes;
              if (!isYes) {
                  medicationResolvedRadios?.forEach(r => r.checked = false);
                  if(medicationDescription) medicationDescription.value = '';
                  medicationDetails?.querySelector('fieldset')?.classList.remove('radio-group-invalid');
                  medicationDescription?.classList.remove('is-invalid');
              }
          }));
           hospitalizationRadios.forEach(radio => radio.addEventListener("change", function() {
              const isYes = this.value === 'yes' && this.checked;
              toggleElement(hospitalizationDetails, isYes);
              hospitalizationResolvedRadios?.forEach(r => r.required = isYes);
              if (!isYes) {
                  hospitalizationResolvedRadios?.forEach(r => r.checked = false);
                  hospitalizationDetails?.querySelector('fieldset')?.classList.remove('radio-group-invalid');
              }
          }));
           workAbsenceRadios.forEach(radio => radio.addEventListener("change", function() {
              const isYes = this.value === 'yes' && this.checked;
              toggleElement(workAbsenceDetails, isYes);
              workAbsenceResolvedRadios?.forEach(r => r.required = isYes);
              if (!isYes) {
                  workAbsenceResolvedRadios?.forEach(r => r.checked = false);
                  workAbsenceDetails?.querySelector('fieldset')?.classList.remove('radio-group-invalid');
              }
          }));
          conditionCheckboxes.forEach(checkbox => checkbox.addEventListener("change", function() {
              const anyChecked = conditionCheckboxesChecked();
              toggleElement(conditionDetails, anyChecked);
              if(conditionNotes) conditionNotes.required = anyChecked;
              if (!anyChecked && conditionNotes) { conditionNotes.value = ''; conditionNotes.classList.remove('is-invalid');}
          }));

          // Beneficiari
          beneficiaryTypeSelect?.addEventListener("change", function() {
              const isOther = this.value === 'other';
              toggleElement(otherBeneficiarySection, isOther);
              beneficiaryList?.querySelector('.beneficiary-container[data-index="0"]')?.querySelectorAll('input[name^="beneficiary_firstname"], input[name^="beneficiary_lastname"], input[name^="beneficiary_percentage"]')?.forEach(input => input.required = isOther);
              if (isOther) distributePercentages();
              else if(submitBtn) submitBtn.disabled = false;
          });
          addBeneficiaryBtn?.addEventListener('click', addBeneficiary);
          document.getElementById('beneficiary_percentage_0')?.addEventListener('input', updateTotalPercentageDisplay);

          // Invio Form
          form?.addEventListener("submit", function(e) {
              e.preventDefault();
              e.stopPropagation();
              if (validateStep(currentStep)) {
                  const requiresManualVerification = checkIfRequiresManualVerification();
                  submitFormAction(requiresManualVerification);
              }
          });

          // Nuova Richiesta
          newRequestBtn?.addEventListener("click", function() {
              if (sessionStorageAvailable) {
                  sessionStorage.removeItem("documentsState");
                  sessionStorage.removeItem("referenceNumber");
                  sessionStorage.removeItem("datiPreventivo");
                  sessionStorage.removeItem("datiUtente"); // Rimuovi anche questi
                  sessionStorage.removeItem("finalOfferData");
              }
              form?.reset();
              form?.classList.remove('was-validated');
              sections.forEach(s => s.classList.remove('was-validated'));
              documentTypes = []; totalDocuments = 4; documentsViewed = 0; documentsDownloaded = 0;
              if(documentContainer) documentContainer.innerHTML = '';
              if(documentsLoading) documentsLoading.style.display = 'block';
              updateProgressBarAndStatus();
              checkAllDocumentsDownloaded();

              if(beneficiaryList) beneficiaryList.innerHTML = '';
              beneficiaryIndexes = [0]; beneficiaryCount = 1;
              if(beneficiaryTemplate && beneficiaryList) {
                  const templateNode = beneficiaryTemplate.content.cloneNode(true);
                  const firstElement = templateNode.firstElementChild;
                  if(firstElement){
                      firstElement.dataset.index = 0;
                      firstElement.querySelector('h6').textContent = `Beneficiario #1`;
                      firstElement.querySelectorAll('[id*="{INDEX}"]').forEach(el => el.id = el.id.replace('{INDEX}', 0));
                      firstElement.querySelectorAll('[name*="{INDEX}"]').forEach(el => el.name = el.name.replace('{INDEX}', 0));
                      firstElement.querySelectorAll('[for*="{INDEX}"]').forEach(el => el.htmlFor = el.htmlFor.replace('{INDEX}', 0));
                      const firstRemoveBtn = firstElement.querySelector('.remove-beneficiary');
                      if(firstRemoveBtn) { firstRemoveBtn.dataset.index = 0; firstRemoveBtn.classList.add('d-none'); }
                      const firstPercInput = firstElement.querySelector('.beneficiary-percentage');
                      if(firstPercInput) { firstPercInput.value = 100; firstPercInput.addEventListener('input', updateTotalPercentageDisplay); }
                      beneficiaryList.appendChild(firstElement);
                  }
              }
              toggleElement(otherBeneficiarySection, false);

              thankYouMessage?.classList.remove("active");
              if(form) form.style.display = "block";
              document.querySelector(".step-indicator")?.style.display = "flex";
              document.querySelector(".progress")?.style.display = "block";
              if(submitBtn) { submitBtn.disabled = false; submitBtn.innerHTML = '<i class="bi bi-check-lg"></i> Invia richiesta'; }

              goToStep(1);
              loadDataFromPreviousModule();
          });
      } // Fine addEventListeners

      // --- INIZIALIZZAZIONE (invariata) ---
      function loadDataFromPreviousModule() {
          if (!sessionStorageAvailable) return;
          try {
              const datiString = sessionStorage.getItem("datiPreventivo");
              if (datiString) {
                  const dati = JSON.parse(datiString);
                  console.log("Caricamento dati preventivo:", dati);
                  const durationEl = document.getElementById("duration");
                  const coverageEl = document.getElementById("coverage");
                  const birthdateEl = document.getElementById("birthdate");
                  const heightEl = document.getElementById("height");
                  const weightEl = document.getElementById("weight");
                  const smokerYesEl = document.getElementById("smoker_yes");
                  const smokerNoEl = document.getElementById("smoker_no");

                  if(durationEl) durationEl.value = dati.durata || 10;
                  if(coverageEl) coverageEl.value = dati.copertura || 100000;
                  if(birthdateEl) birthdateEl.value = dati.dataNascita || '';
                  if(heightEl) heightEl.value = dati.altezza || '';
                  if(weightEl) weightEl.value = dati.peso || '';
                  if (dati.fumatore !== undefined && smokerYesEl && smokerNoEl) {
                      document.getElementById(dati.fumatore ? "smoker_yes" : "smoker_no").checked = true;
                  }
              }
          } catch (error) { console.error("Errore parsing dati preventivo:", error); sessionStorage.removeItem("datiPreventivo"); }
      }

      // Helper per caricamento bottone (aggiunto per submitFormAction)
      function setButtonLoading(button, isLoading, loadingText = 'Elaborazione...') {
            if (!button) return;
            if (isLoading) {
              button.disabled = true;
              if (!button.dataset.originalText) {
                button.dataset.originalText = button.innerHTML;
              }
              // Semplice spinner CSS (puoi personalizzare)
              button.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> ${loadingText}`;
            } else {
              button.disabled = false;
              button.innerHTML = button.dataset.originalText || button.textContent; // Usa textContent come fallback
            }
      }


      // Inizializza
      addEventListeners();
      loadDataFromPreviousModule();
      goToStep(1);

    }); // Fine DOMContentLoaded
  </script>

  <!-- Script per Lazy Loading immagini (invariato) -->
  <script>
    "use strict";
    if ("loading" in HTMLImageElement.prototype) {
      document.querySelectorAll('img[loading="lazy"]').forEach((e) => {
        if(e.dataset.src) e.src = e.dataset.src;
        if (e.getAttribute("style")) { e.setAttribute("data-temp-style", e.getAttribute("style")); }
        if (e.getAttribute("data-aspectratio")) { e.style.paddingTop = 100 * parseFloat(e.getAttribute("data-aspectratio")) + "%"; e.style.height = '0'; }
        e.onload = function () {
          if (e.getAttribute("data-temp-style")) { e.setAttribute("style", e.getAttribute("data-temp-style")); } else { e.removeAttribute("style"); }
          e.removeAttribute("data-temp-style");
          if (e.getAttribute("data-aspectratio")) { e.style.paddingTop = ''; if(!e.getAttribute("style")) e.removeAttribute("style"); }
        };
      });
    } else {
      const e = document.createElement("script");
      e.src = "https://cdnjs.cloudflare.com/ajax/libs/lazysizes/5.1.2/lazysizes.min.js";
      document.body.appendChild(e);
    }
  </script>

</body>
</html>
