<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <!-- Meta tags -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta
      name="twitter:image:src"
      content="https://r.mobirisesite.com/1342903/assets/images/page8-meta.png"
    />
    <meta
      property="og:image"
      content="https://r.mobirisesite.com/1342903/assets/images/page8-meta.png"
    />
    <meta
      name="twitter:title"
      content="&Eacute;mission Police d'Assurance-Vie D&eacute;c&egrave;s en Suisse"
    />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, minimum-scale=1"
    />
    <link
      rel="shortcut icon"
      href="https://r.mobirisesite.com/1342903/assets/images/lifeinsure-1-172x172.png?v=1TZWWw"
      type="image/x-icon"
    />
    <meta
      name="description"
      content="Compl&eacute;tez l'&eacute;mission de votre police d'assurance-vie d&eacute;c&egrave;s en Suisse."
    />

    <title>&Eacute;mission Police d'Assurance-Vie D&eacute;c&egrave;s en Suisse</title>

    <!-- Links CSS -->
    <link
      rel="stylesheet"
      href="https://r.mobirisesite.com/1342903/assets/Material-Design-Icons/css/material.css"
    />
    <link
      rel="stylesheet"
      href="https://r.mobirisesite.com/1342903/assets/icon54/style.css"
    />
    <link
      rel="stylesheet"
      href="https://r.mobirisesite.com/1342903/assets/bootstrap/css/bootstrap.min.css"
    />
    <link
      rel="stylesheet"
      href="https://r.mobirisesite.com/1342903/assets/bootstrap/css/bootstrap-grid.min.css"
    />
    <link
      rel="stylesheet"
      href="https://r.mobirisesite.com/1342903/assets/bootstrap/css/bootstrap-reboot.min.css"
    />
    <link
      rel="stylesheet"
      href="https://r.mobirisesite.com/1342903/assets/web/assets/gdpr-plugin/gdpr-styles.css"
    />
    <link
      rel="stylesheet"
      href="https://r.mobirisesite.com/1342903/assets/popup-overlay-plugin/style.css"
    />
    <link
      rel="stylesheet"
      href="https://r.mobirisesite.com/1342903/assets/dropdown/css/style.css"
    />
    <link
      rel="stylesheet"
      href="https://r.mobirisesite.com/1342903/assets/socicon/css/styles.css"
    />
    <link
      rel="stylesheet"
      href="https://r.mobirisesite.com/1342903/assets/theme/css/style.css"
    />
    <link
      rel="preload"
      href="https://fonts.googleapis.com/css?family=Space+Grotesk:300,400,500,600,700&display=swap"
      as="style"
      onload="this.onload=null;this.rel='stylesheet'"
    />
    <noscript
      ><link
        rel="stylesheet"
        href="https://fonts.googleapis.com/css?family=Space+Grotesk:300,400,500,600,700&display=swap"
    /></noscript>
    <link
      rel="preload"
      as="style"
      href="https://r.mobirisesite.com/1342903/assets/mobirise/css/mbr-additional.css?v=1TZWWw"
    />
    <link
      rel="stylesheet"
      href="https://r.mobirisesite.com/1342903/assets/mobirise/css/mbr-additional.css?v=1TZWWw"
      type="text/css"
    />

    <!-- Styles pour le module d'émission -->
    <style>
      /* Styles de base pour le conteneur et card */
      .lifensure-container {
        font-family: "Space Grotesk", sans-serif;
        line-height: 1.6;
        color: #333;
      }
      .lifensure-card {
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        padding: 30px;
        margin: 30px auto;
        max-width: 800px;
        border: 1px solid #e9ecef;
      }
      .lifensure-card h2 {
        text-align: center;
        margin-bottom: 30px;
        color: #343a40;
        font-size: 1.8rem;
        font-weight: 600;
      }
      .lifensure-step-title {
        border-bottom: 1px solid #dee2e6;
        padding-bottom: 12px;
        margin-bottom: 25px;
        font-weight: 600;
        font-size: 1.2rem;
        color: #495057;
      }
      /* Barre de progression */
      .lifensure-progress-container {
        height: 10px;
        background-color: #e9ecef;
        border-radius: 5px;
        margin-bottom: 35px;
        overflow: hidden;
      }
      #lifensure-progress-bar {
        height: 100%;
        width: 0%;
        background-color: #0d6efd;
        transition: width 0.4s ease-in-out;
        border-radius: 5px;
      }
      /* Styles input et label */
      .lifensure-form-group {
        margin-bottom: 20px;
      }
      .lifensure-form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: #495057;
        font-size: 0.95rem;
      }
      .lifensure-form-group label .lifensure-required {
        color: #dc3545;
        margin-left: 3px;
      }
      .lifensure-form-group input[type="text"],
      .lifensure-form-group input[type="email"],
      .lifensure-form-group select {
        width: 100%;
        padding: 12px 15px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        font-size: 1rem;
        box-sizing: border-box;
        transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
      }
      .lifensure-form-group input:focus,
      .lifensure-form-group select:focus {
        border-color: #86b7fe;
        outline: 0;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
      }
      .lifensure-form-group .lifensure-input-hint {
        color: #6c757d;
        font-size: 0.85rem;
        margin-top: 5px;
      }
      /* Styles pour erreurs */
      .lifensure-form-group input.is-invalid,
      .lifensure-form-group select.is-invalid {
        border-color: #dc3545 !important;
      }
      .lifensure-form-group .invalid-feedback {
        color: #dc3545;
        font-size: 0.875em;
        margin-top: 0.25rem;
        display: none;
      }
      .was-validated
        .lifensure-checkbox-group
        .lifensure-checkbox-wrapper:has(input:invalid)
        + .invalid-feedback {
        display: block;
      }
      /* Styles Checkbox */
      .lifensure-checkbox-group {
        margin-bottom: 15px;
      }
      .lifensure-checkbox-group .lifensure-checkbox-wrapper {
        display: flex;
        align-items: flex-start;
        margin-bottom: 5px;
      }
      .lifensure-checkbox-group input[type="checkbox"] {
        margin-right: 10px;
        margin-top: 4px;
        flex-shrink: 0;
        width: 1.1em;
        height: 1.1em;
      }
      .lifensure-checkbox-group label {
        font-size: 1rem;
        color: #333;
        line-height: 1.5;
      }
      .lifensure-checkbox-group label a {
        color: #0d6efd;
        text-decoration: underline;
        cursor: pointer;
      }
      .lifensure-checkbox-group .invalid-feedback {
        color: #dc3545;
        font-size: 0.875em;
        margin-left: 25px;
        display: none;
      }
      .was-validated
        .lifensure-checkbox-group
        input:invalid
        ~ .invalid-feedback {
        display: block;
      }
      /* Boutons */
      .lifensure-button {
        background-color: #0d6efd;
        color: white;
        border: none;
        padding: 12px 25px;
        border-radius: 4px;
        font-size: 1rem;
        cursor: pointer;
        transition: background-color 0.2s ease;
        display: inline-flex;
        align-items: center;
        justify-content: center;
      }
      .lifensure-button:hover {
        background-color: #0b5ed7;
      }
      .lifensure-button.secondary {
        background-color: #6c757d;
      }
      .lifensure-button.secondary:hover {
        background-color: #5c636a;
      }
      .lifensure-button.success {
        background-color: #198754;
      }
      .lifensure-button.success:hover {
        background-color: #157347;
      }
      .lifensure-button.outline {
        background-color: transparent;
        color: #0d6efd;
        border: 1px solid #0d6efd;
      }
      .lifensure-button.outline:hover {
        background-color: #0d6efd;
        color: white;
      }
      .lifensure-button:disabled {
        background-color: #adb5bd;
        cursor: not-allowed;
        opacity: 0.7;
      }
      .lifensure-button-spinner {
        display: inline-block;
        width: 1em;
        height: 1em;
        border: 2px solid currentColor;
        border-radius: 50%;
        border-top-color: transparent;
        animation: lifensure-spin 0.75s linear infinite;
        margin-right: 8px;
      }
      @keyframes lifensure-spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      /* Résumé */
      .lifensure-summary-box {
        margin-bottom: 25px;
        background-color: #f8f9fa;
        padding: 20px;
        border-radius: 5px;
        border: 1px solid #dee2e6;
      }
      .lifensure-summary-box h6 {
        font-weight: 600;
        font-size: 1.1rem;
        margin-bottom: 15px;
        color: #495057;
      }
      .lifensure-summary-box p {
        margin-bottom: 8px;
        color: #343a40;
      }
      .lifensure-summary-box strong {
        color: #212529;
      }
      .lifensure-summary-highlight {
        background-color: #cfe2ff;
        color: #052c65;
        padding: 12px;
        border-radius: 4px;
        margin-top: 15px;
        font-weight: 500;
      }
      /* Step Complétion */
      .lifensure-completion-icon {
        width: 80px;
        height: 80px;
        margin: 0 auto 25px auto;
        border-radius: 50%;
        border: 4px solid #198754;
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .lifensure-completion-icon::after {
        content: "";
        display: block;
        width: 40%;
        height: 60%;
        border: solid #198754;
        border-width: 0 5px 5px 0;
        transform: rotate(45deg);
      }
      .lifensure-completion-message h3 {
        color: #198754;
        font-size: 1.6rem;
        margin-bottom: 10px;
        font-weight: 600;
      }
      .lifensure-completion-message p {
        font-size: 1.1rem;
        color: #495057;
      }
      .lifensure-policy-info {
        background-color: #d1e7dd;
        color: #0f5132;
        padding: 15px 20px;
        border-radius: 4px;
        margin-bottom: 25px;
        border: 1px solid #badbcc;
      }
      .lifensure-policy-info h5 {
        margin-bottom: 5px;
        font-weight: 600;
        font-size: 1.1rem;
      }
      .lifensure-documents-list {
        background-color: #f8f9fa;
        padding: 20px;
        border-radius: 4px;
        margin-bottom: 25px;
        border: 1px solid #dee2e6;
      }
      .lifensure-documents-list h6 {
        font-weight: 600;
        margin-bottom: 15px;
        font-size: 1.1rem;
      }
      .lifensure-document-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
        padding-bottom: 12px;
        border-bottom: 1px solid #eee;
      }
      .lifensure-document-item:last-child {
        margin-bottom: 0;
        padding-bottom: 0;
        border-bottom: none;
      }
      .lifensure-document-item span {
        color: #343a40;
      }
      .lifensure-document-item button,
      .lifensure-document-item a {
        background-color: #e9ecef;
        color: #0d6efd;
        border: 1px solid #ced4da;
        padding: 6px 12px;
        border-radius: 4px;
        font-size: 0.9rem;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        cursor: pointer;
        transition: background-color 0.2s ease, border-color 0.2s ease;
      }
      .lifensure-document-item button:hover,
      .lifensure-document-item a:hover {
        background-color: #dee2e6;
        border-color: #adb5bd;
      }
      /* Step Erreur */
      .lifensure-error-icon {
        width: 80px;
        height: 80px;
        margin: 0 auto 25px auto;
        font-size: 60px;
        color: #dc3545;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 4px solid #dc3545;
        border-radius: 50%;
      }
      .lifensure-error-message h3 {
        color: #dc3545;
        font-size: 1.6rem;
        margin-bottom: 10px;
        font-weight: 600;
      }
      .lifensure-error-message p {
        font-size: 1.1rem;
        color: #495057;
      }
      /* Modal */
      #lifensure-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.6);
        z-index: 1050;
        opacity: 0;
        transition: opacity 0.3s ease;
      }
      #lifensure-overlay.visible {
        display: block;
        opacity: 1;
      }
      #lifensure-modal {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) scale(0.9);
        width: 90%;
        max-width: 650px;
        background-color: white;
        border-radius: 8px;
        padding: 25px 30px;
        max-height: 85vh;
        overflow-y: auto;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
        opacity: 0;
        transition: opacity 0.3s ease, transform 0.3s ease;
        z-index: 1051;
      }
      #lifensure-overlay.visible #lifensure-modal {
        opacity: 1;
        transform: translate(-50%, -50%) scale(1);
      }
      #lifensure-modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid #dee2e6;
      }
      #lifensure-modal-title {
        font-size: 1.3rem;
        margin: 0;
        font-weight: 600;
        color: #343a40;
      }
      #lifensure-modal-close {
        background: none;
        border: none;
        font-size: 2rem;
        cursor: pointer;
        line-height: 1;
        color: #6c757d;
        padding: 0 5px;
      }
      #lifensure-modal-close:hover {
        color: #343a40;
      }
      #lifensure-modal-content {
        margin-bottom: 25px;
        font-size: 1rem;
        line-height: 1.7;
      }
      #lifensure-modal-content h6 {
        font-weight: 600;
        margin-top: 15px;
        margin-bottom: 8px;
        font-size: 1.1rem;
      }
      #lifensure-modal-content ul {
        padding-left: 25px;
        margin-top: 10px;
      }
      #lifensure-modal-footer {
        text-align: right;
        padding-top: 15px;
        border-top: 1px solid #dee2e6;
      }
      /* Debug Area */
      #lifensure-debug {
        display: none;
        margin-top: 30px;
        padding: 15px;
        background-color: #fff3cd;
        color: #664d03;
        border: 1px solid #ffecb5;
        border-radius: 4px;
        font-size: 0.9rem;
      }
      #lifensure-debug h5 {
        margin-top: 0;
        margin-bottom: 10px;
        font-weight: 600;
      }
      #lifensure-debug p {
        margin: 3px 0;
        word-break: break-all;
      }
    </style>
  </head>
  <body>
    <!-- Navbar -->
    <section
      data-bs-version="5.1"
      class="inspirem5 menu menu1 cid-uHcV8yKzqs"
      once="menu"
      id="menu01-3s"
    >
      <nav class="navbar navbar-dropdown navbar-fixed-top navbar-expand-lg">
        <div class="container-fluid">
          <div class="navbar-brand">
            <span class="navbar-logo">
              <a href="index.html#top">
                <img
                  src="https://r.mobirisesite.com/1342903/assets/images/lifeinsure-1-172x172.png?v=1TZWWw"
                  alt="LifeInsure Logo"
                  style="height: 3.6rem"
                />
              </a>
            </span>
          </div>
          <button
            class="navbar-toggler"
            type="button"
            data-toggle="collapse"
            data-bs-toggle="collapse"
            data-target="#navbarSupportedContent"
            data-bs-target="#navbarSupportedContent"
            aria-controls="navbarNavAltMarkup"
            aria-expanded="false"
            aria-label="Toggle navigation"
          >
            <div class="hamburger">
              <span></span><span></span><span></span><span></span>
            </div>
          </button>
          <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav nav-dropdown" data-app-modern-menu="true">
              <li class="nav-item">
                <a
                  class="nav-link link text-primary display-7"
                  href="index.html#header01-2"
                  >Accueil</a
                >
              </li>
              <li class="nav-item dropdown">
                <a
                  class="nav-link link text-primary dropdown-toggle display-7"
                  href="#"
                  data-toggle="dropdown-submenu"
                  data-bs-toggle="dropdown"
                  data-bs-auto-close="outside"
                  aria-expanded="false"
                  >Assurance d&eacute;c&egrave;s</a
                >
                <div class="dropdown-menu" aria-labelledby="dropdown-707">
                  <a
                    class="text-primary dropdown-item display-7"
                    href="index.html#progress-bars02-0"
                    >Avantages</a
                  >
                  <a
                    class="text-primary show dropdown-item display-7"
                    href="index.html#progress-bars01-j"
                    >Valeur</a
                  >
                  <a
                    class="text-primary show dropdown-item display-7"
                    href="#"
                    data-toggle="modal"
                    data-bs-toggle="modal"
                    data-target="#mbr-popup-2k"
                    data-bs-target="#mbr-popup-2k"
                    ><span
                      class="mdi-content-markunread mbr-iconfont mbr-iconfont-btn"
                    ></span
                    >Une histoire vraie (lire)</a
                  >
                  <a
                    class="text-primary show dropdown-item display-7"
                    href="index.html#testimonials04-g"
                    >T&eacute;moignages</a
                  >
                </div>
              </li>
              <li class="nav-item">
                <a
                  class="nav-link link text-primary display-7"
                  href="index.html#forms03-5"
                  >Qui sommes-nous</a
                >
              </li>
              <li class="nav-item">
                <a
                  class="nav-link link text-primary display-7"
                  href="index.html#forms03-5"
                  >Contact</a
                >
              </li>
              <li class="nav-item dropdown">
                <a
                  class="nav-link link text-primary dropdown-toggle show display-7"
                  href="#"
                  data-toggle="dropdown-submenu"
                  data-bs-toggle="dropdown"
                  data-bs-auto-close="outside"
                  aria-expanded="false"
                  ><span
                    class="icon54-v1-translate2 mbr-iconfont mbr-iconfont-btn"
                  ></span
                ></a>
                <div
                  class="dropdown-menu show"
                  aria-labelledby="dropdown-852"
                  data-bs-popper="none"
                >
                  <a
                    class="text-primary dropdown-item display-7"
                    href="https://de.lifeinsure.ch"
                    target="_blank"
                    >Deutsch</a
                  >
                  <a
                    class="text-primary dropdown-item display-7"
                    href="https://lifeinsure.ch"
                    target="_blank"
                    >Italiano</a
                  >
                </div>
              </li>
            </ul>
            <div class="navbar-buttons mbr-section-btn">
              <a
                class="btn btn-lg btn-danger display-4"
                href="calcolo-premio-fr.html"
                ><span
                  class="icon54-v1-click-1 mbr-iconfont mbr-iconfont-btn"
                ></span
                >DEVIS
              </a>
            </div>
          </div>
        </div>
      </nav>
    </section>

    <!-- Header -->
    <section
      data-bs-version="5.1"
      class="inspirem5 header3 cid-uHcV8zftrL"
      id="header03-3t"
    >
      <div class="container">
        <div class="row justify-content-center">
          <div class="col-12 col-lg-11">
            <!-- Contenu header si présent -->
          </div>
        </div>
      </div>
    </section>

    <!-- Module Émission Police -->
    <div id="custom-html-3u">
      <div id="lifensure-emission-module" class="lifensure-container">
        <div class="lifensure-card">
          <h2>&Eacute;mission Police d'Assurance-Vie D&eacute;c&egrave;s</h2>

          <!-- Barre de progression -->
          <div class="lifensure-progress-container">
            <div id="lifensure-progress-bar"></div>
          </div>

          <!-- ÉTAPE 1: Saisie Détails Offre -->
          <div id="lifensure-step-1" style="display: block">
            <div class="lifensure-step-title">
              1. Saisissez les d&eacute;tails de l'offre
            </div>

            <div class="lifensure-form-group">
              <label for="lifensure-offerta-id">
                ID Offre <span class="lifensure-required">*</span>
              </label>
              <input
                type="text"
                id="lifensure-offerta-id"
                placeholder="Saisissez l'ID de l'offre"
                required
                aria-describedby="lifensure-offerta-id-error"
              />
              <div id="lifensure-offerta-id-error" class="invalid-feedback">
                Saisissez l'ID de l'offre re&ccedil;ue.
              </div>
              <div class="lifensure-input-hint">
                Saisissez l'ID re&ccedil;u &agrave; la fin de la demande de devis.
              </div>
            </div>

            <div class="lifensure-form-group">
              <label for="lifensure-email-conferma">
                Email associ&eacute; <span class="lifensure-required">*</span>
              </label>
              <input
                type="email"
                id="lifensure-email-conferma"
                placeholder="Votre email associ&eacute; &agrave; l'offre"
                required
                aria-describedby="lifensure-email-error"
              />
              <div id="lifensure-email-error" class="invalid-feedback">
                Saisissez l'adresse email valide associ&eacute;e &agrave; l'offre.
              </div>
              <div class="lifensure-input-hint">
                Saisissez l'email utilis&eacute; lors de la demande de devis.
              </div>
            </div>

            <!-- Message d'erreur si les données de l'offre ne sont pas trouvées dans sessionStorage -->
            <div
              id="lifensure-session-error"
              class="invalid-feedback"
              style="
                display: none;
                color: #dc3545;
                margin-bottom: 20px;
                text-align: center;
              "
            >
              Erreur : Donn&eacute;es de l'offre introuvables en session ou ne correspondent pas. Assurez-vous de commencer le processus depuis la page de devis ou v&eacute;rifiez les donn&eacute;es saisies.
            </div>

            <div style="text-align: center; margin-top: 30px">
              <!-- Ce bouton passe simplement à l'étape suivante si les champs sont remplis et les données sessionStorage présentes -->
              <button id="lifensure-verifica-btn" class="lifensure-button">
                Afficher le r&eacute;sum&eacute; et les consentements
              </button>
            </div>
          </div>

          <!-- ÉTAPE 2: Résumé et Consentements -->
          <div id="lifensure-step-2" style="display: none">
            <div class="lifensure-step-title">2. R&eacute;sum&eacute; et Consentements</div>

            <div id="lifensure-riepilogo-content" class="lifensure-summary-box">
              <!-- Contenu du résumé inséré dynamiquement depuis sessionStorage -->
              <p>Chargement du r&eacute;sum&eacute;...</p>
            </div>

            <div class="lifensure-checkbox-group">
              <div class="lifensure-checkbox-wrapper">
                <input
                  type="checkbox"
                  id="lifensure-condizioni-check"
                  required
                  aria-describedby="lifensure-condizioni-error"
                  value="cga_acceptance"
                />
                <label
                  for="lifensure-condizioni-check"
                  id="lifensure-condizioni-label"
                >
                  J'ai t&eacute;l&eacute;charg&eacute;, lu et accept&eacute; les conditions g&eacute;n&eacute;rales d'assurance.
                </label>
              </div>
              <div id="lifensure-condizioni-error" class="invalid-feedback">
                Vous devez accepter les conditions g&eacute;n&eacute;rales pour continuer.
              </div>
            </div>

            <div class="lifensure-checkbox-group">
              <div class="lifensure-checkbox-wrapper">
                <input
                  type="checkbox"
                  id="lifensure-privacy-check"
                  required
                  aria-describedby="lifensure-privacy-error"
                  value="privacy_acceptance"
                />
                <label
                  for="lifensure-privacy-check"
                  id="lifensure-privacy-label"
                >
                  J'ai lu et accept&eacute; la politique de confidentialit&eacute; en consentant au traitement de mes donn&eacute;es.
                </label>
              </div>
              <div id="lifensure-privacy-error" class="invalid-feedback">
                Vous devez accepter la politique de confidentialit&eacute; pour continuer.
              </div>
            </div>

            <div class="lifensure-checkbox-group">
              <div class="lifensure-checkbox-wrapper">
                <input
                  type="checkbox"
                  id="lifensure-dichiarazione-check"
                  required
                  aria-describedby="lifensure-dichiarazione-error"
                  value="declaration_truth"
                />
                <label
                  for="lifensure-dichiarazione-check"
                  id="lifensure-dichiarazione-label"
                >
                  Je d&eacute;clare que toutes les informations fournies lors de la demande sont v&eacute;ridiques et compl&egrave;tes.
                </label>
              </div>
              <div id="lifensure-dichiarazione-error" class="invalid-feedback">
                Vous devez confirmer la v&eacute;racit&eacute; des informations fournies.
              </div>
            </div>

            <!-- Questions supplémentaires (si l'API indique leur nécessité dans la phase PREMIA/OFFER) -->
            <div id="lifensure-domande-aggiuntive" style="margin-top: 20px">
              <!-- Exemple de structure d'une question dynamique :
                 <div class="lifensure-form-group">
                     <label for="question-XYZ">Texte de la question <span class="lifensure-required">*</span></label>
                     <input type="text" id="question-XYZ" required data-question-id="XYZ">
                     <div class="invalid-feedback">R&eacute;ponse requise.</div>
                 </div>
                 -->
            </div>

            <div
              style="
                display: flex;
                justify-content: space-between;
                margin-top: 30px;
              "
            >
              <button
                id="lifensure-indietro-riepilogo"
                class="lifensure-button secondary"
              >
                Retour
              </button>
              <!-- Ce bouton démarre le processus de soumission de l'application à l'API /application -->
              <button id="lifensure-procedi-btn" class="lifensure-button">
                Proc&eacute;der &agrave; l'&eacute;mission
              </button>
            </div>
          </div>

          <!-- ÉTAPE 3: Complétion (Ex Étape 4) -->
          <div id="lifensure-step-3" style="display: none">
            <div class="lifensure-step-title">3. &Eacute;mission Compl&eacute;t&eacute;e</div>
            <div style="text-align: center; margin-bottom: 30px">
              <div class="lifensure-completion-icon"></div>
              <div class="lifensure-completion-message">
                <h3>&Eacute;mission compl&eacute;t&eacute;e !</h3>
                <p>Votre police d'assurance-vie est active.</p>
              </div>
            </div>

            <div class="lifensure-policy-info">
              <h5>
                Num&eacute;ro de Police : <span id="lifensure-numero-polizza">--</span>
              </h5>
              <p>
                Les documents officiels de la police ont &eacute;t&eacute; envoy&eacute;s &agrave; l'adresse email fournie.
              </p>
            </div>

            <div class="lifensure-documents-list">
              <h6>Documents disponibles au t&eacute;l&eacute;chargement :</h6>
              <div id="lifensure-documenti-polizza">
                <p>Chargement des documents...</p>
              </div>
            </div>

            <div style="text-align: center; margin-top: 30px">
              <a href="index.html" class="lifensure-button">
                Retour &agrave; l'Accueil
              </a>
            </div>
          </div>

          <!-- ÉTAPE 4: Erreur (Ex Étape 5) -->
          <div id="lifensure-step-4" style="display: none">
            <div class="lifensure-step-title">4. Une erreur s'est produite</div>
            <div style="text-align: center; margin-bottom: 30px">
              <div class="lifensure-error-icon">!</div>
              <!-- Icône simple -->
              <div class="lifensure-error-message">
                <h3>Une erreur s'est produite</h3>
                <p id="lifensure-errore-messaggio">
                  Impossible de compl&eacute;ter l'op&eacute;ration.
                </p>
              </div>
            </div>

            <div style="text-align: center; margin-top: 30px">
              <button
                id="lifensure-riprova"
                class="lifensure-button"
                style="margin-right: 10px"
              >
                R&eacute;essayer depuis la premi&egrave;re &eacute;tape
              </button>
              <a href="index.html" class="lifensure-button outline">
                Retour &agrave; l'Accueil
              </a>
            </div>
          </div>

          <!-- Zone de debug (optionnelle, à supprimer en production) -->
          <div id="lifensure-debug">
            <h5 style="margin-top: 0">Infos Debug :</h5>
            <div id="lifensure-debug-content"></div>
          </div>
        </div>
        <!-- Fin lifensure-card -->

        <!-- Fenêtre Modale -->
        <div id="lifensure-overlay">
          <div
            id="lifensure-modal"
            role="dialog"
            aria-modal="true"
            aria-labelledby="lifensure-modal-title"
            aria-describedby="lifensure-modal-content"
          >
            <div id="lifensure-modal-header">
              <h5 id="lifensure-modal-title">Titre Modal</h5>
              <button
                id="lifensure-modal-close"
                aria-label="Fermer la fen&ecirc;tre modale"
              >
                ×
              </button>
            </div>
            <div id="lifensure-modal-content">
              <!-- Contenu modal inséré dynamiquement -->
            </div>
            <div id="lifensure-modal-footer">
              <button id="lifensure-modal-confirm" class="lifensure-button">
                J'ai lu
              </button>
            </div>
          </div>
        </div>
      </div>
      <!-- Fin lifensure-emission-module -->
      <script src="assets/api/test-connection.js"></script>
      <script>
        // Scope isolé pour éviter les conflits
        (function () {
          "use strict";

          // --- VARIABLES ET CONSTANTES ---
          let currentStepIndex = 0;
          // Variable qui mémorisera les données de l'offre chargées depuis sessionStorage
          let offerDetailsFromSession = null;
          // Variable qui mémorisera la réponse de l'API après l'appel /application réussi
          let applicationResponseData = null;

          let sessionStorageAvailable = false;
          // DEBUG_MODE mis à false en production pour supprimer debugInfo
          const DEBUG_MODE = true; // Mettre à false en production

          // Éléments DOM principaux
          const progressBar = document.getElementById("lifensure-progress-bar");
          // Liste des étapes mise à jour selon la nouvelle structure
          const steps = [
            document.getElementById("lifensure-step-1"), // index 0 (Saisie ID/Email)
            document.getElementById("lifensure-step-2"), // index 1 (Résumé et consentements)
            document.getElementById("lifensure-step-3"), // index 2 (Complétion)
            document.getElementById("lifensure-step-4"), // index 3 (Erreur)
          ];

          const emissionModuleContainer = document.getElementById(
            "lifensure-emission-module"
          );

          // Inputs Étape 1
          const offertaIdInput = document.getElementById(
            "lifensure-offerta-id"
          );
          const emailConfermaInput = document.getElementById(
            "lifensure-email-conferma"
          );
          const offertaIdError = document.getElementById(
            "lifensure-offerta-id-error"
          );
          const emailError = document.getElementById("lifensure-email-error");
          const sessionErrorDiv = document.getElementById(
            "lifensure-session-error"
          );

          // Checkbox Étape 2
          const condizioniCheck = document.getElementById(
            "lifensure-condizioni-check"
          );
          const privacyCheck = document.getElementById(
            "lifensure-privacy-check"
          );
          const dichiarazioneCheck = document.getElementById(
            "lifensure-dichiarazione-check"
          );
          const condizioniError = document.getElementById(
            "lifensure-condizioni-error"
          );
          const privacyError = document.getElementById(
            "lifensure-privacy-error"
          );
          const dichiarazioneError = document.getElementById(
            "lifensure-dichiarazione-error"
          );
          const riepilogoContent = document.getElementById(
            "lifensure-riepilogo-content"
          );
          const condizioniLink = document.getElementById(
            "lifensure-condizioni-link"
          );
          const privacyLink = document.getElementById("lifensure-privacy-link");
          const domandeAggiuntiveDiv = document.getElementById(
            "lifensure-domande-aggiuntive"
          );

          // Complétion Étape 3 (Ex Étape 4)
          const numeroPolizzaSpan = document.getElementById(
            "lifensure-numero-polizza"
          );
          const documentiPolizzaDiv = document.getElementById(
            "lifensure-documenti-polizza"
          );

          // Erreur Étape 4 (Ex Étape 5)
          const erroreMessaggioP = document.getElementById(
            "lifensure-errore-messaggio"
          );

          // Boutons
          const verificaBtn = document.getElementById("lifensure-verifica-btn"); // Maintenant "Afficher Résumé"
          const indietroRiepilogoBtn = document.getElementById(
            "lifensure-indietro-riepilogo"
          );
          // Le bouton "Procéder" lance maintenant le processus de soumission de l'application (application)
          const procediBtn = document.getElementById("lifensure-procedi-btn");
          const riprovaBtn = document.getElementById("lifensure-riprova");

          // Modal
          const overlay = document.getElementById("lifensure-overlay");
          const modal = document.getElementById("lifensure-modal");
          const modalTitle = document.getElementById("lifensure-modal-title");
          const modalContent = document.getElementById(
            "lifensure-modal-content"
          );
          const modalCloseBtn = document.getElementById(
            "lifensure-modal-close"
          );
          const modalConfirmBtn = document.getElementById(
            "lifensure-modal-confirm"
          );

          // Debug - Garder les éléments DOM mais supprimer les fonctions debugInfo
          const debugContainer = document.getElementById("lifensure-debug");
          const debugContent = document.getElementById(
            "lifensure-debug-content"
          );

          // --- FONCTIONS UTILITAIRES ---

          /** @param {string} message Message à logger */
          function safeLog(message) {
            if (window.console && console.log) {
              console.log("[Lifensure Emission] " + message);
            }
          }

          // fonction debugInfo supprimée comme demandé
          function debugInfo(data) {
            // Implémentation vide pour debugInfo en mode non-debug ou lorsque supprimé
            if (DEBUG_MODE && window.console && console.log) {
              // Optionnel : Log dans la console si DEBUG_MODE est true, même si debugInfo est supprimé
              console.log("[DEBUG INFO]", data);
            }
            if (!DEBUG_MODE && debugContainer) {
              debugContainer.style.display = "none"; // S'assurer que la zone debug est cachée
            }
          }

          /** Vérifie la disponibilité de sessionStorage */
          function checkSessionStorage() {
            try {
              const testKey = "lifensure_test";
              sessionStorage.setItem(testKey, testKey);
              sessionStorage.removeItem(testKey);
              sessionStorageAvailable = true;
              // debugInfo("SessionStorage est disponible."); // Appel debug supprimé
            } catch (e) {
              sessionStorageAvailable = false;
              // debugInfo("SessionStorage non disponible ou bloqué."); // Appel debug supprimé
            }
          }

          /**
           * Affiche/Cache un élément HTML.
           * @param {HTMLElement} element L'élément à afficher/cacher.
           * @param {boolean} show True pour afficher, false pour cacher.
           */
          function toggleElement(element, show) {
            if (element) {
              element.style.display = show ? "block" : "none";
            } else {
              // debugInfo("Tentative de toggle sur élément null."); // Appel debug supprimé
            }
          }

          /**
           * Définit l'état de chargement d'un bouton.
           * @param {HTMLButtonElement} button Le bouton.
           * @param {boolean} isLoading True si en chargement, false sinon.
           * @param {string} [loadingText='Traitement...'] Texte à afficher pendant le chargement.
           */
          function setButtonLoading(
            button,
            isLoading,
            loadingText = "Traitement..."
          ) {
            if (!button) return;
            if (isLoading) {
              button.disabled = true;
              // Sauvegarde le texte original s'il n'est pas déjà sauvegardé
              if (!button.dataset.originalText) {
                button.dataset.originalText = button.innerHTML;
              }
              button.innerHTML = `<span class="lifensure-button-spinner"></span> ${loadingText}`;
            } else {
              button.disabled = false;
              // Restaure le texte original
              button.innerHTML =
                button.dataset.originalText || button.innerHTML;
              delete button.dataset.originalText; // Nettoie le texte sauvegardé
            }
          }

          // --- FONCTIONS MODAL ---

          /**
           * Affiche la fenêtre modale.
           * @param {string} title Titre du modal.
           * @param {string} content Contenu HTML du modal.
           */
          function showModal(title, content) {
            if (!overlay || !modal || !modalTitle || !modalContent) {
              // debugInfo("Éléments du modal non trouvés."); // Appel debug supprimé
              return;
            }
            try {
              modalTitle.textContent = title;
              modalContent.innerHTML = content;
              overlay.classList.add("visible");
              // Optionnel : Gestion du focus pour accessibilité
              // modalConfirmBtn.focus();
            } catch (err) {
              // debugInfo("Erreur à l'ouverture du modal : " + err.message); // Appel debug supprimé
            }
          }

          /** Ferme la fenêtre modale. */
          function closeModal() {
            if (!overlay) return;
            overlay.classList.remove("visible");
          }

          // --- FONCTIONS DE NAVIGATION ET VALIDATION ---

          /**
           * Navigue vers une étape spécifique.
           * @param {number} stepIndex Indice de l'étape (base 0).
           */
          function goToStep(stepIndex) {
            if (
              stepIndex < 0 ||
              stepIndex >= steps.length ||
              !steps[stepIndex]
            ) {
              // debugInfo("Indice d'étape non valide : " + stepIndex); // Appel debug supprimé
              return;
            }
            safeLog("Navigation vers l'&eacute;tape " + (stepIndex + 1));
            currentStepIndex = stepIndex;

            steps.forEach((step, index) => {
              if (step) {
                step.style.display = index === stepIndex ? "block" : "none";
                // Supprime l'état de validation lors du changement d'étape
                step.classList.remove("was-validated");
              }
            });

            // Met à jour la barre de progression (maintenant 3 étapes principales : 0, 1, 2)
            const progressPercentage =
              stepIndex < 2 ? (stepIndex / 2) * 100 : 100;
            progressBar.style.width = progressPercentage + "%";

            // Défilement vers le début du module
            if (emissionModuleContainer) {
              emissionModuleContainer.scrollIntoView({
                behavior: "smooth",
                block: "start",
              });
            }
          }

          /**
           * Valide les inputs de l'étape courante.
           * @returns {boolean} True si valide, false sinon.
           */
          function validateCurrentStep() {
            const currentStepElement = steps[currentStepIndex];
            if (!currentStepElement) {
              // debugInfo("currentStepElement non trouvé pour validation."); // Appel debug supprimé
              return false;
            }

            let isStepValid = true;
            // Ajoute classe pour activer la validation HTML5 et les styles
            currentStepElement.classList.add("was-validated");

            // Sélectionne tous les éléments du formulaire obligatoires dans l'étape courante
            const requiredElements = currentStepElement.querySelectorAll(
              "input[required], select[required], textarea[required]"
            );

            requiredElements.forEach((element) => {
              // Vérifie si l'élément est visible (non caché via display: none)
              const style = window.getComputedStyle(element);
              if (style.display === "none" || style.visibility === "hidden") {
                return; // Ignore la validation des éléments cachés
              }

              if (element.type === "checkbox") {
                if (!element.checked) {
                  isStepValid = false;
                }
              } else {
                if (!element.checkValidity()) {
                  isStepValid = false;
                }
              }
            });

            if (!isStepValid) {
              // debugInfo(`Validation étape ${currentStepIndex + 1} échouée.`); // Appel debug supprimé
              // Trouve le premier élément invalide visible pour mettre le focus
              const firstInvalidVisible = currentStepElement.querySelector(
                ':invalid:not(fieldset):not([type="hidden"]):not([style*="display: none"]):not([style*="visibility: hidden"])'
              );

              if (firstInvalidVisible) {
                safeLog(
                  `D&eacute;filement vers le premier &eacute;l&eacute;ment invalide visible : ${
                    firstInvalidVisible.id ||
                    firstInvalidVisible.name ||
                    firstInvalidVisible.tagName
                  }`
                );
                setTimeout(() => {
                  firstInvalidVisible.focus();
                  firstInvalidVisible.scrollIntoView({
                    behavior: "smooth",
                    block: "center",
                  });
                }, 100); // Petit délai pour un défilement fluide
              } else {
                // debugInfo( "Aucun élément invalide visible trouvé pour le défilement."); // Appel debug supprimé
              }
            } else {
              // debugInfo(`Validation étape ${currentStepIndex + 1} réussie.`); // Appel debug supprimé
            }

            return isStepValid;
          }

          // --- FONCTIONS APPELS API ---

          /**
           * Fonction générique pour exécuter des requêtes Fetch vers l'API.
           * @param {string} endpoint - Partie de l'URL après API_BASE_URL (ex. '/offer').
           * @param {object} options - Options de la requête (method, headers, body).
           * @returns {Promise<object | Response>} - Réponse JSON parsée ou objet Response pour types non-JSON (ex. Blob).
           * @throws {object} Objet erreur avec détails (status, message, body)
           */
          async function callApi(endpoint, options = {}) {
            const url = `${API_BASE_URL}${endpoint}`;
            const defaultOptions = {
              method: "GET",
              headers: {
                "Content-Type": "application/json",
              },
            };

            options.headers = {
              ...defaultOptions.headers,
              ...options.headers,
            };

            if (
              options.body &&
              typeof options.body === "object" &&
              options.headers["Content-Type"] === "application/json"
            ) {
              options.body = JSON.stringify(options.body);
            }

            try {
              const response = await fetch(url, options);

              console.log(
                "R&eacute;ponse API re&ccedil;ue (Status:",
                response.status,
                response.statusText,
                ")"
              );

              if (!response.ok) {
                let errorDetails = {
                  status: response.status,
                  message: `Erreur HTTP ! Statut : ${response.status} ${response.statusText}`,
                  body: null,
                };
                try {
                  const clonedResponse = response.clone();
                  const errorBody = await clonedResponse.json();
                  errorDetails.body = errorBody;
                  if (
                    Array.isArray(errorBody.error) &&
                    errorBody.error.length > 0
                  ) {
                    errorDetails.message = `Erreur API : ${errorBody.error
                      .map((e) => e.error)
                      .join(", ")}`;
                  } else if (typeof errorBody === "object") {
                    errorDetails.message = `Erreur API : ${JSON.stringify(
                      errorBody
                    )}`;
                  } else {
                    const textBody = await clonedResponse.text();
                    errorDetails.body = textBody;
                    errorDetails.message = `Erreur API (Non-JSON) : ${textBody.substring(
                      0,
                      200
                    )}`;
                  }
                } catch (parseError) {
                  console.log(
                    `Impossible de parser le corps de la r&eacute;ponse d'erreur API comme JSON/Texte (${response.status}) : ${parseError}`
                  );
                }
                throw errorDetails;
              }
              sessionStorage.removeItem("premio");
              sessionStorage.removeItem("referenceNumber");

              const contentType = response.headers.get("content-type");
              if (contentType && contentType.includes("application/json")) {
                const jsonResponse = await response.json();
                console.log(`R&eacute;ponse Succ&egrave;s API (JSON) :`, jsonResponse);

                return jsonResponse;
              } else {
                return response;
              }
            } catch (error) {
              if (!error.status) {
                console.error(`Erreur r&eacute;seau Fetch API : ${error.message}`);
                throw {
                  status: 0,
                  message: `Erreur r&eacute;seau : ${error.message}`,
                };
              }
              console.error(`Erreur API :`, error); // Log de l'erreur gérée
              throw error;
            }
          }

          /**
           * Appelle l'API pour la soumission de l'application pour l'émission de la police (3.3 Application).
           * @param {string} offerId - ID de l'offre.
           * @param {object} underwritingData - Données pour la section underwriting ({ questions: [], checkbox: [] }).
           * @returns {Promise<object>} - Réponse de l'API avec numéro de police et pointeurs vers les documents.
           * @throws {object} Objet erreur avec détails
           */
          async function callSubmitApplicationAPI(offerId, underwritingData) {
            safeLog(
              `Appel API : Soumettre Application pour ID Offre : ${offerId}`
            );
            const endpoint = "/application";

            const requestBody = {
              id: offerId,
              email: emailConfermaInput.value,
              underwriting: underwritingData,
            };
            // debugInfo("Corps de la requête pour la Soumission Application :", requestBody); // Appel debug supprimé

            return callApi(endpoint, {
              method: "POST",
              body: requestBody,
            });
          }

          /**
           * Appelle l'API pour récupérer le contenu d'un document via son pointeur (4.1 Retrieve document).
           * @param {string} pointer - Identifiant du document (pointeur).
           * @returns {Promise<Blob>} - Contenu du document comme Blob.
           * @throws {object | Error} Objet erreur de callApi ou Error si impossible d'obtenir le Blob.
           */
          async function callRetrieveDocumentAPI(pointer) {
            safeLog(
              `Appel API : R&eacute;cup&eacute;rer Document pour Pointeur : ${pointer}`
            );
            const endpoint = `/document_pointer/${pointer}`;

            try {
              const response = await callApi(endpoint, {
                method: "GET",
                headers: {
                  Accept: "application/pdf, application/octet-stream, */*",
                },
              });

              const fileBlob = await response.blob();
              // debugInfo( `Blob du document reçu (Type : ${fileBlob.type}, Taille : ${fileBlob.size} octets).`); // Appel debug supprimé
              return fileBlob;
            } catch (error) {
              // debugInfo(`Erreur dans callRetrieveDocumentAPI :`, error); // Appel debug supprimé
              throw error;
            }
          }

          // --- FONCTIONS LOGIQUE DES ÉTAPES ---

          /**
           * Tente de charger les données de l'offre depuis sessionStorage.
           * @returns {boolean} True si les données sont trouvées et valides, False sinon.
           */
          function loadOfferDetailsFromSession() {
            offerDetailsFromSession = null;
            toggleElement(sessionErrorDiv, false);

            if (!sessionStorageAvailable) {
              toggleElement(sessionErrorDiv, true);
              sessionErrorDiv.innerHTML =
                "Erreur : La m&eacute;moire locale (sessionStorage) n'est pas disponible. Le processus d'&eacute;mission n&eacute;cessite la m&eacute;moire locale active.";
              return false;
            }

            const savedOfferId = sessionStorage.getItem("reference-number");
            const datiUtenteString = sessionStorage.getItem("datiUtente");

            let datiUtente = null;
            if (datiUtenteString) {
              try {
                datiUtente = JSON.parse(datiUtenteString);
              } catch (e) {
                toggleElement(sessionErrorDiv, true);
                sessionErrorDiv.innerHTML =
                  "Erreur : Les donn&eacute;es de l'offre sauvegard&eacute;es sont corrompues. Veuillez r&eacute;essayer de g&eacute;n&eacute;rer le devis.";
                return false;
              }
            }

            const enteredEmail = emailConfermaInput.value.trim().toLowerCase();

            if (!savedOfferId || !datiUtente || !datiUtente.email) {
              toggleElement(sessionErrorDiv, true);
              sessionErrorDiv.innerHTML =
                "Erreur : Donn&eacute;es de l'offre introuvables en session. Assurez-vous de commencer le processus depuis la page de devis.";
              return false;
            }

            const sessionEmail = datiUtente.email.toLowerCase();
            if (enteredEmail && sessionEmail !== enteredEmail) {
              toggleElement(sessionErrorDiv, true);
              sessionErrorDiv.innerHTML =
                "Erreur : L'email saisi ne correspond pas &agrave; celui associ&eacute; &agrave; l'offre sauvegard&eacute;e en session.";
              return false;
            }

            offerDetailsFromSession = {
              id: savedOfferId,
              offerDetails: datiUtente,
            };

            return true;
          }

          /** Remplit le résumé de l'offre à l'Étape 2 à partir des données de sessionStorage */
          function populateOfferSummary() {
            if (
              !offerDetailsFromSession ||
              !offerDetailsFromSession.offerDetails
            ) {
              riepilogoContent.innerHTML =
                '<p style="color: red;">Erreur interne : Donn&eacute;es de r&eacute;sum&eacute; non disponibles.</p>';
              return;
            }

            try {
              const offerData = offerDetailsFromSession.offerDetails;

              const nomeCompleto = `${offerData.firstname || ""} ${
                offerData.lastname || ""
              }`.trim();
              const durata = offerData.durata;
              const copertura = parseFloat(
                offerData.coverage || 0
              ).toLocaleString("fr-CH");
              const premio = sessionStorage.getItem("premio") || 0;
              const modalita =
                offerData.mode === "annual" ? "Annuelle" : "Mensuelle";

              riepilogoContent.innerHTML = `
                      <h6>R&eacute;sum&eacute; des d&eacute;tails</h6>
                      <div style="display: flex; flex-wrap: wrap; gap: 15px;">
                          <div style="flex: 1; min-width: 200px;">
                              <p><strong>Assur&eacute; :</strong> ${
                                nomeCompleto || "N/D"
                              }</p>
                              <p><strong>Dur&eacute;e :</strong> ${
                                durata || "N/D"
                              } ans</p>
                          </div>
                          <div style="flex: 1; min-width: 200px;">
                              <p><strong>Couverture :</strong> CHF ${
                                copertura || "N/D"
                              }</p>
                              <p><strong>Mode de Paiement :</strong> ${
                                modalita || "N/D"
                              }</p>
                          </div>
                      </div>
                      <div class="lifensure-summary-highlight">
                          <strong>Prime ${modalita} :</strong> CHF ${
                premio || "N/D"
              }
                      </div>
                  `;

              if (condizioniLink) {
                condizioniLink.onclick = (e) => {
                  e.preventDefault();
                  showModal(
                    "Conditions G&eacute;n&eacute;rales d'Assurance",
                    `
                         <p>Texte des conditions g&eacute;n&eacute;rales d'assurance. (Contenu statique &agrave; titre de d&eacute;monstration. R&eacute;f&eacute;rez-vous aux documents officiels t&eacute;l&eacute;chargeables apr&egrave;s l'&eacute;mission de la police.)</p>
                       `
                  );
                };
                condizioniLink.style.cursor = "pointer";
              }

              if (privacyLink) {
                privacyLink.onclick = (e) => {
                  e.preventDefault();
                  showModal(
                    "Politique de Confidentialit&eacute;",
                    `
                         <p>Texte de la politique de confidentialit&eacute;. (Contenu statique &agrave; titre de d&eacute;monstration. R&eacute;f&eacute;rez-vous aux documents officiels t&eacute;l&eacute;chargeables apr&egrave;s l'&eacute;mission de la police.)</p>
                       `
                  );
                };
                privacyLink.style.cursor = "pointer";
              }
            } catch (error) {
              riepilogoContent.innerHTML =
                '<p style="color: red;">Erreur dans le formatage du r&eacute;sum&eacute;.</p>';
            }
          }

          /** Remplit la liste des documents à l'Étape 3 (Complétion) */
          function populatePolicyDocuments() {
            if (
              !applicationResponseData ||
              !applicationResponseData.document_pointers ||
              applicationResponseData.document_pointers.length === 0
            ) {
              documentiPolizzaDiv.innerHTML =
                "<p>Aucun document disponible pour le moment.</p>";
              return;
            }

            let documentsHTML = "";
            applicationResponseData.document_pointers.forEach((doc) => {
              if (doc.pointer) {
                documentsHTML += `
                           <div class="lifensure-document-item">
                               <span>${
                                 doc.description || "Document sans nom"
                               }</span>
                               <button type="button" class="lifensure-document-download-btn lifensure-button outline" data-pointer="${
                                 doc.pointer
                               }" data-description="${
                  doc.description || "Document"
                }">
                                   ? T&eacute;l&eacute;charger <!-- Flèche Bas -->
                               </button>
                           </div>
                       `;
              } else {
                documentsHTML += `
                           <div class="lifensure-document-item">
                               <span>${
                                 doc.description || "Document sans nom"
                               }</span>
                               <span style="color: #6c757d; font-size: 0.9rem;">Non disponible au t&eacute;l&eacute;chargement</span>
                           </div>
                       `;
              }
            });
            documentiPolizzaDiv.innerHTML = documentsHTML;

            document
              .querySelectorAll(".lifensure-document-download-btn")
              .forEach((button) => {
                button.addEventListener("click", function () {
                  const pointer = this.dataset.pointer;
                  const description = this.dataset.description;
                  if (pointer) {
                    handleDocumentDownload(pointer, description);
                  }
                });
              });
          }

          /**
           * Gère le bouton "Afficher Résumé" (Étape 1 -> Étape 2 ou 4).
           * @async
           */
          async function handleStep1Proceed() {
            toggleElement(sessionErrorDiv, false);

            if (!validateCurrentStep()) {
              return;
            }

            const isOfferDataLoaded = loadOfferDetailsFromSession();

            if (!isOfferDataLoaded) {
              return;
            }

            populateOfferSummary();
            goToStep(1);
          }

          /**
           * Gère la soumission de l'application (Étape 2 -> Étape 3 ou 4).
           * @async
           */
          async function handleApplicationSubmission() {
            if (!validateCurrentStep()) {
              return;
            }

            const offerId = offerDetailsFromSession?.id;
            if (!offerId) {
              erroreMessaggioP.textContent =
                "Erreur interne : ID offre non disponible pour la soumission. R&eacute;essayez depuis la premi&egrave;re &eacute;tape.";
              goToStep(3);
              return;
            }

            const underwritingData = {
              questions: [],
              checkbox: [],
            };

            setButtonLoading(procediBtn, true, "Envoi en cours...");

            try {
              applicationResponseData = await callSubmitApplicationAPI(
                offerId,
                underwritingData
              );

              if (applicationResponseData.policy_number) {
                numeroPolizzaSpan.textContent =
                  applicationResponseData.policy_number;
              } else {
                numeroPolizzaSpan.textContent = "-- N/D --";
              }

              populatePolicyDocuments();
              goToStep(2);

              if (sessionStorageAvailable) {
                sessionStorage.removeItem("reference-number");
                sessionStorage.removeItem("datiUtente");
                sessionStorage.removeItem("datiPreventivo");
              }
              console.log("&Eacute;mission r&eacute;ussie :", applicationResponseData);
            } catch (error) {
              console.log("&Eacute;mission &eacute;chou&eacute;e :", error);

              const errorMessage =
                error.message ||
                "Erreur inconnue pendant l'envoi de la demande.";
              if (
                error.body &&
                Array.isArray(error.body.error) &&
                error.body.error.length > 0
              ) {
                erroreMessaggioP.textContent = `Erreur : ${error.body.error[0].error}`;
              } else {
                erroreMessaggioP.textContent = `Une erreur s'est produite lors de la finalisation de la police. D&eacute;tail : ${errorMessage}. Contactez l'assistance.`;
              }

              goToStep(3);
            } finally {
              setButtonLoading(procediBtn, false);
            }
          }

          /**
           * Gère le téléchargement d'un document (Étape 3 Complétion).
           * @param {string} pointer Identifiant du document.
           * @param {string} description Description pour le nom de fichier.
           * @async
           */
          async function handleDocumentDownload(pointer, description) {
            const downloadButton = documentiPolizzaDiv.querySelector(
              `button[data-pointer="${pointer}"]`
            );
            if (!downloadButton) {
              return;
            }

            setButtonLoading(downloadButton, true, "...");

            try {
              const fileBlob = await callRetrieveDocumentAPI(pointer);

              if (fileBlob instanceof Blob) {
                const url = window.URL.createObjectURL(fileBlob);
                const a = document.createElement("a");
                a.style.display = "none";
                a.href = url;
                const cleanedDescription = (description || "Document")
                  .replace(/[^a-z0-9\s_]/gi, "")
                  .trim()
                  .replace(/\s+/g, "_");
                const fileBaseName =
                  cleanedDescription || "document_telecharge";

                let fileExtension = "";
                const mimeParts = fileBlob.type.split("/");
                if (mimeParts.length > 1) {
                  fileExtension = "." + mimeParts.pop();
                }

                a.download = `${fileBaseName}${fileExtension}`;

                document.body.appendChild(a);
                a.click();

                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
              } else {
                throw new Error(
                  "Format de donn&eacute;es inattendu re&ccedil;u pour le document."
                );
              }
            } catch (error) {
              const errorMessage = error.message || "Erreur inconnue.";
              alert(
                `Impossible de t&eacute;l&eacute;charger le document "${description}". D&eacute;tail : ${errorMessage}. R&eacute;essayez ou contactez l'assistance.`
              );
            } finally {
              setButtonLoading(downloadButton, false);
              if (downloadButton.dataset.originalText) {
                downloadButton.innerHTML = downloadButton.dataset.originalText;
                delete downloadButton.dataset.originalText;
              } else {
                downloadButton.innerHTML = "? T&eacute;l&eacute;charger";
              }
            }
          }

          // --- INITIALISATION DU MODULE ---

          async function initializeModule() {
            safeLog("Initialisation module &eacute;mission...");
            checkSessionStorage();

            loadOfferDetailsFromSession();

            if (offerDetailsFromSession) {
              offertaIdInput.value = offerDetailsFromSession.id || "";
              emailConfermaInput.value =
                offerDetailsFromSession.offerDetails?.email || "";
              toggleElement(sessionErrorDiv, false);
            }

            addEventListeners();
            goToStep(0);

            safeLog("Module &eacute;mission initialis&eacute; avec succ&egrave;s.");
          }

          // --- AJOUT EVENT LISTENERS ---

          function addEventListeners() {
            verificaBtn?.addEventListener("click", handleStep1Proceed);

            indietroRiepilogoBtn?.addEventListener("click", () => goToStep(0));

            procediBtn?.addEventListener("click", handleApplicationSubmission);

            riprovaBtn?.addEventListener("click", () => goToStep(0));

            if (condizioniLink) {
              condizioniLink.addEventListener("click", (e) => {
                e.preventDefault();
                showModal(
                  "Conditions G&eacute;n&eacute;rales d'Assurance",
                  `
                         <p>Texte des conditions g&eacute;n&eacute;rales d'assurance. (Contenu statique &agrave; titre de d&eacute;monstration. R&eacute;f&eacute;rez-vous aux documents officiels t&eacute;l&eacute;chargeables apr&egrave;s l'&eacute;mission de la police.)</p>
                       `
                );
              });
            }

            if (privacyLink) {
              privacyLink.addEventListener("click", (e) => {
                e.preventDefault();
                showModal(
                  "Politique de Confidentialit&eacute;",
                  `
                         <p>Texte de la politique de confidentialit&eacute;. (Contenu statique &agrave; titre de d&eacute;monstration. R&eacute;f&eacute;rez-vous aux documents officiels t&eacute;l&eacute;chargeables apr&egrave;s l'&eacute;mission de la police.)</p>
                       `
                );
              });
            }

            modalCloseBtn?.addEventListener("click", closeModal);
            modalConfirmBtn?.addEventListener("click", closeModal);
            overlay?.addEventListener("click", (e) => {
              if (e.target === overlay) closeModal();
            });
          }

          if (document.readyState === "loading") {
            document.addEventListener("DOMContentLoaded", initializeModule);
          } else {
            initializeModule();
          }
        })(); // Fin scope isolé
      </script>
    </div>
    <!-- Fin custom-html-3u -->

    <!-- Scripts JS du thème -->
    <script src="https://r.mobirisesite.com/1342903/assets/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script src="https://r.mobirisesite.com/1342903/assets/smoothscroll/smooth-scroll.js"></script>
    <script src="https://r.mobirisesite.com/1342903/assets/ytplayer/index.js"></script>
    <script src="https://r.mobirisesite.com/1342903/assets/dropdown/js/navbar-dropdown.js"></script>
    <script src="https://r.mobirisesite.com/1342903/assets/theme/js/script.js"></script>

    <!-- Script pour Lazy Loading images (existant) -->
    <script>
      "use strict";
      if ("loading" in HTMLImageElement.prototype) {
        document.querySelectorAll('img[loading="lazy"]').forEach((e) => {
          if (e.dataset.src) e.src = e.dataset.src;
        });
      } else {
        // Fallback lazy loading
      }
    </script>
  </body>
</html>