<!DOCTYPE html>
<html lang="it">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:image:src" content="assets/images/test-api-meta.png" />
    <meta property="og:image" content="assets/images/test-api-meta.png" />
    <meta name="twitter:title" content="Calcola quì il costo della tua polizza vita decesso caso morte" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, minimum-scale=1"
    />
    <link
      rel="shortcut icon"
      href="assets/images/lifeinsure-1-172x172.png"
      type="image/x-icon"
    />
    <meta
      name="description"
      content="Calcolatore premio polizza vita decesso caso morte in Svizzera Ticino"
    />

    <title>
      Calcola quì il costo della tua polizza vita decesso caso morte
    </title>
    <link
      rel="stylesheet"
      href="assets/Material-Design-Icons/css/material.css"
    />
    <link rel="stylesheet" href="assets/icon54/style.css" />
    <link rel="stylesheet" href="assets/bootstrap/css/bootstrap.min.css" />
    <link rel="stylesheet" href="assets/bootstrap/css/bootstrap-grid.min.css" />
    <link
      rel="stylesheet"
      href="assets/bootstrap/css/bootstrap-reboot.min.css"
    />
    <link
      rel="stylesheet"
      href="assets/web/assets/gdpr-plugin/gdpr-styles.css"
    />
    <link rel="stylesheet" href="assets/popup-overlay-plugin/style.css" />
    <link rel="stylesheet" href="assets/dropdown/css/style.css" />
    <link rel="stylesheet" href="assets/socicon/css/styles.css" />
    <link rel="stylesheet" href="assets/theme/css/style.css" />
    <link
      rel="preload"
      href="https://fonts.googleapis.com/css?family=Space+Grotesk:300,400,500,600,700&display=swap"
      as="style"
      onload="this.onload=null;this.rel='stylesheet'"
    />
    <noscript
      ><link
        rel="stylesheet"
        href="https://fonts.googleapis.com/css?family=Space+Grotesk:300,400,500,600,700&display=swap"
    /></noscript>
    <link
      rel="preload"
      as="style"
      href="assets/mobirise/css/mbr-additional.css"
    />
    <link
      rel="stylesheet"
      href="assets/mobirise/css/mbr-additional.css"
      type="text/css"
    />

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        /* Stile per assicurare che il padding non nasconda il contenuto sotto la navbar fissa */
        body {
            padding-top: 70px; /* Regola questo valore se l'altezza della navbar cambia */
        }
        /* Stile opzionale per lo scroll smooth */
        html {
            scroll-behavior: smooth;
        }
    </style>
  </head>
  <body>
    <section
      data-bs-version="5.1"
      class="inspirem5 menu menu1 cid-uE0WswLKWX"
      once="menu"
      id="menu01-33"
    >
      <nav class="navbar navbar-dropdown navbar-fixed-top navbar-expand-lg">
        <div class="container-fluid">
          <div class="navbar-brand">
            <span class="navbar-logo">
              <a href="index.html#top">
                <img
                  src="data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="
                  alt="LifeInsure Logo"
                  style="height: 3.6rem"
                  loading="lazy"
                  class="lazyload"
                  data-src="assets/images/lifeinsure-1-172x172.png"
                />
              </a>
            </span>
          </div>
          <button
            class="navbar-toggler"
            type="button"
            data-toggle="collapse"
            data-bs-toggle="collapse"
            data-target="#navbarSupportedContent"
            data-bs-target="#navbarSupportedContent"
            aria-controls="navbarNavAltMarkup"
            aria-expanded="false"
            aria-label="Toggle navigation"
          >
            <div class="hamburger">
              <span></span>
              <span></span>
              <span></span>
              <span></span>
            </div>
          </button>
          <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav nav-dropdown" data-app-modern-menu="true">
              <li class="nav-item">
                <a
                  class="nav-link link text-primary display-7"
                  href="index.html#header01-2"
                  >Home</a
                >
              </li>
              <li class="nav-item dropdown">
                <a
                  class="nav-link link text-primary dropdown-toggle display-7"
                  href="#"
                  data-toggle="dropdown-submenu"
                  data-bs-toggle="dropdown"
                  data-bs-auto-close="outside"
                  aria-expanded="false"
                  >Polizza decesso</a
                >
                <div class="dropdown-menu" aria-labelledby="dropdown-707">
                  <a
                    class="text-primary dropdown-item display-7"
                    href="index.html#progress-bars02-0"
                    >Vantaggi</a
                  ><a
                    class="text-primary show dropdown-item display-7"
                    href="index.html#progress-bars01-j"
                    >Valore</a
                  ><a
                    class="text-primary show dropdown-item display-7"
                    href="#"
                    data-toggle="modal"
                    data-bs-toggle="modal"
                    data-target="#mbr-popup-2k"
                    data-bs-target="#mbr-popup-2k"
                    ><span
                      class="mdi-content-markunread mbr-iconfont mbr-iconfont-btn"
                    ></span
                    >Una storia vera (leggi)</a
                  ><a
                    class="text-primary show dropdown-item display-7"
                    href="index.html#testimonials04-g"
                    >Testimonianze</a
                  >
                </div>
              </li>
              <li class="nav-item">
                <a
                  class="nav-link link text-primary display-7"
                  href="index.html#forms03-5"
                  >Chi siamo</a
                >
              </li>
              <li class="nav-item">
                <a
                  class="nav-link link text-primary display-7"
                  href="index.html#forms03-5"
                  >Contatti</a
                >
              </li>
              <li class="nav-item dropdown">
                <a
                  class="nav-link link text-primary dropdown-toggle show display-7"
                  href="#"
                  data-toggle="dropdown-submenu"
                  data-bs-toggle="dropdown"
                  data-bs-auto-close="outside"
                  aria-expanded="false"
                  ><span
                    class="icon54-v1-translate2 mbr-iconfont mbr-iconfont-btn"
                  ></span
                ></a>
                <div
                  class="dropdown-menu show"
                  aria-labelledby="dropdown-852"
                  data-bs-popper="none"
                >
                  <a
                    class="text-primary dropdown-item display-7"
                    href="https://de.lifeinsure.ch"
                    target="_blank"
                    >Deutsch</a
                  ><a
                    class="text-primary dropdown-item display-7"
                    href="https://fr.lifeinsure.ch"
                    target="_blank"
                    >Français</a
                  >
                </div>
              </li>
            </ul>

            <div class="navbar-buttons mbr-section-btn">
              <a
                class="btn btn-lg btn-danger display-4"
                href="index.html#features04-2"
                ><span
                  class="icon54-v1-click-1 mbr-iconfont mbr-iconfont-btn"
                ></span
                >PREVENTIVO </a
              >
            </div>
          </div>
        </div>
      </nav>
    </section>

    <section
      data-bs-version="5.1"
      class="inspirem5 header3 cid-uE0WsxjD7A"
      id="header03-34"
    >
      <div class="container">
        <div class="row justify-content-center">
          <div class="col-12 col-lg-11">
            <!-- Contenuto Header -->
          </div>
        </div>
      </div>
    </section>

    <div id="custom-html-36">
      <section class="mbr-section form-section" id="sezione-calcolo-premio">
        <div class="container">
          <div class="row justify-content-center">
            <div class="col-lg-8">
              <div class="card shadow-sm p-4">
                <h2 class="card-title text-center mb-4">
                  Calcola il tuo premio assicurativo
                </h2>

                <form id="form-calcolo-premio" novalidate> <!-- Aggiunto novalidate per gestire validazione via JS -->
                  <div class="form-group mb-3">
                    <label for="data-nascita" class="form-label"
                      >Data di nascita *</label
                    >
                    <input
                      type="date"
                      class="form-control"
                      id="data-nascita"
                      required
                    />
                     <div class="invalid-feedback">Inserisci una data di nascita valida.</div> <!-- Feedback validazione -->
                    <small class="form-text text-muted"
                      >Inserisci la tua data di nascita</small
                    >
                  </div>

                  <div class="form-check mb-3">
                    <input
                      type="checkbox"
                      class="form-check-input"
                      id="fumatore"
                    />
                    <label class="form-check-label" for="fumatore"
                      >Fumatore</label
                    >
                    <small class="d-block form-text text-muted"
                      >Seleziona se sei un fumatore</small
                    >
                  </div>

                  <div class="form-group mb-3">
                    <label for="durata-select" class="form-label" <!-- Cambiato for -->
                      Durata (anni) *</label
                    >
                    <select
                      class="form-select"
                      id="durata-select"
                      required <!-- Aggiunto required al select -->
                      onchange="toggleDurataPersonalizzata()"
                    >
                      <option value="" disabled selected> <!-- Rimosso required da qui -->
                        Seleziona la durata
                      </option>
                      <option value="5">5 anni</option>
                      <option value="10">10 anni</option>
                      <option value="15">15 anni</option>
                      <option value="20">20 anni</option>
                      <option value="25">25 anni</option>
                      <option value="30">30 anni</option>
                      <option value="custom">Scegli tu la durata</option>
                    </select>
                     <div class="invalid-feedback">Seleziona una durata.</div> <!-- Feedback validazione -->
                    <div id="durata-custom-container" class="mt-2 d-none">
                      <div class="input-group">
                        <input
                          type="number"
                          class="form-control"
                          id="durata-custom"
                          min="5"
                          max="30"
                          placeholder="Inserisci durata (5-30 anni)"
                          <!-- Required viene aggiunto/rimosso via JS -->
                        />
                        <span class="input-group-text">anni</span>
                      </div>
                       <div class="invalid-feedback">Inserisci una durata valida tra 5 e 30 anni.</div> <!-- Feedback validazione -->
                    </div>
                    <input type="hidden" id="durata" name="durata" /> <!-- Rimosso required da qui -->
                    <small class="form-text text-muted"
                      >Seleziona la durata della copertura assicurativa</small
                    >
                  </div>

                  <!-- Copertura -->
                  <div class="form-group mb-3">
                    <label for="copertura" class="form-label"
                      >Capitale assicurato (CHF) *</label
                    >
                    <div class="input-group">
                      <input
                        type="number"
                        class="form-control"
                        id="copertura"
                        min="20000"
                        max="600000"
                        step="10000"
                        value="100000"
                        required
                      />
                      <span class="input-group-text">CHF</span>
                    </div>
                     <div class="invalid-feedback">Inserisci un capitale valido (min 20'000, max 600'000).</div> <!-- Feedback validazione -->
                    <small class="form-text text-muted"
                      >Importo della copertura assicurativa (minimo 20.000
                      CHF)</small
                    >
                  </div>

                  <!-- Dati fisici: Altezza e Peso -->
                  <div class="row mb-3">
                    <div class="col-md-6">
                      <div class="form-group">
                        <label for="altezza" class="form-label"
                          >Altezza (cm) *</label
                        >
                        <div class="input-group">
                          <input
                            type="number"
                            class="form-control"
                            id="altezza"
                            min="100"
                            max="250"
                            placeholder="Es. 175"
                            required
                          />
                          <span class="input-group-text">cm</span>
                        </div>
                         <div class="invalid-feedback">Inserisci un'altezza valida (100-250 cm).</div> <!-- Feedback validazione -->
                        <small class="form-text text-muted"
                          >Inserisci la tua altezza</small
                        >
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="form-group">
                        <label for="peso" class="form-label">Peso (kg) *</label>
                        <div class="input-group">
                          <input
                            type="number"
                            class="form-control"
                            id="peso"
                            min="30"
                            max="200"
                            placeholder="Es. 70"
                            required
                          />
                          <span class="input-group-text">kg</span>
                        </div>
                         <div class="invalid-feedback">Inserisci un peso valido (30-200 kg).</div> <!-- Feedback validazione -->
                        <small class="form-text text-muted"
                          >Inserisci il tuo peso</small
                        >
                      </div>
                    </div>
                  </div>

                  <!-- Pulsante Calcola -->
                  <div class="text-center mt-4">
                    <button type="submit" id="calcola-premio-btn" class="btn btn-primary btn-lg px-5">
                      Calcola premio
                    </button>
                  </div>
                </form>

                <!-- Area risultati -->
                <div id="risultato-premio" class="mt-4 p-3 d-none">
                  <!-- I risultati verranno inseriti qui via JavaScript -->
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>
    </div>

    <script src="assets/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script src="assets/smoothscroll/smooth-scroll.js"></script>
    <script src="assets/ytplayer/index.js"></script>
    <script src="assets/dropdown/js/navbar-dropdown.js"></script>
    <script src="assets/theme/js/script.js"></script>

    <!-- Assicurati che questi script esistano e siano corretti -->
    <script src="assets/api/test-connection.js"></script>
    <script src="assets/api/calcola-premio.js"></script>
    <script src="assets/api/check-age.js"></script>

    <script>
      'use strict'; // Abilita strict mode

      function toggleDurataPersonalizzata() {
        const durataSelect = document.getElementById("durata-select");
        const durataCustomContainer = document.getElementById("durata-custom-container");
        const durataCustomInput = document.getElementById("durata-custom");
        const durataHidden = document.getElementById("durata"); // Input nascosto per valore finale

        if (!durataSelect || !durataCustomContainer || !durataCustomInput || !durataHidden) return;

        if (durataSelect.value === "custom") {
          durataCustomContainer.classList.remove("d-none");
          durataCustomInput.required = true; // Rendi obbligatorio l'input custom
          durataCustomInput.focus();
          durataHidden.value = ""; // Pulisci valore nascosto
          durataSelect.required = false; // Il select non è più l'input primario per la durata
        } else {
          durataCustomContainer.classList.add("d-none");
          durataCustomInput.required = false; // Non più obbligatorio
          durataHidden.value = durataSelect.value; // Imposta valore nascosto dal select
          durataSelect.required = true; // Il select torna ad essere obbligatorio
        }
        // Aggiorna lo stato di validità del select (necessario se si cambia da custom a valore)
        durataSelect.dispatchEvent(new Event('change', { bubbles: true }));
      }

      document.addEventListener("DOMContentLoaded", function () {
        const formPremio = document.getElementById("form-calcolo-premio");
        const risultatoPremio = document.getElementById("risultato-premio");
        const dateInput = document.getElementById("data-nascita");
        const calcolaBtn = document.getElementById("calcola-premio-btn"); // Riferimento al pulsante

        // Controllo età (se la funzione checkAge esiste)
        if (typeof checkAge === 'function' && dateInput) {
          checkAge(dateInput);
        } else if (!dateInput) {
            console.warn("Elemento data-nascita non trovato.");
        }

        if (formPremio && risultatoPremio && calcolaBtn) {
          formPremio.addEventListener("submit", async function (e) {
            e.preventDefault(); // Impedisce invio form standard

            // --- Reset stato pulsante e validazione ---
            calcolaBtn.classList.remove('btn-success');
            calcolaBtn.classList.add('btn-primary');
            formPremio.classList.remove('was-validated'); // Rimuovi stato validazione precedente

            // --- Validazione Manuale (più controllo) ---
            let isValid = true;
            formPremio.classList.add('was-validated'); // Applica stile validazione Bootstrap

            // Controlla tutti i campi required visibili
            const requiredFields = formPremio.querySelectorAll('[required]');
            requiredFields.forEach(field => {
                // Controlla se il campo è effettivamente visibile
                if (field.offsetParent !== null) {
                    if (!field.checkValidity()) {
                        isValid = false;
                        // Scroll al primo campo non valido trovato
                        if (isValid === false) { // Solo la prima volta
                            field.focus();
                            field.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                    }
                } else {
                    // Se un campo required è nascosto, potresti voler gestire la logica
                    // console.log(`Campo nascosto ${field.id} ignorato dalla validazione.`);
                }
            });

            // Se la validazione fallisce, interrompi
            if (!isValid) {
                console.log("Validazione fallita.");
                return;
            }

            // --- Mostra caricamento e reset risultato ---
            risultatoPremio.classList.remove("d-none");
            risultatoPremio.innerHTML =
              '<div class="text-center"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Calcolo in corso...</span></div><p class="mt-2">Calcolo del premio in corso...</p></div>';
            // Scroll iniziale all'area di caricamento
            risultatoPremio.scrollIntoView({ behavior: 'smooth', block: 'start' });

            // --- Raccogli dati ---
            const durataSelectValue = document.getElementById("durata-select").value;
            const durataFinal = durataSelectValue === 'custom'
                                ? document.getElementById("durata-custom").value
                                : durataSelectValue;

            let dati = {
              dataNascita: document.getElementById("data-nascita").value,
              fumatore: document.getElementById("fumatore").checked,
              durata: durataFinal, // Usa il valore finale calcolato
              copertura: document.getElementById("copertura").value,
              altezza: document.getElementById("altezza").value || null,
              peso: document.getElementById("peso").value || null,
              // Includi i valori originali del select/custom per eventuale logging o passaggio dati
              durata_select: durataSelectValue,
              durata_custom: durataSelectValue === 'custom' ? document.getElementById("durata-custom").value : null
            };

            try {
              // --- Chiamata API (assicurati che calcolaPremio esista) ---
              if (typeof calcolaPremio !== 'function') {
                  throw new Error("La funzione calcolaPremio non è definita.");
              }
              const risultato = await calcolaPremio(dati);

              // --- Mostra risultato ---
              if (risultato.errore) {
                risultatoPremio.innerHTML = `
                        <div class="alert alert-danger">
                            <h5>Si è verificato un errore</h5>
                            <p>${risultato.errore}</p>
                        </div>`;
                // Non cambiare colore bottone in caso di errore API gestito
              } else if (risultato.premium && risultato.premium.length > 0) {
                const premio = risultato.premium[0].yearly_gross_premium;
                const currency = risultato.currency || "CHF";

                risultatoPremio.innerHTML = `
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <h4 class="card-title">Il tuo preventivo</h4>
                                <p class="card-text">In base ai dati forniti, il premio annuale è:</p>
                                <h2 class="text-primary mb-4">${premio.toLocaleString('it-CH')} ${currency}</h2>
                                <p class="small text-muted mb-3">Copertura: ${parseInt(
                                  dati.copertura
                                ).toLocaleString('it-CH')} ${currency} | Durata: ${dati.durata} anni</p>
                                <button id="btn-richiedi-offerta" class="btn btn-success btn-lg">Richiedi Polizza >></button> <!-- Bottone più grande e verde -->
                            </div>
                        </div>`;

                // *** NUOVO: Cambia colore pulsante Calcola a verde dopo successo ***
                calcolaBtn.classList.remove('btn-primary');
                calcolaBtn.classList.add('btn-success');

                // Memorizza dati per passaggio successivo
                sessionStorage.setItem(
                  "datiPreventivo",
                  JSON.stringify({
                    ...dati, // Passa tutti i dati raccolti
                    premio: premio,
                    currency: currency,
                  })
                );

                // Aggiungi listener al nuovo pulsante "Richiedi Polizza"
                const richiediBtn = document.getElementById("btn-richiedi-offerta");
                if (richiediBtn) {
                    richiediBtn.addEventListener("click", function () {
                        // !!! Assicurati che 'richiesta-offerta.html' sia il nome corretto della pagina successiva !!!
                        window.location.href = "richiesta-offerta.html";
                    });
                } else {
                    console.error("Bottone 'Richiedi Polizza' non trovato dopo la creazione.");
                }

              } else {
                  // Caso di risposta API valida ma senza dati premio attesi
                   risultatoPremio.innerHTML = `
                    <div class="alert alert-warning">
                        <h5>Risultato inatteso</h5>
                        <p>Il calcolo è stato completato ma non è stato restituito un premio valido.</p>
                    </div>`;
              }
            } catch (errore) {
              console.error("Errore durante il calcolo del premio:", errore);
              risultatoPremio.innerHTML = `
                    <div class="alert alert-danger">
                        <h5>Errore di Connessione o Calcolo</h5>
                        <p>Non è stato possibile completare il calcolo. Riprova più tardi o contatta l'assistenza.</p>
                        <p class="small text-muted">Dettaglio: ${errore.message}</p>
                    </div>`;
            } finally {
                 // *** NUOVO: Scroll all'area risultati DOPO che è stata popolata ***
                 // Usiamo un piccolo timeout per assicurarci che il DOM sia aggiornato prima dello scroll
                 setTimeout(() => {
                    risultatoPremio.scrollIntoView({ behavior: 'smooth', block: 'start' });
                 }, 100); // 100ms di ritardo
            }
          });
        } else {
            console.error("Elementi del form (form, risultato, bottone) non trovati.");
        }

        // Inizializza lo stato del select durata all'avvio
        toggleDurataPersonalizzata();

      }); // Fine DOMContentLoaded
    </script>

    <!-- Script Lazy Loading (invariato) -->
    <script>
      "use strict";
      if ("loading" in HTMLImageElement.prototype) {
        document.querySelectorAll('img[loading="lazy"]').forEach((e) => {
          if(e.dataset.src) e.src = e.dataset.src; // Assicurati che dataset.src esista
          if (e.getAttribute("style")) {
            e.setAttribute("data-temp-style", e.getAttribute("style"));
          }
          if (e.getAttribute("data-aspectratio")) {
            e.style.paddingTop = 100 * parseFloat(e.getAttribute("data-aspectratio")) + "%"; // Usa parseFloat
            e.style.height = '0'; // Imposta altezza a 0
          }
          e.onload = function () {
            if (e.getAttribute("data-temp-style")) {
              e.setAttribute("style", e.getAttribute("data-temp-style"));
            } else {
              e.removeAttribute("style");
            }
            e.removeAttribute("data-temp-style");
            // Rimuovi padding-top se non serve più
            if (e.getAttribute("data-aspectratio")) {
                 e.style.paddingTop = '';
                 if(!e.getAttribute("style")) e.removeAttribute("style"); // Rimuovi style se vuoto
            }
          };
        });
      } else {
        const e = document.createElement("script");
        e.src =
          "https://cdnjs.cloudflare.com/ajax/libs/lazysizes/5.1.2/lazysizes.min.js";
        document.body.appendChild(e);
      }
    </script>
  </body>
</html>
